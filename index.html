<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloomly - Your Mental Wellbeing Companion</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Inter:wght@300;400;500;600;700&family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --butterfly-glow: rgba(255, 182, 193, 0.3);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            
            /* Light theme colors */
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --bg-primary: #ffffff;
            --bg-secondary: #f7fafc;
            --border-color: #e2e8f0;
        }

        /* Dark theme CSS variables - High contrast WCAG AAA compliant */
        body.theme-dark {
            --text-primary: #FFFFFF;
            --text-secondary: #F5F5F5;
            --text-muted: #E0E0E0;
            --bg-primary: rgba(30, 41, 59, 0.95);
            --bg-secondary: rgba(15, 23, 42, 0.9);
            --border-color: rgba(255, 255, 255, 0.2);
        }

        body {
            font-family: 'Inter', 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2d3748;
            line-height: 1.6;
            overflow-x: hidden;
            transition: background 0.5s ease;
        }

        /* Butterfly Logo Animation */
        .butterfly-logo {
            font-family: 'Dancing Script', cursive;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            display: inline-block;
            filter: drop-shadow(0 0 10px rgba(102, 126, 234, 0.3));
            animation: butterfly-float 3s ease-in-out infinite;
        }

        @keyframes butterfly-float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
        }

        /* Floating Particles */
        .particle {
            position: fixed;
            pointer-events: none;
            opacity: 0.6;
            z-index: 1;
        }

        .butterfly-particle {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #f093fb, #667eea);
            border-radius: 50% 0;
            transform: rotate(45deg);
            animation: float 15s infinite ease-in-out;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(45deg); opacity: 0.6; }
            25% { transform: translate(100px, -100px) rotate(90deg); opacity: 0.8; }
            50% { transform: translate(-50px, -200px) rotate(135deg); opacity: 0.4; }
            75% { transform: translate(-100px, -100px) rotate(180deg); opacity: 0.7; }
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border-radius: 20px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.2);
        }

        /* Glow Effects */
        .glow-accent {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .glow-soft {
            box-shadow: 0 0 30px rgba(240, 147, 251, 0.2);
        }

        /* Smooth Animations */
        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Breathing Animation */
        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.3); opacity: 1; }
        }

        .breathing-circle {
            animation: breathe 4s ease-in-out infinite;
        }

        .breathing-wave {
            animation: breathe 4s ease-in-out infinite;
            animation-delay: 0.5s;
        }

        /* Header Styles */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1001;
            display: flex;
            align-items: center;
            padding: 0 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        body.theme-dark .app-header {
            background: rgba(30, 41, 59, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hamburger-menu {
            width: 40px;
            height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-right: 1rem;
        }

        .hamburger-menu:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .hamburger-menu span {
            width: 24px;
            height: 3px;
            background: #667eea;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        body.theme-dark .hamburger-menu span {
            background: #FFFFFF;
        }

        .header-logo {
            font-family: 'Dancing Script', cursive;
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 64px;
            left: -280px;
            width: 280px;
            height: calc(100vh - 64px);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            backdrop-filter: blur(20px);
            transition: left 0.3s ease;
            z-index: 1000;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 64px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .sidebar-item {
            transition: all 0.3s ease;
            border-radius: 12px;
            margin: 4px 8px;
        }

        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Main Content */
        .main-content {
            margin-top: 64px;
            min-height: calc(100vh - 64px);
            transition: margin-left 0.3s ease;
        }

        /* Theme Variants - Enhanced Light Theme with High Contrast */
        body.theme-light {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #1A1A1A;
            font-weight: 500;
            line-height: 1.7;
            letter-spacing: 0.01em;
        }

        /* Light theme typography - High contrast, readable colors */
        body.theme-light,
        body.theme-light * {
            color: var(--text-primary-light, #1A1A1A);
        }

        body.theme-light h1,
        body.theme-light h2,
        body.theme-light h3,
        body.theme-light h4,
        body.theme-light h5,
        body.theme-light h6 {
            color: #1A1A1A !important;
            font-weight: 600;
            line-height: 1.4;
            letter-spacing: -0.01em;
        }

        body.theme-light p,
        body.theme-light span,
        body.theme-light div,
        body.theme-light label {
            color: #212121 !important;
            font-weight: 500;
            line-height: 1.7;
        }

        body.theme-light .text-gray-600 {
            color: #4A4A4A !important;
            font-weight: 500;
        }

        body.theme-light .text-gray-500,
        body.theme-light .text-gray-400 {
            color: #6A6A6A !important;
            font-weight: 500;
        }

        body.theme-light .text-gray-700,
        body.theme-light .text-gray-800 {
            color: #1A1A1A !important;
            font-weight: 600;
        }

        /* Small text in light theme - increased letter spacing */
        body.theme-light small,
        body.theme-light .text-sm,
        body.theme-light .text-xs {
            letter-spacing: 0.02em;
            font-weight: 500;
        }

        /* Glass cards in light theme - with text shadow for readability */
        body.theme-light .glass-card {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        body.theme-light .glass-card * {
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        body.theme-light .glass-card h1,
        body.theme-light .glass-card h2,
        body.theme-light .glass-card h3 {
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.9);
        }

        /* Text on gradients - add soft overlay */
        body.theme-light .text-on-gradient {
            position: relative;
        }

        body.theme-light .text-on-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(2px);
            border-radius: inherit;
            z-index: -1;
        }

        /* Hero sections and gradient backgrounds - ensure text readability */
        body.theme-light .bg-gradient-to-r,
        body.theme-light .hero-section {
            position: relative;
        }

        body.theme-light .bg-gradient-to-r::before,
        body.theme-light .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(1px);
            z-index: 0;
        }

        body.theme-light .bg-gradient-to-r > *,
        body.theme-light .hero-section > * {
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Buttons in light theme - enhanced contrast */
        body.theme-light .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: #FFFFFF !important;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        body.theme-light .btn-secondary {
            background: rgba(255, 255, 255, 0.95) !important;
            color: #1A1A1A !important;
            border: 2px solid #4A4A4A !important;
            font-weight: 600;
        }

        body.theme-light .btn-secondary:hover {
            background: #FFFFFF !important;
            color: #1A1A1A !important;
            border-color: #1A1A1A !important;
        }

        /* Inputs and form elements in light theme */
        body.theme-light input,
        body.theme-light textarea,
        body.theme-light select {
            background: rgba(255, 255, 255, 0.95) !important;
            color: #1A1A1A !important;
            border: 1px solid #6A6A6A !important;
            font-weight: 500;
        }

        body.theme-light input::placeholder,
        body.theme-light textarea::placeholder {
            color: #6A6A6A !important;
            opacity: 0.8;
            font-weight: 500;
        }

        body.theme-light input:focus,
        body.theme-light textarea:focus,
        body.theme-light select:focus {
            border-color: #667eea !important;
            outline: 2px solid rgba(102, 126, 234, 0.2) !important;
            background: #FFFFFF !important;
            color: #1A1A1A !important;
        }

        /* Links in light theme */
        body.theme-light a {
            color: #667eea !important;
            font-weight: 500;
        }

        body.theme-light a:hover {
            color: #764ba2 !important;
            text-decoration: underline;
        }

        /* Enhanced Readability Mode - Even higher contrast */
        body.theme-light.enhanced-readability {
            --text-primary-light: #0A0A0A;
        }

        body.theme-light.enhanced-readability h1,
        body.theme-light.enhanced-readability h2,
        body.theme-light.enhanced-readability h3,
        body.theme-light.enhanced-readability h4,
        body.theme-light.enhanced-readability h5,
        body.theme-light.enhanced-readability h6 {
            color: #0A0A0A !important;
            font-weight: 700;
        }

        body.theme-light.enhanced-readability p,
        body.theme-light.enhanced-readability span,
        body.theme-light.enhanced-readability div {
            color: #0F0F0F !important;
            font-weight: 600;
        }

        body.theme-light.enhanced-readability .text-gray-600 {
            color: #2A2A2A !important;
        }

        body.theme-light.enhanced-readability .text-gray-500,
        body.theme-light.enhanced-readability .text-gray-400 {
            color: #3A3A3A !important;
        }

        body.theme-light.enhanced-readability .glass-card {
            background: rgba(255, 255, 255, 0.98) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
        }

        body.theme-light.enhanced-readability .glass-card * {
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.95);
        }

        body.theme-dark {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #FFFFFF !important;
        }

        /* High-contrast text colors for dark theme - WCAG AAA compliant */
        body.theme-dark,
        body.theme-dark * {
            color: var(--text-primary, #FFFFFF);
        }

        body.theme-dark h1,
        body.theme-dark h2,
        body.theme-dark h3,
        body.theme-dark h4,
        body.theme-dark h5,
        body.theme-dark h6 {
            color: #FFFFFF !important;
            font-weight: 600;
        }

        body.theme-dark p,
        body.theme-dark span,
        body.theme-dark div,
        body.theme-dark label {
            color: #F5F5F5 !important;
        }

        body.theme-dark .text-gray-600,
        body.theme-dark .text-gray-500,
        body.theme-dark .text-gray-400 {
            color: #E0E0E0 !important;
        }

        body.theme-dark .text-gray-700,
        body.theme-dark .text-gray-800 {
            color: #F5F5F5 !important;
        }

        /* Glass cards in dark theme */
        body.theme-dark .glass-card {
            background: rgba(30, 41, 59, 0.85) !important;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: #FFFFFF !important;
        }

        body.theme-dark .glass-card * {
            color: #FFFFFF !important;
        }

        body.theme-dark .glass-card .text-gray-600,
        body.theme-dark .glass-card .text-gray-500,
        body.theme-dark .glass-card .text-gray-400 {
            color: #E0E0E0 !important;
        }

        /* Buttons in dark theme */
        body.theme-dark .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: #FFFFFF !important;
            border: none !important;
        }

        body.theme-dark .btn-secondary {
            background: rgba(255, 255, 255, 0.15) !important;
            color: #FFFFFF !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
        }

        body.theme-dark .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.25) !important;
            color: #FFFFFF !important;
        }

        /* Inputs and form elements */
        body.theme-dark input,
        body.theme-dark textarea,
        body.theme-dark select {
            background: rgba(30, 41, 59, 0.8) !important;
            color: #FFFFFF !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        body.theme-dark input::placeholder,
        body.theme-dark textarea::placeholder {
            color: #B0B0B0 !important;
            opacity: 0.8;
        }

        body.theme-dark input:focus,
        body.theme-dark textarea:focus,
        body.theme-dark select:focus {
            border-color: rgba(102, 126, 234, 0.6) !important;
            outline: 2px solid rgba(102, 126, 234, 0.3) !important;
            background: rgba(30, 41, 59, 0.95) !important;
            color: #FFFFFF !important;
        }

        /* Icons in dark theme */
        body.theme-dark i,
        body.theme-dark .fas,
        body.theme-dark .far,
        body.theme-dark .fab {
            color: #FFFFFF !important;
        }

        body.theme-dark .text-gray-400 i,
        body.theme-dark .text-gray-500 i,
        body.theme-dark .text-gray-600 i {
            color: #E0E0E0 !important;
        }

        /* Links */
        body.theme-dark a {
            color: #93C5FD !important;
        }

        body.theme-dark a:hover {
            color: #DBEAFE !important;
        }

        /* Chat messages */
        body.theme-dark .user-message {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            color: #FFFFFF !important;
        }

        body.theme-dark .bot-message {
            background: rgba(30, 41, 59, 0.9) !important;
            color: #FFFFFF !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* Sidebar in dark theme */
        body.theme-dark .sidebar {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.98) 100%) !important;
            border-right: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.theme-dark .sidebar-item {
            color: #FFFFFF !important;
        }

        body.theme-dark .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.15) !important;
        }

        body.theme-dark .sidebar-item.active {
            background: rgba(102, 126, 234, 0.3) !important;
            color: #FFFFFF !important;
        }

        /* Article cards */
        body.theme-dark .article-card {
            background: rgba(30, 41, 59, 0.85) !important;
            color: #FFFFFF !important;
        }

        body.theme-dark .article-card:hover {
            background: rgba(30, 41, 59, 0.95) !important;
        }

        /* Progress badges */
        body.theme-dark .badge {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            color: #FFFFFF !important;
        }

        /* Mood options */
        body.theme-dark .mood-option {
            background: rgba(30, 41, 59, 0.8) !important;
            border: 2px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.theme-dark .mood-option:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        body.theme-dark .mood-option.selected {
            border-color: #667eea !important;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5) !important;
        }

        /* Comment threads */
        body.theme-dark .comment-thread {
            border-left-color: rgba(102, 126, 234, 0.4) !important;
        }

        body.theme-dark .bg-gray-50,
        body.theme-dark .bg-gray-100 {
            background: rgba(30, 41, 59, 0.6) !important;
        }

        body.theme-dark .bg-white {
            background: rgba(30, 41, 59, 0.9) !important;
        }

        /* Hero section in dark theme */
        body.theme-dark .bg-gradient-to-r {
            background: linear-gradient(to right, #1e293b, #334155, #475569) !important;
        }

        /* Sound visualizer bars */
        body.theme-dark .sound-bar {
            background: linear-gradient(180deg, #93C5FD, #DBEAFE) !important;
        }

        /* Butterfly logo in dark theme - ensure visibility */
        body.theme-dark .butterfly-logo {
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.3)) drop-shadow(0 0 10px rgba(102, 126, 234, 0.5));
        }

        /* Ensure all text in dark mode meets WCAG AAA (7:1 contrast ratio) */
        body.theme-dark,
        body.theme-dark *:not(.butterfly-logo):not(.particle) {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Night mode enhancements */
        body.theme-dark.night-mode {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%) !important;
            color: #F5F5F5 !important;
        }

        body.theme-dark.night-mode * {
            color: #F5F5F5 !important;
        }

        /* Additional dark theme contrast rules for specific components */
        body.theme-dark .prose,
        body.theme-dark .prose * {
            color: #F5F5F5 !important;
        }

        body.theme-dark .prose h1,
        body.theme-dark .prose h2,
        body.theme-dark .prose h3 {
            color: #FFFFFF !important;
        }

        /* Settings modal in dark theme */
        body.theme-dark .glass-card h2,
        body.theme-dark .glass-card h3,
        body.theme-dark .glass-card h4 {
            color: #FFFFFF !important;
        }

        /* Dropdowns and selects */
        body.theme-dark select option {
            background: #1e293b !important;
            color: #FFFFFF !important;
        }

        /* Checkboxes and radio buttons */
        body.theme-dark input[type="checkbox"],
        body.theme-dark input[type="radio"] {
            accent-color: #667eea;
            filter: brightness(1.2);
        }

        /* Scrollbar in dark theme */
        body.theme-dark ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3) !important;
        }

        body.theme-dark ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2) !important;
        }

        /* Borders and dividers */
        body.theme-dark hr,
        body.theme-dark .border-t,
        body.theme-dark .border-b {
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        /* Code blocks and pre elements */
        body.theme-dark code,
        body.theme-dark pre {
            background: rgba(15, 23, 42, 0.8) !important;
            color: #FFFFFF !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* Tables */
        body.theme-dark table,
        body.theme-dark th,
        body.theme-dark td {
            border-color: rgba(255, 255, 255, 0.2) !important;
            color: #FFFFFF !important;
        }

        body.theme-dark th {
            background: rgba(30, 41, 59, 0.6) !important;
        }

        /* Tooltips */
        body.theme-dark .tooltip,
        body.theme-dark [title] {
            color: #FFFFFF !important;
        }

        /* Ensure all interactive elements are visible */
        body.theme-dark button:not(.btn-primary):not(.btn-secondary) {
            color: #FFFFFF !important;
        }

        body.theme-dark button:disabled {
            color: #9CA3AF !important;
            opacity: 0.6;
        }

        /* Loading states */
        body.theme-dark .loading,
        body.theme-dark .animate-pulse {
            opacity: 0.8;
        }

        /* Ensure placeholder text is visible */
        body.theme-dark ::placeholder {
            color: #B0B0B0 !important;
            opacity: 0.8 !important;
        }

        /* Focus states for accessibility */
        body.theme-dark *:focus-visible {
            outline: 2px solid #93C5FD !important;
            outline-offset: 2px !important;
        }

        /* Ensure all icons have proper contrast */
        body.theme-dark svg,
        body.theme-dark svg * {
            fill: #FFFFFF !important;
            stroke: #FFFFFF !important;
        }

        body.theme-dark svg[fill="currentColor"] {
            fill: #FFFFFF !important;
        }

        /* Emoji and special characters maintain visibility */
        body.theme-dark .emoji,
        body.theme-dark [role="img"] {
            filter: brightness(1.1);
        }

        /* ========== NATURE THEME - Enhanced Visibility ========== */
        body.theme-nature {
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc8 100%);
            color: #1a3d0f !important;
            font-weight: 500;
        }

        body.theme-nature,
        body.theme-nature * {
            color: var(--text-nature, #1a3d0f);
        }

        body.theme-nature h1,
        body.theme-nature h2,
        body.theme-nature h3,
        body.theme-nature h4,
        body.theme-nature h5,
        body.theme-nature h6 {
            color: #0f2a08 !important;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        body.theme-nature p,
        body.theme-nature span,
        body.theme-nature div,
        body.theme-nature label {
            color: #1a3d0f !important;
            font-weight: 500;
        }

        body.theme-nature .text-gray-600 {
            color: #2d5016 !important;
            font-weight: 500;
        }

        body.theme-nature .text-gray-500,
        body.theme-nature .text-gray-400 {
            color: #3d6b1f !important;
            font-weight: 500;
        }

        body.theme-nature .text-gray-700,
        body.theme-nature .text-gray-800 {
            color: #0f2a08 !important;
            font-weight: 600;
        }

        /* Nature theme - Glass cards */
        body.theme-nature .glass-card {
            background: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(26, 61, 15, 0.2) !important;
            box-shadow: 0 8px 32px 0 rgba(15, 42, 8, 0.15);
        }

        body.theme-nature .glass-card * {
            color: #1a3d0f !important;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.6);
        }

        body.theme-nature .glass-card h1,
        body.theme-nature .glass-card h2,
        body.theme-nature .glass-card h3 {
            color: #0f2a08 !important;
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.7);
        }

        /* Nature theme - Buttons */
        body.theme-nature .btn-primary {
            background: linear-gradient(135deg, #2d5016 0%, #1a3d0f 100%) !important;
            color: #FFFFFF !important;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            border: 1px solid #0f2a08 !important;
        }

        body.theme-nature .btn-secondary {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #1a3d0f !important;
            border: 2px solid #2d5016 !important;
            font-weight: 600;
        }

        body.theme-nature .btn-secondary:hover {
            background: #FFFFFF !important;
            color: #0f2a08 !important;
            border-color: #0f2a08 !important;
        }

        /* Nature theme - Inputs */
        body.theme-nature input,
        body.theme-nature textarea,
        body.theme-nature select {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #1a3d0f !important;
            border: 1px solid #3d6b1f !important;
            font-weight: 500;
        }

        body.theme-nature input::placeholder,
        body.theme-nature textarea::placeholder {
            color: #3d6b1f !important;
            opacity: 0.7;
        }

        body.theme-nature input:focus,
        body.theme-nature textarea:focus,
        body.theme-nature select:focus {
            border-color: #2d5016 !important;
            outline: 2px solid rgba(45, 80, 22, 0.3) !important;
            background: #FFFFFF !important;
        }

        /* Nature theme - Links */
        body.theme-nature a {
            color: #1a5c2e !important;
            font-weight: 600;
        }

        body.theme-nature a:hover {
            color: #0f2a08 !important;
            text-decoration: underline;
        }

        /* Nature theme - Icons */
        body.theme-nature i:not(.text-white):not(.btn-primary i) {
            color: #1a3d0f !important;
        }

        /* Nature theme - Borders and dividers */
        body.theme-nature hr,
        body.theme-nature .border-t,
        body.theme-nature .border-b {
            border-color: rgba(45, 80, 22, 0.3) !important;
        }

        /* Nature theme - Chat messages */
        body.theme-nature .bot-message {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #1a3d0f !important;
            border: 1px solid rgba(45, 80, 22, 0.2) !important;
        }

        body.theme-nature .user-message {
            background: linear-gradient(135deg, #2d5016, #1a3d0f) !important;
            color: #FFFFFF !important;
        }

        /* ========== LAVENDER THEME - Enhanced Visibility ========== */
        body.theme-lavender {
            background: linear-gradient(135deg, #e1bee7 0%, #f8bbd0 100%);
            color: #4a148c !important;
            font-weight: 500;
        }

        body.theme-lavender,
        body.theme-lavender * {
            color: var(--text-lavender, #4a148c);
        }

        body.theme-lavender h1,
        body.theme-lavender h2,
        body.theme-lavender h3,
        body.theme-lavender h4,
        body.theme-lavender h5,
        body.theme-lavender h6 {
            color: #380d63 !important;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.6);
        }

        body.theme-lavender p,
        body.theme-lavender span,
        body.theme-lavender div,
        body.theme-lavender label {
            color: #4a148c !important;
            font-weight: 500;
        }

        body.theme-lavender .text-gray-600 {
            color: #6a1b9a !important;
            font-weight: 500;
        }

        body.theme-lavender .text-gray-500,
        body.theme-lavender .text-gray-400 {
            color: #7b1fa2 !important;
            font-weight: 500;
        }

        body.theme-lavender .text-gray-700,
        body.theme-lavender .text-gray-800 {
            color: #380d63 !important;
            font-weight: 600;
        }

        /* Lavender theme - Glass cards */
        body.theme-lavender .glass-card {
            background: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(74, 20, 140, 0.25) !important;
            box-shadow: 0 8px 32px 0 rgba(74, 20, 140, 0.15);
        }

        body.theme-lavender .glass-card * {
            color: #4a148c !important;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.7);
        }

        body.theme-lavender .glass-card h1,
        body.theme-lavender .glass-card h2,
        body.theme-lavender .glass-card h3 {
            color: #380d63 !important;
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.8);
        }

        /* Lavender theme - Buttons */
        body.theme-lavender .btn-primary {
            background: linear-gradient(135deg, #7b1fa2 0%, #4a148c 100%) !important;
            color: #FFFFFF !important;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            border: 1px solid #380d63 !important;
        }

        body.theme-lavender .btn-secondary {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #4a148c !important;
            border: 2px solid #7b1fa2 !important;
            font-weight: 600;
        }

        body.theme-lavender .btn-secondary:hover {
            background: #FFFFFF !important;
            color: #380d63 !important;
            border-color: #380d63 !important;
        }

        /* Lavender theme - Inputs */
        body.theme-lavender input,
        body.theme-lavender textarea,
        body.theme-lavender select {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #4a148c !important;
            border: 1px solid #7b1fa2 !important;
            font-weight: 500;
        }

        body.theme-lavender input::placeholder,
        body.theme-lavender textarea::placeholder {
            color: #7b1fa2 !important;
            opacity: 0.7;
        }

        body.theme-lavender input:focus,
        body.theme-lavender textarea:focus,
        body.theme-lavender select:focus {
            border-color: #4a148c !important;
            outline: 2px solid rgba(74, 20, 140, 0.3) !important;
            background: #FFFFFF !important;
        }

        /* Lavender theme - Links */
        body.theme-lavender a {
            color: #6a1b9a !important;
            font-weight: 600;
        }

        body.theme-lavender a:hover {
            color: #380d63 !important;
            text-decoration: underline;
        }

        /* Lavender theme - Icons */
        body.theme-lavender i:not(.text-white):not(.btn-primary i) {
            color: #4a148c !important;
        }

        /* Lavender theme - Borders */
        body.theme-lavender hr,
        body.theme-lavender .border-t,
        body.theme-lavender .border-b {
            border-color: rgba(74, 20, 140, 0.3) !important;
        }

        /* Lavender theme - Chat messages */
        body.theme-lavender .bot-message {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #4a148c !important;
            border: 1px solid rgba(74, 20, 140, 0.2) !important;
        }

        body.theme-lavender .user-message {
            background: linear-gradient(135deg, #7b1fa2, #4a148c) !important;
            color: #FFFFFF !important;
        }

        /* ========== OCEAN THEME - Enhanced Visibility ========== */
        body.theme-ocean {
            background: linear-gradient(135deg, #81d4fa 0%, #4fc3f7 100%);
            color: #01579b !important;
            font-weight: 500;
        }

        body.theme-ocean,
        body.theme-ocean * {
            color: var(--text-ocean, #01579b);
        }

        body.theme-ocean h1,
        body.theme-ocean h2,
        body.theme-ocean h3,
        body.theme-ocean h4,
        body.theme-ocean h5,
        body.theme-ocean h6 {
            color: #003d6b !important;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.6);
        }

        body.theme-ocean p,
        body.theme-ocean span,
        body.theme-ocean div,
        body.theme-ocean label {
            color: #01579b !important;
            font-weight: 500;
        }

        body.theme-ocean .text-gray-600 {
            color: #0277bd !important;
            font-weight: 500;
        }

        body.theme-ocean .text-gray-500,
        body.theme-ocean .text-gray-400 {
            color: #0288d1 !important;
            font-weight: 500;
        }

        body.theme-ocean .text-gray-700,
        body.theme-ocean .text-gray-800 {
            color: #003d6b !important;
            font-weight: 600;
        }

        /* Ocean theme - Glass cards */
        body.theme-ocean .glass-card {
            background: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(1, 87, 155, 0.25) !important;
            box-shadow: 0 8px 32px 0 rgba(1, 87, 155, 0.15);
        }

        body.theme-ocean .glass-card * {
            color: #01579b !important;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.7);
        }

        body.theme-ocean .glass-card h1,
        body.theme-ocean .glass-card h2,
        body.theme-ocean .glass-card h3 {
            color: #003d6b !important;
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.8);
        }

        /* Ocean theme - Buttons */
        body.theme-ocean .btn-primary {
            background: linear-gradient(135deg, #0277bd 0%, #01579b 100%) !important;
            color: #FFFFFF !important;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            border: 1px solid #003d6b !important;
        }

        body.theme-ocean .btn-secondary {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #01579b !important;
            border: 2px solid #0277bd !important;
            font-weight: 600;
        }

        body.theme-ocean .btn-secondary:hover {
            background: #FFFFFF !important;
            color: #003d6b !important;
            border-color: #003d6b !important;
        }

        /* Ocean theme - Inputs */
        body.theme-ocean input,
        body.theme-ocean textarea,
        body.theme-ocean select {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #01579b !important;
            border: 1px solid #0288d1 !important;
            font-weight: 500;
        }

        body.theme-ocean input::placeholder,
        body.theme-ocean textarea::placeholder {
            color: #0288d1 !important;
            opacity: 0.7;
        }

        body.theme-ocean input:focus,
        body.theme-ocean textarea:focus,
        body.theme-ocean select:focus {
            border-color: #01579b !important;
            outline: 2px solid rgba(1, 87, 155, 0.3) !important;
            background: #FFFFFF !important;
        }

        /* Ocean theme - Links */
        body.theme-ocean a {
            color: #0277bd !important;
            font-weight: 600;
        }

        body.theme-ocean a:hover {
            color: #003d6b !important;
            text-decoration: underline;
        }

        /* Ocean theme - Icons */
        body.theme-ocean i:not(.text-white):not(.btn-primary i) {
            color: #01579b !important;
        }

        /* Ocean theme - Borders */
        body.theme-ocean hr,
        body.theme-ocean .border-t,
        body.theme-ocean .border-b {
            border-color: rgba(1, 87, 155, 0.3) !important;
        }

        /* Ocean theme - Chat messages */
        body.theme-ocean .bot-message {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #01579b !important;
            border: 1px solid rgba(1, 87, 155, 0.2) !important;
        }

        body.theme-ocean .user-message {
            background: linear-gradient(135deg, #0277bd, #01579b) !important;
            color: #FFFFFF !important;
        }

        /* Shared theme improvements - Article cards, badges, etc. */
        body.theme-nature .article-card,
        body.theme-lavender .article-card,
        body.theme-ocean .article-card {
            background: rgba(255, 255, 255, 0.9) !important;
        }

        body.theme-nature .article-card *,
        body.theme-lavender .article-card *,
        body.theme-ocean .article-card * {
            color: inherit !important;
        }

        /* Sidebar in themed modes - maintain white text on gradient */
        body.theme-nature .sidebar,
        body.theme-lavender .sidebar,
        body.theme-ocean .sidebar {
            color: #FFFFFF !important;
        }

        body.theme-nature .sidebar-item,
        body.theme-lavender .sidebar-item,
        body.theme-ocean .sidebar-item {
            color: #FFFFFF !important;
        }

        /* Progress badges */
        body.theme-nature .badge {
            background: linear-gradient(135deg, #2d5016, #1a3d0f) !important;
            color: #FFFFFF !important;
        }

        body.theme-lavender .badge {
            background: linear-gradient(135deg, #7b1fa2, #4a148c) !important;
            color: #FFFFFF !important;
        }

        body.theme-ocean .badge {
            background: linear-gradient(135deg, #0277bd, #01579b) !important;
            color: #FFFFFF !important;
        }

        /* Comment threads */
        body.theme-nature .comment-thread {
            border-left-color: rgba(45, 80, 22, 0.4) !important;
        }

        body.theme-lavender .comment-thread {
            border-left-color: rgba(74, 20, 140, 0.4) !important;
        }

        body.theme-ocean .comment-thread {
            border-left-color: rgba(1, 87, 155, 0.4) !important;
        }

        /* Disabled states for all themes */
        body.theme-nature button:disabled,
        body.theme-lavender button:disabled,
        body.theme-ocean button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            color: #6A6A6A !important;
        }

        /* Focus states for accessibility */
        body.theme-nature *:focus-visible {
            outline: 2px solid #2d5016 !important;
            outline-offset: 2px !important;
        }

        body.theme-lavender *:focus-visible {
            outline: 2px solid #7b1fa2 !important;
            outline-offset: 2px !important;
        }

        body.theme-ocean *:focus-visible {
            outline: 2px solid #0277bd !important;
            outline-offset: 2px !important;
        }

        /* Hero sections with gradient overlays for better text visibility */
        body.theme-nature .hero-section::before,
        body.theme-lavender .hero-section::before,
        body.theme-ocean .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(1px);
            z-index: 0;
        }

        body.theme-nature .hero-section > *,
        body.theme-lavender .hero-section > *,
        body.theme-ocean .hero-section > * {
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Night Mode */
        body.night-mode {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #cbd5e1;
            filter: brightness(0.8);
        }

        body.night-mode * {
            animation-duration: 2s !important;
        }

        /* Safe Space Room */
        .safe-space {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            overflow: hidden;
        }

        .safe-space.starlit {
            background: linear-gradient(180deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%);
        }

        /* Starlit theme text visibility */
        .safe-space.starlit h1,
        .safe-space.starlit h2,
        .safe-space.starlit h3,
        .safe-space.starlit p,
        .safe-space.starlit span,
        .safe-space.starlit button,
        .safe-space.starlit label {
            color: #FFFFFF !important;
            text-shadow: 0 2px 8px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3) !important;
            font-weight: 600 !important;
        }

        .safe-space.starlit button {
            background: rgba(255, 255, 255, 0.25) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
        }

        .safe-space.starlit button:hover {
            background: rgba(255, 255, 255, 0.35) !important;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3) !important;
        }

        .safe-space.forest {
            background: linear-gradient(180deg, #1a4d2e 0%, #2d5a3d 50%, #3d6b4f 100%);
        }

        .safe-space.ocean {
            background: linear-gradient(180deg, #0a2463 0%, #1e3a8a 50%, #3b82f6 100%);
        }

        .safe-space.lavender {
            background: linear-gradient(180deg, #6b46c1 0%, #8b5cf6 50%, #a78bfa 100%);
        }

        .safe-space.clouds {
            background: linear-gradient(180deg, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%);
        }

        /* Sound Visualizer */
        .sound-visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 60px;
        }

        .sound-bar {
            width: 4px;
            background: linear-gradient(180deg, #667eea, #764ba2);
            border-radius: 2px;
            animation: sound-wave 1s ease-in-out infinite;
        }

        @keyframes sound-wave {
            0%, 100% { height: 10px; }
            50% { height: 40px; }
        }

        .sound-bar:nth-child(2) { animation-delay: 0.1s; }
        .sound-bar:nth-child(3) { animation-delay: 0.2s; }
        .sound-bar:nth-child(4) { animation-delay: 0.3s; }
        .sound-bar:nth-child(5) { animation-delay: 0.4s; }

        /* Progress Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            animation: badge-glow 2s ease-in-out infinite;
        }

        @keyframes badge-glow {
            0%, 100% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
            50% { box-shadow: 0 4px 25px rgba(102, 126, 234, 0.6); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                left: -280px;
            }
            .sidebar.open {
                left: 0;
            }
            .main-content {
                margin-left: 0;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
        }

        /* Loading Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 2s ease-in-out infinite;
        }

        /* Chat Message Styles */
        .chat-message {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 12px;
            word-wrap: break-word;
            animation: message-slide 0.3s ease-out;
        }

        @keyframes message-slide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            background: rgba(255, 255, 255, 0.9);
            color: #2d3748;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Light theme bot message - enhanced contrast */
        body.theme-light .bot-message {
            background: rgba(255, 255, 255, 0.95) !important;
            color: #1A1A1A !important;
            font-weight: 500;
        }

        body.theme-light.enhanced-readability .bot-message {
            background: rgba(255, 255, 255, 0.98) !important;
            color: #0A0A0A !important;
            font-weight: 600;
        }

        /* Shared typography improvements for both themes */
        body {
            font-weight: 500;
            line-height: 1.7;
            letter-spacing: 0.01em;
        }

        body h1, body h2, body h3, body h4, body h5, body h6 {
            line-height: 1.4;
            letter-spacing: -0.01em;
        }

        body small, body .text-sm, body .text-xs {
            letter-spacing: 0.02em;
        }

        /* Ensure consistent spacing in both themes */
        body p {
            margin-bottom: 1em;
            line-height: 1.7;
        }

        /* Sidebar text in light theme */
        body.theme-light .sidebar {
            color: #FFFFFF;
        }

        body.theme-light .sidebar-item {
            color: #FFFFFF !important;
            font-weight: 500;
        }

        /* Article cards in light theme */
        body.theme-light .article-card {
            background: rgba(255, 255, 255, 0.95) !important;
            color: #1A1A1A !important;
        }

        body.theme-light .article-card * {
            color: #1A1A1A !important;
        }

        body.theme-light .article-card .text-gray-600 {
            color: #4A4A4A !important;
        }

        /* Progress badges in light theme */
        body.theme-light .badge {
            color: #FFFFFF !important;
        }

        /* Comment threads in light theme */
        body.theme-light .comment-thread {
            border-left-color: rgba(102, 126, 234, 0.3) !important;
        }

        /* Ensure icons are visible in light theme */
        body.theme-light i:not(.text-white):not(.text-purple-600) {
            color: #4A4A4A !important;
        }

        /* Settings modal in light theme */
        body.theme-light .glass-card h2,
        body.theme-light .glass-card h3 {
            color: #1A1A1A !important;
        }

        /* Ensure all interactive elements maintain contrast */
        body.theme-light button:not(.btn-primary):not(.btn-secondary):not(.text-white) {
            color: #1A1A1A !important;
            font-weight: 500;
        }

        /* Focus states for accessibility in light theme */
        body.theme-light *:focus-visible {
            outline: 2px solid #667eea !important;
            outline-offset: 2px !important;
        }

        /* Ensure placeholder text is visible in light theme */
        body.theme-light ::placeholder {
            color: #6A6A6A !important;
            opacity: 0.8 !important;
        }

        /* Additional text visibility fixes for dark mode */
        body.theme-dark .text-gray-700,
        body.theme-dark .text-gray-800,
        body.theme-dark .text-gray-900 {
            color: #F5F5F5 !important;
        }

        body.theme-dark .text-gray-500,
        body.theme-dark .text-gray-600 {
            color: #E0E0E0 !important;
        }

        body.theme-dark .text-gray-400 {
            color: #D0D0D0 !important;
        }

        /* Ensure all text in cards is visible in dark mode */
        body.theme-dark .glass-card,
        body.theme-dark .glass-card * {
            color: #FFFFFF !important;
        }

        body.theme-dark .glass-card .text-gray-600,
        body.theme-dark .glass-card .text-gray-500 {
            color: #E0E0E0 !important;
        }

        /* Light mode text visibility fixes */
        body.theme-light .text-white {
            color: #1A1A1A !important;
        }

        body.theme-light .glass-card {
            background: rgba(255, 255, 255, 0.95) !important;
        }

        body.theme-light .glass-card * {
            color: #1A1A1A !important;
        }

        body.theme-light .glass-card .text-gray-600 {
            color: #4A4A4A !important;
        }

        /* Input and form text visibility */
        body.theme-dark input,
        body.theme-dark textarea,
        body.theme-dark select {
            color: #FFFFFF !important;
            background: rgba(30, 41, 59, 0.8) !important;
        }

        body.theme-light input,
        body.theme-light textarea,
        body.theme-light select {
            color: #1A1A1A !important;
            background: rgba(255, 255, 255, 0.95) !important;
        }

        /* Button text visibility */
        body.theme-dark button:not(.btn-primary):not(.btn-secondary) {
            color: #FFFFFF !important;
        }

        body.theme-light button:not(.btn-primary):not(.btn-secondary) {
            color: #1A1A1A !important;
        }

        /* Link visibility */
        body.theme-dark a:not(.btn-primary):not(.btn-secondary) {
            color: #93C5FD !important;
        }

        body.theme-light a:not(.btn-primary):not(.btn-secondary) {
            color: #667eea !important;
        }

        /* Chat message text */
        body.theme-dark .user-message,
        body.theme-dark .bot-message {
            color: #FFFFFF !important;
        }

        body.theme-light .user-message {
            color: #FFFFFF !important;
        }

        body.theme-light .bot-message {
            color: #1A1A1A !important;
            background: rgba(255, 255, 255, 0.95) !important;
        }

        /* Journal entry text */
        body.theme-dark .journal-entry,
        body.theme-dark .journal-entry * {
            color: #FFFFFF !important;
        }

        body.theme-light .journal-entry,
        body.theme-light .journal-entry * {
            color: #1A1A1A !important;
        }

        /* Article text */
        body.theme-dark .article-card,
        body.theme-dark .article-card * {
            color: #FFFFFF !important;
        }

        body.theme-light .article-card,
        body.theme-light .article-card * {
            color: #1A1A1A !important;
        }

        /* Mood tracking text */
        body.theme-dark .mood-selector,
        body.theme-dark .mood-selector * {
            color: #FFFFFF !important;
        }

        body.theme-light .mood-selector,
        body.theme-light .mood-selector * {
            color: #1A1A1A !important;
        }

        /* Progress page text */
        body.theme-dark .progress-stat,
        body.theme-dark .progress-stat * {
            color: #FFFFFF !important;
        }

        body.theme-light .progress-stat,
        body.theme-light .progress-stat * {
            color: #1A1A1A !important;
        }

        /* Modal and dialog text */
        body.theme-dark .modal,
        body.theme-dark .modal * {
            color: #FFFFFF !important;
        }

        body.theme-light .modal,
        body.theme-light .modal * {
            color: #1A1A1A !important;
        }

        /* Settings text */
        body.theme-dark .settings-item,
        body.theme-dark .settings-item * {
            color: #FFFFFF !important;
        }

        body.theme-light .settings-item,
        body.theme-light .settings-item * {
            color: #1A1A1A !important;
        }

        /* Mood Selector */
        .mood-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .mood-option:hover {
            transform: scale(1.1);
        }

        .mood-option.selected {
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        /* Article Card */
        .article-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        /* ========== UNIVERSAL SEARCH BAR COMPONENT ========== */
        .universal-search-bar {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto 2rem;
        }

        .universal-search-bar input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            background: rgba(255, 255, 255, 0.95) !important;
            border: 2px solid rgba(102, 126, 234, 0.2) !important;
            border-radius: 25px !important;
            font-size: 16px;
            color: #1A1A1A !important;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .universal-search-bar input:focus {
            outline: none;
            border-color: #667eea !important;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            background: #FFFFFF !important;
        }

        .universal-search-bar input::placeholder {
            color: #6A6A6A !important;
            opacity: 0.8 !important;
            font-weight: 400;
        }

        .universal-search-bar .search-icon {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 18px;
            pointer-events: none;
        }

        /* Dark mode search bar */
        body.theme-dark .universal-search-bar input {
            background: rgba(255, 255, 255, 0.95) !important;
            color: #1A1A1A !important;
            border-color: rgba(102, 126, 234, 0.3) !important;
        }

        body.theme-dark .universal-search-bar input:focus {
            background: #FFFFFF !important;
            border-color: #667eea !important;
        }

        /* ========== GLOBAL DESIGN SYSTEM ========== */
        /* Bloomly Color Palette */
        :root {
            --bloomly-primary: #667eea;
            --bloomly-secondary: #764ba2;
            --bloomly-accent: #f093fb;
            --bloomly-success: #10b981;
            --bloomly-warning: #f59e0b;
            --bloomly-error: #ef4444;
            --bloomly-bg-light: #f8fafc;
            --bloomly-bg-dark: #1e293b;
            --bloomly-text-light: #1a1a1a;
            --bloomly-text-dark: #ffffff;
        }

        /* Typography System */
        .bloomly-h1 {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.2;
            letter-spacing: -0.02em;
            color: var(--bloomly-text-light);
        }

        .bloomly-h2 {
            font-size: 2rem;
            font-weight: 600;
            line-height: 1.3;
            letter-spacing: -0.01em;
        }

        .bloomly-h3 {
            font-size: 1.5rem;
            font-weight: 600;
            line-height: 1.4;
        }

        .bloomly-body {
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.7;
            color: var(--bloomly-text-light);
        }

        .bloomly-caption {
            font-size: 0.875rem;
            font-weight: 400;
            line-height: 1.5;
            color: #6a6a6a;
        }

        body.theme-dark .bloomly-h1,
        body.theme-dark .bloomly-h2,
        body.theme-dark .bloomly-h3,
        body.theme-dark .bloomly-body {
            color: var(--bloomly-text-dark);
        }

        /* Button Components */
        .bloomly-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .bloomly-btn-primary {
            background: linear-gradient(135deg, var(--bloomly-primary), var(--bloomly-secondary));
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .bloomly-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .bloomly-btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: var(--bloomly-primary);
            border: 2px solid var(--bloomly-primary);
        }

        .bloomly-btn-secondary:hover {
            background: var(--bloomly-primary);
            color: white;
        }

        /* Card Components */
        .bloomly-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .bloomly-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        body.theme-dark .bloomly-card {
            background: rgba(30, 41, 59, 0.9);
            color: white;
        }

        /* Input Fields */
        .bloomly-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.95);
            color: #1a1a1a;
            transition: all 0.3s ease;
        }

        .bloomly-input:focus {
            outline: none;
            border-color: var(--bloomly-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Spacing System */
        .bloomly-spacing-xs { margin: 0.5rem; }
        .bloomly-spacing-sm { margin: 1rem; }
        .bloomly-spacing-md { margin: 1.5rem; }
        .bloomly-spacing-lg { margin: 2rem; }
        .bloomly-spacing-xl { margin: 3rem; }

        /* Mobile Bottom Navigation */
        @media (max-width: 768px) {
            .mobile-bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                border-top: 1px solid rgba(0, 0, 0, 0.1);
                padding: 8px 0;
                z-index: 1000;
                display: flex;
                justify-content: space-around;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            }

            body.theme-dark .mobile-bottom-nav {
                background: rgba(30, 41, 59, 0.95);
                border-top-color: rgba(255, 255, 255, 0.1);
            }

            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                padding: 8px 12px;
                color: #6a6a6a;
                font-size: 0.75rem;
                transition: all 0.3s ease;
            }

            .mobile-nav-item.active {
                color: var(--bloomly-primary);
            }

            .mobile-nav-item i {
                font-size: 1.25rem;
            }
        }

        .article-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        /* Comment Thread */
        .comment-thread {
            margin-left: 40px;
            border-left: 2px solid rgba(102, 126, 234, 0.2);
            padding-left: 16px;
        }

        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        /* Button Press Feedback */
        .btn-primary:active,
        .btn-secondary:active,
        button:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-primary:active::before {
            width: 300px;
            height: 300px;
        }

        /* Enhanced Card Hover Effects */
        .glass-card {
            cursor: pointer;
            position: relative;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            opacity: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .glass-card:hover::before {
            opacity: 1;
        }

        /* Mood Emoji Animations */
        .mood-emoji {
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-block;
        }

        .mood-emoji:hover {
            transform: scale(1.2) rotate(5deg);
            filter: drop-shadow(0 4px 8px rgba(102, 126, 234, 0.4));
        }

        .mood-emoji.selected {
            animation: moodBounce 0.5s ease;
            transform: scale(1.3);
            filter: drop-shadow(0 6px 12px rgba(102, 126, 234, 0.6));
        }

        @keyframes moodBounce {
            0%, 100% { transform: scale(1.3) translateY(0); }
            50% { transform: scale(1.4) translateY(-10px); }
        }

        /* Loading Skeleton Screens */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }

        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 16px;
        }

        .skeleton-card {
            height: 200px;
            border-radius: 16px;
        }

        body.theme-dark .skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.1) 25%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.1) 75%);
            background-size: 200% 100%;
        }

        /* Achievement Badges */
        .achievement-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
            transition: all 0.3s ease;
            position: relative;
        }

        .achievement-badge:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px rgba(251, 191, 36, 0.6);
        }

        .achievement-badge.new {
            animation: badgePop 0.6s ease;
        }

        @keyframes badgePop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .achievement-badge::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 20px;
            height: 20px;
            background: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
            display: none;
        }

        .achievement-badge.new::after {
            display: block;
            animation: pulse 1s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        /* Crisis Resources Panel */
        .crisis-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
            background: rgba(239, 68, 68, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(239, 68, 68, 0.4);
            color: white;
            transition: all 0.3s ease;
        }

        .crisis-panel.hidden {
            transform: translateY(calc(100% + 20px));
            opacity: 0;
            pointer-events: none;
        }

        .crisis-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9998;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.5);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .crisis-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(239, 68, 68, 0.7);
        }

        .crisis-button:active {
            transform: scale(0.95);
        }

        /* Page Transitions */
        .page-transition-enter {
            opacity: 0;
            transform: translateY(20px);
        }

        .page-transition-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .page-transition-exit {
            opacity: 1;
            transform: translateY(0);
        }

        .page-transition-exit-active {
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Accessibility Improvements */
        *:focus-visible {
            outline: 3px solid #667eea;
            outline-offset: 2px;
            border-radius: 4px;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Keyboard Navigation Indicators */
        .keyboard-nav-active *:focus {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        /* Swipe Gestures (Mobile) */
        .swipeable {
            touch-action: pan-y;
            position: relative;
        }

        .swipeable.swiping {
            transition: transform 0.2s ease;
        }

        /* Celebration Animation */
        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            pointer-events: none;
        }

        .celebration-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 50%;
            animation: celebrate 1s ease-out forwards;
        }

        @keyframes celebrate {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            padding: 12px 24px;
            border-radius: 12px;
            border: 2px solid #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
    </style>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <!-- Supabase Client Helper Functions -->
    <script src="script.supabase.js"></script>
    <!-- Firebase to Supabase Compatibility Layer -->
    <script src="script.firebase-compat.js"></script>
    <script>
        // Supabase configuration from environment variables
        // These should be set in your deployment environment (Vercel/Netlify)
        // For local development, create a .env file or set window.SUPABASE_* variables
        // In production, these should be injected at build time or set as environment variables
        
        // Try to get from various sources
        window.SUPABASE_URL = window.SUPABASE_URL || 
            (typeof process !== 'undefined' && process.env?.SUPABASE_URL) ||
            '';
        window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 
            (typeof process !== 'undefined' && process.env?.SUPABASE_ANON_KEY) ||
            '';
        
        // Initialize Supabase when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            if (window.SupabaseClient) {
                const client = window.SupabaseClient.init();
                if (client) {
                    console.log('Supabase initialized successfully');
                } else {
                    console.error('Failed to initialize Supabase. Check your SUPABASE_URL and SUPABASE_ANON_KEY.');
                }
            } else {
                console.error('Supabase client helper not loaded. Make sure script.supabase.js is included.');
            }
        });
    </script>
</head>
<body class="theme-light">
    <div id="root"></div>
    <div id="particles-container"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Storage Utility with user-specific data support
        const storage = {
            get: (key, defaultValue) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch {
                    return defaultValue;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (error) {
                    console.error('Storage error:', error);
                }
            },
            // Get user-specific data
            getUserData: (key, defaultValue) => {
                const currentUser = storage.get('bloomly_current_user', null);
                if (!currentUser) return defaultValue;
                const userKey = `bloomly_user_${currentUser.id}_${key}`;
                return storage.get(userKey, defaultValue);
            },
            // Set user-specific data
            setUserData: (key, value) => {
                const currentUser = storage.get('bloomly_current_user', null);
                if (!currentUser) return;
                const userKey = `bloomly_user_${currentUser.id}_${key}`;
                storage.set(userKey, value);
            }
        };

        // Authentication Utility
        const auth = {
            // Check if user is logged in (works with compatibility layer)
            isAuthenticated: () => {
                // Check compatibility layer (which syncs with Supabase)
                if (window.firebaseAuth?.currentUser) {
                    return true;
                }
                // Fallback to localStorage
                const user = storage.get('bloomly_current_user', null);
                return user !== null;
            },
            // Get current user (works with compatibility layer)
            getCurrentUser: () => {
                // Check compatibility layer (which syncs with Supabase)
                if (window.firebaseAuth?.currentUser) {
                    const firebaseUser = window.firebaseAuth.currentUser;
                    return {
                        id: firebaseUser.uid,
                        email: firebaseUser.email,
                        name: firebaseUser.displayName || firebaseUser.email?.split('@')[0] || 'User',
                        role: firebaseUser.email === 'admin@example.com' ? 'admin' : 'user'
                    };
                }
                // Fallback to localStorage
                return storage.get('bloomly_current_user', null);
            },
            // Check if user is admin
            isAdmin: () => {
                const user = auth.getCurrentUser();
                return user && user.role === 'admin';
            },
            // Logout - works with compatibility layer
            logout: () => {
                // Sign out via compatibility layer (which uses Supabase)
                if (window.firebaseAuth && window.firebaseSignOut) {
                    window.firebaseSignOut(window.firebaseAuth).then(() => {
                        // Clear local storage
                        storage.set('bloomly_current_user', null);
                        // Redirect to login
                        window.location.href = 'login.html';
                    }).catch((error) => {
                        console.error('Error signing out:', error);
                        // Still redirect even if signOut fails
                        storage.set('bloomly_current_user', null);
                        window.location.href = 'login.html';
                    });
                } else {
                    // Fallback if compatibility layer not available
                    storage.set('bloomly_current_user', null);
                    window.location.href = 'login.html';
                }
            },
            // Require authentication (redirect if not logged in)
            requireAuth: () => {
                if (!auth.isAuthenticated()) {
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            },
            // Require admin role
            requireAdmin: () => {
                if (!auth.isAuthenticated()) {
                    window.location.href = 'login.html';
                    return false;
                }
                if (!auth.isAdmin()) {
                    alert('Admin access required');
                    return false;
                }
                return true;
            }
        };

        // Protected pages that require authentication
        const protectedPages = ['deborah', 'journal', 'mood', 'progress'];
        const adminPages = ['articles']; // Articles publishing requires admin

        // Initialize Settings
        const defaultSettings = {
            theme: 'light',
            fontSize: 'standard',
            uiDensity: 'standard',
            backgroundAmbience: 'animated',
            enhancedReadability: false,
            notifications: {
                dailyMoodCheck: true,
                journalPrompts: true,
                newArticles: true,
                newVideos: true
            },
            nightMode: false
        };

        // Contrast Detection and Color Adjustment Utilities
        const ContrastUtils = {
            // Convert hex to RGB
            hexToRgb: (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            },

            // Calculate relative luminance (WCAG formula)
            getLuminance: (r, g, b) => {
                const [rs, gs, bs] = [r, g, b].map(val => {
                    val = val / 255;
                    return val <= 0.03928 ? val / 12.92 : Math.pow((val + 0.055) / 1.055, 2.4);
                });
                return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
            },

            // Calculate contrast ratio (WCAG formula)
            getContrastRatio: (color1, color2) => {
                const rgb1 = typeof color1 === 'string' ? ContrastUtils.hexToRgb(color1) : color1;
                const rgb2 = typeof color2 === 'string' ? ContrastUtils.hexToRgb(color2) : color2;
                
                if (!rgb1 || !rgb2) return 1;
                
                const lum1 = ContrastUtils.getLuminance(rgb1.r, rgb1.g, rgb1.b);
                const lum2 = ContrastUtils.getLuminance(rgb2.r, rgb2.g, rgb2.b);
                
                const lighter = Math.max(lum1, lum2);
                const darker = Math.min(lum1, lum2);
                
                return (lighter + 0.05) / (darker + 0.05);
            },

            // Check if contrast meets WCAG AA (4.5:1) or AAA (7:1)
            meetsWCAG: (contrast, level = 'AA') => {
                return level === 'AAA' ? contrast >= 7 : contrast >= 4.5;
            },

            // Get computed background color of an element
            getBackgroundColor: (element) => {
                const style = window.getComputedStyle(element);
                let bgColor = style.backgroundColor;
                
                // If transparent, check parent
                if (bgColor === 'rgba(0, 0, 0, 0)' || bgColor === 'transparent') {
                    const parent = element.parentElement;
                    if (parent && parent !== document.body) {
                        return ContrastUtils.getBackgroundColor(parent);
                    }
                    // Default to body background
                    bgColor = window.getComputedStyle(document.body).backgroundColor;
                }
                
                return bgColor;
            },

            // Ensure text color meets contrast requirements
            ensureContrast: (element, minContrast = 4.5) => {
                if (!element) return;
                
                const bgColor = ContrastUtils.getBackgroundColor(element);
                const currentColor = window.getComputedStyle(element).color;
                
                // Convert to RGB
                const bgRgb = ContrastUtils.parseRgb(bgColor);
                const textRgb = ContrastUtils.parseRgb(currentColor);
                
                if (!bgRgb || !textRgb) return;
                
                // Calculate current contrast
                const contrast = ContrastUtils.getContrastRatio(bgRgb, textRgb);
                
                // If contrast is too low, adjust text color
                if (contrast < minContrast) {
                    const bgLum = ContrastUtils.getLuminance(bgRgb.r, bgRgb.g, bgRgb.b);
                    const isEnhanced = document.body.classList.contains('enhanced-readability');
                    
                    // If background is dark, use light text; if light, use dark text
                    if (bgLum < 0.5) {
                        // Dark background - use light text (white or near-white)
                        element.style.color = '#FFFFFF';
                    } else {
                        // Light background - use dark text with appropriate contrast
                        if (isEnhanced) {
                            element.style.color = '#0A0A0A'; // Maximum contrast for enhanced mode
                        } else {
                            element.style.color = '#1A1A1A'; // High contrast standard
                        }
                    }
                }
            },

            // Parse RGB string to object
            parseRgb: (rgbString) => {
                if (rgbString.startsWith('#')) {
                    return ContrastUtils.hexToRgb(rgbString);
                }
                
                const match = rgbString.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
                if (match) {
                    return {
                        r: parseInt(match[1]),
                        g: parseInt(match[2]),
                        b: parseInt(match[3])
                    };
                }
                return null;
            },

            // Apply contrast adjustments to all elements in dark theme
            applyDarkThemeContrast: () => {
                if (!document.body.classList.contains('theme-dark')) return;
                
                // Select all text elements
                const textElements = document.querySelectorAll(
                    'p, span, div, h1, h2, h3, h4, h5, h6, label, a, button, input, textarea, select, li, td, th'
                );
                
                textElements.forEach(el => {
                    // Skip elements that should maintain their color (like buttons with gradients)
                    if (el.classList.contains('btn-primary') || 
                        el.classList.contains('butterfly-logo') ||
                        el.closest('.particle')) {
                        return;
                    }
                    
                    // Ensure minimum 7:1 contrast for WCAG AAA
                    ContrastUtils.ensureContrast(el, 7);
                });
            },

            // Apply contrast adjustments to all elements in light theme
            applyLightThemeContrast: () => {
                if (!document.body.classList.contains('theme-light')) return;
                
                // Select all text elements
                const textElements = document.querySelectorAll(
                    'p, span, div, h1, h2, h3, h4, h5, h6, label, a, button, input, textarea, select, li, td, th'
                );
                
                textElements.forEach(el => {
                    // Skip elements that should maintain their color
                    if (el.classList.contains('btn-primary') || 
                        el.classList.contains('butterfly-logo') ||
                        el.closest('.particle') ||
                        el.closest('.user-message')) {
                        return;
                    }
                    
                    // Ensure minimum 4.5:1 contrast for WCAG AA (or 7:1 if enhanced readability)
                    const minContrast = document.body.classList.contains('enhanced-readability') ? 7 : 4.5;
                    ContrastUtils.ensureContrast(el, minContrast);
                });
            },

            // Apply contrast adjustments for Nature, Lavender, and Ocean themes
            applyThemeContrast: () => {
                const theme = document.body.className.match(/theme-(nature|lavender|ocean)/);
                if (!theme) return;
                
                const themeName = theme[1];
                const textElements = document.querySelectorAll(
                    'p, span, div, h1, h2, h3, h4, h5, h6, label, a, button, input, textarea, select, li, td, th'
                );
                
                // Theme-specific color mappings
                const themeColors = {
                    nature: { dark: '#0f2a08', medium: '#1a3d0f', light: '#2d5016' },
                    lavender: { dark: '#380d63', medium: '#4a148c', light: '#6a1b9a' },
                    ocean: { dark: '#003d6b', medium: '#01579b', light: '#0277bd' }
                };
                
                const colors = themeColors[themeName];
                if (!colors) return;
                
                textElements.forEach(el => {
                    // Skip elements that should maintain their color
                    if (el.classList.contains('btn-primary') || 
                        el.classList.contains('butterfly-logo') ||
                        el.closest('.particle') ||
                        el.closest('.user-message')) {
                        return;
                    }
                    
                    // Ensure minimum 4.5:1 contrast for WCAG AA
                    const bgColor = ContrastUtils.getBackgroundColor(el);
                    const bgRgb = ContrastUtils.parseRgb(bgColor);
                    if (bgRgb) {
                        const bgLum = ContrastUtils.getLuminance(bgRgb.r, bgRgb.g, bgRgb.b);
                        const currentColor = window.getComputedStyle(el).color;
                        const currentRgb = ContrastUtils.parseRgb(currentColor);
                        
                        if (currentRgb) {
                            const currentContrast = ContrastUtils.getContrastRatio(bgRgb, currentRgb);
                            if (currentContrast < 4.5) {
                                // Light background - use dark theme color
                                if (bgLum > 0.5) {
                                    el.style.color = colors.dark;
        } else {
                                    // Dark background - use light color
                                    el.style.color = '#FFFFFF';
                                }
                            }
                        }
                    }
                });
            }
        };

        // Auto-apply contrast adjustments when theme changes
        const applyThemeContrast = () => {
            if (document.body.classList.contains('theme-dark')) {
                // Use requestAnimationFrame to ensure DOM is updated
                requestAnimationFrame(() => {
                    ContrastUtils.applyDarkThemeContrast();
                });
            } else if (document.body.classList.contains('theme-light')) {
                requestAnimationFrame(() => {
                    ContrastUtils.applyLightThemeContrast();
                });
            } else if (document.body.classList.contains('theme-nature') || 
                       document.body.classList.contains('theme-lavender') || 
                       document.body.classList.contains('theme-ocean')) {
                requestAnimationFrame(() => {
                    ContrastUtils.applyThemeContrast();
                });
            }
        };

        // Watch for dynamically added elements and apply contrast
        const setupContrastObserver = () => {
            const hasTheme = document.body.classList.contains('theme-dark') || 
                           document.body.classList.contains('theme-light') ||
                           document.body.classList.contains('theme-nature') ||
                           document.body.classList.contains('theme-lavender') ||
                           document.body.classList.contains('theme-ocean');
            if (!hasTheme) return;
            
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) { // Element node
                            requestAnimationFrame(() => {
                                applyThemeContrast();
                            });
                        }
                    });
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });

            return observer;
        };

        // Initialize contrast observer on page load
        if (document.body) {
            const settings = storage.get('bloomly_settings', defaultSettings);
            if (['dark', 'light', 'nature', 'lavender', 'ocean'].includes(settings.theme)) {
                setTimeout(() => {
                    applyThemeContrast();
                    setupContrastObserver();
                }, 500);
            }
        }

        // Particle System
        function ParticleSystem() {
            useEffect(() => {
                const container = document.getElementById('particles-container');
                if (!container) return;

                const particles = [];
                const particleCount = 8;

                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle butterfly-particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 15 + 's';
                    particle.style.animationDuration = (10 + Math.random() * 10) + 's';
                    container.appendChild(particle);
                    particles.push(particle);
                }

                return () => {
                    particles.forEach(p => p.remove());
                };
            }, []);

            return null;
        }

        // Settings Component
        function Settings({ isOpen, onClose }) {
            const [settings, setSettings] = useState(storage.get('bloomly_settings', defaultSettings));
            const [activeTab, setActiveTab] = useState('appearance');

            useEffect(() => {
                storage.set('bloomly_settings', settings);
                const classes = [
                    `theme-${settings.theme}`,
                    settings.nightMode ? 'night-mode' : '',
                    settings.enhancedReadability ? 'enhanced-readability' : ''
                ].filter(Boolean).join(' ');
                document.body.className = classes;
                
                // Apply contrast adjustments for both themes
                applyThemeContrast();
                // Re-apply after a short delay to ensure all elements are rendered
                setTimeout(applyThemeContrast, 100);
            }, [settings]);

            const updateSetting = (key, value) => {
                setSettings(prev => ({ ...prev, [key]: value }));
            };

            const updateNotification = (key, value) => {
                setSettings(prev => ({
                    ...prev,
                    notifications: { ...prev.notifications, [key]: value }
                }));
            };

            if (!isOpen) return null;

            return React.createElement('div', {
                className: 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4'
            },
                    React.createElement('div', {
                    className: 'glass-card max-w-4xl w-full max-h-[90vh] overflow-y-auto p-8'
                },
                    React.createElement('div', { className: 'flex justify-between items-center mb-6' },
                        React.createElement('h2', { className: 'text-3xl font-bold' }, 'Settings'),
                        React.createElement('button', {
                            onClick: onClose,
                            className: 'text-2xl text-gray-500 hover:text-gray-700'
                        }, '')
                    ),

                    React.createElement('div', { className: 'flex gap-4 mb-6 border-b' },
                        ['appearance', 'notifications', 'account'].map(tab =>
                                React.createElement('button', {
                                key: tab,
                                onClick: () => setActiveTab(tab),
                                className: `px-4 py-2 font-semibold capitalize ${activeTab === tab ? 'border-b-2 border-purple-500 text-purple-600' : 'text-gray-500'}`
                            }, tab)
                        )
                    ),

                    activeTab === 'appearance' && React.createElement('div', { className: 'space-y-6' },
                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-semibold mb-3' }, 'Theme'),
                            React.createElement('div', { className: 'grid grid-cols-5 gap-3' },
                                ['light', 'dark', 'nature', 'lavender', 'ocean'].map(theme =>
                            React.createElement('button', {
                                        key: theme,
                                        onClick: () => updateSetting('theme', theme),
                                        className: `px-4 py-3 rounded-lg border-2 capitalize font-semibold ${settings.theme === theme ? 'border-purple-500 bg-purple-50' : 'border-gray-200'}`,
                                        style: { background: `var(--theme-${theme})` }
                                    }, theme)
                                )
                            )
                        ),

                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-semibold mb-3' }, 'Font Size'),
                            React.createElement('select', {
                                value: settings.fontSize,
                                onChange: (e) => updateSetting('fontSize', e.target.value),
                                className: 'w-full p-3 border border-gray-300 rounded-lg'
                            },
                                ['small', 'standard', 'large'].map(size =>
                                    React.createElement('option', { key: size, value: size }, size.charAt(0).toUpperCase() + size.slice(1))
                                )
                            )
                        ),

                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-semibold mb-3' }, 'UI Density'),
                            React.createElement('select', {
                                value: settings.uiDensity,
                                onChange: (e) => updateSetting('uiDensity', e.target.value),
                                className: 'w-full p-3 border border-gray-300 rounded-lg'
                            },
                                ['compact', 'standard', 'spacious'].map(density =>
                                    React.createElement('option', { key: density, value: density }, density.charAt(0).toUpperCase() + density.slice(1))
                                )
                            )
                        ),

                        React.createElement('div', null,
                            React.createElement('label', { className: 'flex items-center gap-3' },
                                React.createElement('input', {
                                    type: 'checkbox',
                                    checked: settings.backgroundAmbience === 'animated',
                                    onChange: (e) => updateSetting('backgroundAmbience', e.target.checked ? 'animated' : 'static'),
                                    className: 'w-5 h-5'
                                }),
                                React.createElement('span', { className: 'font-semibold' }, 'Animated Background Ambience')
                            )
                        ),

                        React.createElement('div', null,
                            React.createElement('label', { className: 'flex items-center gap-3' },
                                React.createElement('input', {
                                    type: 'checkbox',
                                    checked: settings.backgroundAmbience === 'animated',
                                    onChange: (e) => updateSetting('backgroundAmbience', e.target.checked ? 'animated' : 'static'),
                                    className: 'w-5 h-5'
                                }),
                                React.createElement('span', { className: 'font-semibold' }, 'Animated Background Ambience')
                            )
                        ),

                        settings.theme === 'light' && React.createElement('div', { className: 'p-4 glass-card border-2 border-purple-200' },
                            React.createElement('label', { className: 'flex items-center gap-3' },
                                React.createElement('input', {
                                    type: 'checkbox',
                                    checked: settings.enhancedReadability || false,
                                    onChange: (e) => updateSetting('enhancedReadability', e.target.checked),
                                    className: 'w-5 h-5'
                                }),
                                React.createElement('div', { className: 'flex-1' },
                                    React.createElement('span', { className: 'font-semibold block' }, 'Enhanced Readability Mode'),
                                    React.createElement('p', { className: 'text-sm text-gray-600 mt-1' }, 'Boost text contrast for maximum readability (WCAG AAA)')
                                )
                            )
                        ),

                        React.createElement('div', null,
                            React.createElement('label', { className: 'flex items-center gap-3' },
                                React.createElement('input', {
                                    type: 'checkbox',
                                    checked: settings.nightMode,
                                    onChange: (e) => updateSetting('nightMode', e.target.checked),
                                    className: 'w-5 h-5'
                                }),
                                React.createElement('span', { className: 'font-semibold' }, 'Night Mode / Serenity Mode')
                            )
                        )
                    ),

                    activeTab === 'notifications' && React.createElement('div', { className: 'space-y-4' },
                        Object.entries(settings.notifications).map(([key, value]) =>
                            React.createElement('div', { key: key, className: 'flex items-center justify-between p-4 glass-card' },
                                React.createElement('div', null,
                                    React.createElement('h3', { className: 'font-semibold' }, key.split(/(?=[A-Z])/).join(' ')),
                                    React.createElement('p', { className: 'text-sm text-gray-600' }, `Receive notifications for ${key}`)
                                ),
                                React.createElement('label', { className: 'relative inline-block w-12 h-6' },
                                    React.createElement('input', {
                                        type: 'checkbox',
                                        checked: value,
                                        onChange: (e) => updateNotification(key, e.target.checked),
                                        className: 'opacity-0 w-0 h-0'
                                    }),
                                    React.createElement('span', {
                                        className: `absolute cursor-pointer top-0 left-0 right-0 bottom-0 rounded-full transition-colors ${value ? 'bg-purple-500' : 'bg-gray-300'}`
                                    },
                                        React.createElement('span', {
                                            className: `absolute h-5 w-5 bg-white rounded-full transition-transform ${value ? 'translate-x-6' : 'translate-x-1'} top-0.5`
                                        })
                                    )
                                    )
                                )
                            )
                        ),

                    activeTab === 'account' && React.createElement('div', { className: 'space-y-4' },
                        React.createElement('div', { className: 'p-4 glass-card' },
                            React.createElement('h3', { className: 'font-semibold mb-2' }, 'Change Email'),
                            React.createElement('input', {
                                type: 'email',
                                placeholder: 'New email address',
                                className: 'w-full p-3 border border-gray-300 rounded-lg mb-2'
                            }),
                            React.createElement('button', { className: 'btn-primary' }, 'Update Email')
                        ),
                        React.createElement('div', { className: 'p-4 glass-card' },
                            React.createElement('h3', { className: 'font-semibold mb-2' }, 'Change Password'),
                            React.createElement('input', {
                                type: 'password',
                                placeholder: 'New password',
                                className: 'w-full p-3 border border-gray-300 rounded-lg mb-2'
                            }),
                            React.createElement('button', { className: 'btn-primary' }, 'Update Password')
                        ),
                        React.createElement('div', { className: 'p-4 glass-card' },
                            React.createElement('h3', { className: 'font-semibold mb-2' }, 'Two-Factor Authentication'),
                            React.createElement('button', { className: 'btn-secondary' }, 'Enable 2FA')
                        ),
                        React.createElement('div', { className: 'p-4 glass-card' },
                            React.createElement('h3', { className: 'font-semibold mb-2' }, 'Data Export'),
                            React.createElement('button', { className: 'btn-secondary' }, 'Export My Data')
                        )
                    )
                )
            );
        }

        // AI Therapist Deborah - Enhanced with personality and memory
        // Advanced Deborah - Emotional Intelligence AI System
        // ========== ACHIEVEMENT SYSTEM ==========
        const AchievementSystem = {
            badges: [
                { id: 'first_journal', name: 'First Entry', icon: '', description: 'Write your first journal entry' },
                { id: 'journal_streak_7', name: 'Week Warrior', icon: '', description: 'Journal for 7 days straight' },
                { id: 'journal_streak_30', name: 'Monthly Master', icon: '', description: 'Journal for 30 days straight' },
                { id: 'mood_tracker_7', name: 'Mood Monitor', icon: '', description: 'Track your mood for 7 days' },
                { id: 'deborah_chat_10', name: 'Conversation Starter', icon: '', description: 'Have 10 conversations with Deborah' },
                { id: 'deborah_chat_50', name: 'Deborah Expert', icon: '', description: 'Have 50 conversations with Deborah' },
                { id: 'articles_read_5', name: 'Knowledge Seeker', icon: '', description: 'Read 5 articles' },
                { id: 'progress_insight', name: 'Self Aware', icon: '', description: 'View your progress insights' },
                { id: 'habit_7', name: 'Habit Builder', icon: '', description: 'Complete a habit for 7 days' },
                { id: 'goal_achieved', name: 'Goal Getter', icon: '', description: 'Achieve your first goal' }
            ],

            checkAchievement: (achievementId, userId) => {
                const userAchievements = storage.getUserData('achievements', []);
                if (userAchievements.includes(achievementId)) return false; // Already earned
                
                userAchievements.push(achievementId);
                storage.setUserData('achievements', userAchievements);
                AchievementSystem.showCelebration(achievementId);
                return true;
            },

            getEarnedBadges: (userId) => {
                const earnedIds = storage.getUserData('achievements', []);
                return AchievementSystem.badges.filter(badge => earnedIds.includes(badge.id));
            },

            showCelebration: (achievementId) => {
                const badge = AchievementSystem.badges.find(b => b.id === achievementId);
                if (!badge) return;

                // Create celebration particles
                const container = document.createElement('div');
                container.className = 'celebration';
                document.body.appendChild(container);

                for (let i = 0; i < 20; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'celebration-particle';
                    const angle = (Math.PI * 2 * i) / 20;
                    const distance = 200;
                    particle.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
                    particle.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
                    container.appendChild(particle);
                }

                // Show badge notification
                setTimeout(() => {
                    alert(` Achievement Unlocked: ${badge.name}!\n${badge.description}`);
                    container.remove();
                }, 100);
            }
        };

        // ========== CRISIS RESOURCES ==========
        const CrisisResources = {
            resources: [
                { name: 'National Suicide Prevention Lifeline', phone: '988', text: 'Text HOME to 741741', available: '24/7' },
                { name: 'Crisis Text Line', phone: '', text: 'Text HOME to 741741', available: '24/7' },
                { name: 'SAMHSA National Helpline', phone: '1-800-662-4357', text: '', available: '24/7' },
                { name: 'Emergency Services', phone: '911', text: '', available: '24/7' }
            ],

            detectCrisisKeywords: (text) => {
                const keywords = ['suicide', 'kill myself', 'end it all', 'want to die', 'hurt myself', 'crisis', 'emergency'];
                const lowerText = text.toLowerCase();
                return keywords.some(keyword => lowerText.includes(keyword));
            }
        };

        // ========== LOADING SKELETON COMPONENT ==========
        function LoadingSkeleton({ type = 'card', lines = 3 }) {
            if (type === 'card') {
                return React.createElement('div', { className: 'skeleton skeleton-card' });
            }
            if (type === 'text') {
                return React.createElement('div', { className: 'space-y-2' },
                    React.createElement('div', { className: 'skeleton skeleton-title' }),
                    ...Array(lines).fill(0).map((_, i) =>
                        React.createElement('div', { key: i, className: 'skeleton skeleton-text' })
                    )
                );
            }
            return null;
        }

        // ========== HABIT TRACKING SYSTEM ==========
        const HabitTracker = {
            habits: [
                { id: 'meditation', name: 'Meditation', icon: '', color: 'purple' },
                { id: 'exercise', name: 'Exercise', icon: '', color: 'green' },
                { id: 'water', name: 'Drink Water', icon: '', color: 'blue' },
                { id: 'sleep', name: 'Sleep 8 Hours', icon: '', color: 'indigo' },
                { id: 'gratitude', name: 'Gratitude Journal', icon: '', color: 'yellow' },
                { id: 'reading', name: 'Reading', icon: '', color: 'pink' }
            ],

            logHabit: (habitId, date = new Date()) => {
                const user = auth.getCurrentUser();
                if (!user) return false;

                const dateStr = date.toISOString().split('T')[0];
                const logs = storage.getUserData('habit_logs', {});
                if (!logs[habitId]) logs[habitId] = [];
                if (!logs[habitId].includes(dateStr)) {
                    logs[habitId].push(dateStr);
                    storage.setUserData('habit_logs', logs);
                    HabitTracker.checkStreaks(habitId);
                    return true;
                }
                return false;
            },

            getStreak: (habitId) => {
                const logs = storage.getUserData('habit_logs', {});
                const habitLogs = logs[habitId] || [];
                if (habitLogs.length === 0) return 0;

                const sorted = habitLogs.sort().reverse();
                let streak = 0;
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let i = 0; i < sorted.length; i++) {
                    const logDate = new Date(sorted[i]);
                    logDate.setHours(0, 0, 0, 0);
                    const expectedDate = new Date(today);
                    expectedDate.setDate(today.getDate() - i);

                    if (logDate.getTime() === expectedDate.getTime()) {
                        streak++;
                    } else {
                        break;
                    }
                }

                return streak;
            },

            checkStreaks: (habitId) => {
                const streak = HabitTracker.getStreak(habitId);
                if (streak === 7) {
                    AchievementSystem.checkAchievement('habit_7', auth.getCurrentUser()?.id);
                }
            },

            isCompletedToday: (habitId) => {
                const logs = storage.getUserData('habit_logs', {});
                const habitLogs = logs[habitId] || [];
                const today = new Date().toISOString().split('T')[0];
                return habitLogs.includes(today);
            }
        };

        // ========== SLEEP TRACKING SYSTEM ==========
        const SleepTracker = {
            logSleep: (hours, quality, date = new Date()) => {
                const user = auth.getCurrentUser();
                if (!user) return false;

                const dateStr = date.toISOString().split('T')[0];
                const logs = storage.getUserData('sleep_logs', {});
                logs[dateStr] = { hours, quality, date: dateStr };
                storage.setUserData('sleep_logs', logs);
                return true;
            },

            getSleepHistory: (days = 7) => {
                const logs = storage.getUserData('sleep_logs', {});
                const history = [];
                const today = new Date();

                for (let i = 0; i < days; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    history.push(logs[dateStr] || { date: dateStr, hours: null, quality: null });
                }

                return history.reverse();
            },

            getAverageSleep: (days = 7) => {
                const history = SleepTracker.getSleepHistory(days);
                const validEntries = history.filter(entry => entry.hours !== null);
                if (validEntries.length === 0) return 0;
                const total = validEntries.reduce((sum, entry) => sum + entry.hours, 0);
                return (total / validEntries.length).toFixed(1);
            }
        };

        // ========== GOAL SETTING SYSTEM ==========
        const GoalSystem = {
            createGoal: (title, description, targetDate, category) => {
                const user = auth.getCurrentUser();
                if (!user) return null;

                const goals = storage.getUserData('goals', []);
                const goal = {
                    id: Date.now().toString(),
                    title,
                    description,
                    targetDate,
                    category,
                    createdAt: new Date().toISOString(),
                    completed: false,
                    progress: 0
                };
                goals.push(goal);
                storage.setUserData('goals', goals);
                return goal;
            },

            completeGoal: (goalId) => {
                const goals = storage.getUserData('goals', []);
                const goal = goals.find(g => g.id === goalId);
                if (goal && !goal.completed) {
                    goal.completed = true;
                    goal.completedAt = new Date().toISOString();
                    storage.setUserData('goals', goals);
                    AchievementSystem.checkAchievement('goal_achieved', auth.getCurrentUser()?.id);
                    return true;
                }
                return false;
            },

            getGoals: (includeCompleted = false) => {
                const goals = storage.getUserData('goals', []);
                return includeCompleted ? goals : goals.filter(g => !g.completed);
            }
        };

        // ========== DAILY CHECK-IN PROMPTS ==========
        const DailyCheckIn = {
            prompts: [
                "How are you feeling today?",
                "What's one thing you're grateful for?",
                "What's on your mind right now?",
                "How did you sleep last night?",
                "What's one thing you'd like to accomplish today?",
                "What's bringing you joy today?",
                "What challenge are you facing?",
                "How can you be kind to yourself today?"
            ],

            getTodaysPrompt: () => {
                const lastPromptIndex = storage.getUserData('last_checkin_prompt_index', -1);
                let nextIndex = (lastPromptIndex + 1) % DailyCheckIn.prompts.length;
                storage.setUserData('last_checkin_prompt_index', nextIndex);
                return DailyCheckIn.prompts[nextIndex];
            },

            hasCheckedInToday: () => {
                const lastCheckIn = storage.getUserData('last_checkin_date', '');
                const today = new Date().toISOString().split('T')[0];
                return lastCheckIn === today;
            },

            markCheckedIn: () => {
                const today = new Date().toISOString().split('T')[0];
                storage.setUserData('last_checkin_date', today);
            },

            // New morning/night check-in system
            getTimeOfDay: () => {
                const hour = new Date().getHours();
                if (hour >= 5 && hour < 14) return 'morning'; // 5 AM - 2 PM
                if (hour >= 18 && hour < 23) return 'night'; // 6 PM - 11 PM
                return null; // Outside check-in hours
            },

            hasCheckedInMorning: () => {
                const lastCheckIn = storage.getUserData('morning_checkin_date', '');
                const today = new Date().toISOString().split('T')[0];
                return lastCheckIn === today;
            },

            hasCheckedInNight: () => {
                const lastCheckIn = storage.getUserData('night_checkin_date', '');
                const today = new Date().toISOString().split('T')[0];
                return lastCheckIn === today;
            },

            shouldShowCheckIn: () => {
                const timeOfDay = DailyCheckIn.getTimeOfDay();
                if (!timeOfDay) return false;
                
                if (timeOfDay === 'morning') {
                    return !DailyCheckIn.hasCheckedInMorning();
                } else if (timeOfDay === 'night') {
                    return !DailyCheckIn.hasCheckedInNight();
                }
                return false;
            },

            markMorningCheckedIn: () => {
                const today = new Date().toISOString().split('T')[0];
                storage.setUserData('morning_checkin_date', today);
            },

            markNightCheckedIn: () => {
                const today = new Date().toISOString().split('T')[0];
                storage.setUserData('night_checkin_date', today);
            },

            getMorningQuestions: () => [
                { id: 'feeling', label: 'How are you feeling this morning?', placeholder: 'Share how you\'re feeling...' },
                { id: 'plans', label: 'What are your plans for today?', placeholder: 'What do you hope to accomplish?' },
                { id: 'lookingForward', label: 'Is there anything you\'re looking forward to?', placeholder: 'Something positive to anticipate...' },
                { id: 'sleep', label: 'How did you sleep last night?', placeholder: 'Rate your sleep quality or share details...' }
            ],

            getNightQuestions: () => [
                { id: 'dayOverall', label: 'How was your day overall?', placeholder: 'Rate your day or share how it went...' },
                { id: 'accomplished', label: 'What did you accomplish today?', placeholder: 'What went well or what did you complete?' },
                { id: 'plansTomorrow', label: 'What are your plans for tomorrow?', placeholder: 'What do you hope to do tomorrow?' },
                { id: 'reflect', label: 'Is there anything you\'d like to reflect on?', placeholder: 'Any thoughts or insights from today...' }
            ],

            saveCheckIn: async (type, responses) => {
                const user = window.firebaseAuth?.currentUser;
                if (!user) return false;

                const today = new Date().toISOString().split('T')[0];
                
                // Save to localStorage
                if (type === 'morning') {
                    storage.setUserData('morning_checkin_date', today);
                    storage.setUserData('morning_checkin_responses', responses);
                } else if (type === 'night') {
                    storage.setUserData('night_checkin_date', today);
                    storage.setUserData('night_checkin_responses', responses);
                }

                // Save to Firestore if available
                if (window.firestore) {
                    try {
                        const { collection, addDoc, Timestamp } = window.firestore;
                        await addDoc(collection(window.firebaseDb, 'dailyCheckIns'), {
                            userId: user.uid,
                            type: type,
                            date: Timestamp.now(),
                            responses: responses,
                            createdAt: Timestamp.now()
                        });
                    } catch (error) {
                        console.error('Error saving check-in to Firestore:', error);
                    }
                }

                return true;
            }
        };

        // ========== CELEBRATION ANIMATION UTILITY ==========
        const Celebration = {
            show: (message, type = 'success') => {
                const container = document.createElement('div');
                container.className = 'celebration';
                container.style.position = 'fixed';
                container.style.top = '20px';
                container.style.left = '50%';
                container.style.transform = 'translateX(-50%)';
                container.style.zIndex = '10000';
                container.style.padding = '20px 40px';
                container.style.background = type === 'success' 
                    ? 'linear-gradient(135deg, #10b981, #059669)' 
                    : 'linear-gradient(135deg, #3b82f6, #2563eb)';
                container.style.color = 'white';
                container.style.borderRadius = '16px';
                container.style.boxShadow = '0 8px 32px rgba(0,0,0,0.3)';
                container.style.fontSize = '18px';
                container.style.fontWeight = '600';
                container.textContent = message;
                document.body.appendChild(container);

                setTimeout(() => {
                    container.style.opacity = '0';
                    container.style.transform = 'translateX(-50%) translateY(-20px)';
                    container.style.transition = 'all 0.3s ease';
                    setTimeout(() => container.remove(), 300);
                }, 3000);
            }
        };

        const Deborah = {
            name: 'Deborah',
            currentMode: 'therapist', // therapist, journaling, checkin, analytics, trauma-safe
            // Get user-specific memories
            getMemories: function() {
                return storage.getUserData('memories', {
                    triggers: [],
                    goals: [],
                    patterns: [],
                    strengths: [],
                    preferences: {},
                    emotionalHistory: []
                });
            },

            // Deep emotional analysis
            analyzeEmotion: (text, history) => {
                const lower = text.toLowerCase();
                const emotions = {
                    intensity: 0.5,
                    primary: 'neutral',
                    secondary: [],
                    triggers: [],
                    needs: []
                };

                // Detect primary emotion with intensity
                if (lower.match(/\b(sad|depressed|down|hopeless|empty|numb)\b/)) {
                    emotions.primary = 'sad';
                    emotions.intensity = lower.match(/\b(very|extremely|so|really)\b/) ? 0.9 : 0.7;
                } else if (lower.match(/\b(anxious|worried|nervous|panic|fear|scared)\b/)) {
                    emotions.primary = 'anxious';
                    emotions.intensity = lower.match(/\b(very|extremely|so|really)\b/) ? 0.9 : 0.7;
                } else if (lower.match(/\b(happy|joy|excited|great|wonderful|amazing)\b/)) {
                    emotions.primary = 'happy';
                    emotions.intensity = lower.match(/\b(very|extremely|so|really)\b/) ? 0.9 : 0.7;
                } else if (lower.match(/\b(stress|overwhelmed|pressure|exhausted|tired)\b/)) {
                    emotions.primary = 'stressed';
                    emotions.intensity = lower.match(/\b(very|extremely|so|really)\b/) ? 0.9 : 0.7;
                } else if (lower.match(/\b(angry|frustrated|annoyed|irritated|mad)\b/)) {
                    emotions.primary = 'angry';
                    emotions.intensity = lower.match(/\b(very|extremely|so|really)\b/) ? 0.9 : 0.7;
                }

                // Detect triggers
                if (lower.includes('work') || lower.includes('job')) emotions.triggers.push('work');
                if (lower.includes('relationship') || lower.includes('partner') || lower.includes('friend')) emotions.triggers.push('relationships');
                if (lower.includes('family') || lower.includes('parent') || lower.includes('sibling')) emotions.triggers.push('family');
                if (lower.includes('health') || lower.includes('sick') || lower.includes('pain')) emotions.triggers.push('health');

                // Detect needs
                if (lower.includes('help') || lower.includes('support')) emotions.needs.push('support');
                if (lower.includes('understand') || lower.includes('why')) emotions.needs.push('understanding');
                if (lower.includes('cope') || lower.includes('deal')) emotions.needs.push('coping');
                if (lower.includes('advice') || lower.includes('what should')) emotions.needs.push('guidance');

                return emotions;
            },

            // Generate personalized response based on mode and analysis
            generateResponse: (userMessage, conversationHistory, mode = 'therapist') => {
                const analysis = Deborah.analyzeEmotion(userMessage, conversationHistory);
                const memories = Deborah.getMemories();
                const history = conversationHistory.slice(-5); // Last 5 messages for context

                // Build personalized context
                let personalization = '';
                if (memories.triggers.length > 0 && analysis.triggers.some(t => memories.triggers.includes(t))) {
                    personalization = `I know ${analysis.triggers.find(t => memories.triggers.includes(t))} has been challenging for you before. `;
                }
                if (memories.strengths.length > 0 && Math.random() > 0.7) {
                    personalization += `You've shown strength in ${memories.strengths[Math.floor(Math.random() * memories.strengths.length)]} before. `;
                }

                // Mode-specific responses
                switch(mode) {
                    case 'therapist':
                        return Deborah.therapistMode(userMessage, analysis, personalization, history);
                    case 'journaling':
                        return Deborah.journalingMode(userMessage, analysis, history);
                    case 'checkin':
                        return Deborah.checkinMode(userMessage, analysis, history);
                    case 'analytics':
                        return Deborah.analyticsMode(analysis);
                    case 'trauma-safe':
                        return Deborah.traumaSafeMode(userMessage, analysis);
                    default:
                        return Deborah.therapistMode(userMessage, analysis, personalization, history);
                }
            },

            // Unlimited Therapist Mode
            therapistMode: (message, analysis, personalization, history) => {
                const responses = {
                    sad: [
                        `${personalization}I can feel the weight in what you're sharing, and I want you to know that your feelings are completely valid. Sadness, even when it feels overwhelming, is a natural part of being human. Sometimes our emotions are like clouds - they may seem dark and heavy, but they're temporary, and they're part of a larger sky. What would feel most supportive right now - would you like to explore what's beneath this sadness, or would it help to focus on some gentle ways to care for yourself in this moment?`,
                        `${personalization}Thank you for trusting me with this. It takes real courage to acknowledge when we're struggling. I'm wondering - when did you first notice this sadness settling in? Sometimes understanding the timeline helps us see patterns we might not have noticed. And remember, you don't have to have all the answers right now. Just being here, just sharing this with me, is already a step toward healing.`,
                        `${personalization}I hear you, and I'm here with you in this. Sadness can feel isolating, but you're not alone. Let's take a moment together. Can you tell me - is there a specific moment or thought that seems to intensify these feelings? Sometimes naming what we're experiencing helps it feel less overwhelming.`
                    ],
                    anxious: [
                        `${personalization}I can sense the worry in your words, and I want you to know that anxiety, while uncomfortable, is your body's way of trying to protect you. The racing thoughts, the physical sensations - they're all signals. Let's breathe together for a moment. Can you tell me what specific worry feels most pressing right now? Sometimes when we name our fears, they lose some of their power.`,
                        `${personalization}Anxiety can feel like being caught in a storm where everything moves too fast. I'm here with you in this. Let's slow things down. What's one thing you know to be true right now, in this moment? Sometimes grounding ourselves in what's real and present helps the anxious thoughts settle.`,
                        `${personalization}Your anxiety is real, and it matters. I'm wondering - when you feel this anxiety, where do you notice it most in your body? Sometimes our bodies hold wisdom about what we need. And remember, this feeling will pass. You've gotten through anxious moments before, even when they felt impossible.`
                    ],
                    happy: [
                        `${personalization}I can feel the lightness and joy in your words, and it's beautiful to witness! These moments of happiness are precious, and they deserve to be celebrated. What's bringing you this joy today? I'd love to hear more about what's making you feel this way.`,
                        `${personalization}Your positivity is radiant, and I'm so glad you're experiencing this. Joy is a gift, and it's wonderful that you're allowing yourself to feel it fully. Is there something specific about this moment that feels particularly meaningful to you?`,
                        `${personalization}This happiness you're feeling - it's real, and it's yours. Sometimes we need to pause and really savor these moments. What would help you hold onto this feeling? And remember, it's okay to feel happy, even when life has been difficult. You deserve these moments.`
                    ],
                    stressed: [
                        `${personalization}Stress can feel like carrying too much weight, and I can hear that weight in your words. You're dealing with a lot right now. Let's pause together. What's the one thing that feels most overwhelming? Sometimes breaking it down helps. And remember - you don't have to handle everything at once.`,
                        `${personalization}I understand that stress can make everything feel urgent and impossible. You're doing your best, and that's enough. Let's think about this differently - what's one small thing you could do right now that would help you feel even slightly more grounded? Sometimes the smallest steps make the biggest difference.`,
                        `${personalization}Stress is real, and it's exhausting. I'm here with you. Can you tell me - when you think about everything on your plate, what feels most important? Sometimes prioritizing helps us see that not everything needs our attention right this moment.`
                    ],
                    angry: [
                        `${personalization}Anger is a powerful emotion, and it's telling you something important. Your feelings are valid, and it's okay to be angry. Can you help me understand - what's beneath this anger? Sometimes anger protects us from other feelings like hurt or disappointment. What do you think your anger is trying to tell you?`,
                        `${personalization}I hear the frustration and anger in your words, and I want you to know that these feelings make sense. Anger often comes when we feel something is unfair or when our boundaries have been crossed. What happened that led to this feeling? I'm here to listen.`,
                        `${personalization}Anger is a natural response, and it's okay to feel it. The important thing is how we express it. Can you tell me more about what's making you feel this way? Sometimes talking through it helps us understand what we need.`
                    ],
                    default: [
                        `${personalization}Thank you for sharing that with me. I'm here to listen, and I want to understand what you're experiencing. Can you tell me more about what's on your mind? Sometimes the act of putting words to our thoughts helps us see them more clearly.`,
                        `${personalization}I appreciate you opening up. Your journey matters, and every step forward, no matter how small, is meaningful. What would be most helpful for you right now - would you like to explore what you're feeling, or would it help to focus on something specific?`,
                        `${personalization}I'm here with you, and I want to understand. Can you help me see what you're experiencing? Sometimes when we share our thoughts out loud, we discover things we didn't realize we were thinking.`
                    ]
                };

                const responseSet = responses[analysis.primary] || responses.default;
                let response = responseSet[Math.floor(Math.random() * responseSet.length)];

                // Add follow-up question based on needs
                if (analysis.needs.includes('coping')) {
                    response += ' Would it help to explore some coping strategies together?';
                } else if (analysis.needs.includes('understanding')) {
                    response += ' What do you think might be contributing to how you are feeling?';
                } else if (analysis.intensity > 0.8) {
                    response += ' This feels really intense for you right now. How can I best support you in this moment?';
                }

                return response;
            },

            // Journaling Guide Mode
            journalingMode: (message, analysis, history) => {
                if (history.length < 2) {
                    return "Welcome to your journaling space. I'm here to help you explore your thoughts and feelings. How are you feeling right now, in this moment? Take your time - there's no rush, and there are no wrong answers.";
                }

                const prompts = [
                    "That's a meaningful reflection. I'm wondering - what emotions are present as you think about this? Sometimes naming our feelings helps us understand them better.",
                    "Thank you for sharing that. Can you tell me more about what this experience means to you? What does it bring up for you?",
                    "I hear you. Let's go deeper - when you think about this, what do you notice in your body? Our bodies often hold wisdom about our emotions.",
                    "That's important. What would you like to understand better about this situation or feeling?",
                    "Thank you for being so open. As you reflect on this, what patterns do you notice? Sometimes seeing patterns helps us understand ourselves better."
                ];

                return prompts[Math.floor(Math.random() * prompts.length)];
            },

            // Daily Check-In Mode
            checkinMode: (message, analysis, history) => {
                const timeOfDay = new Date().getHours();
                const greeting = timeOfDay < 12 ? "Good morning" : timeOfDay < 18 ? "Good afternoon" : "Good evening";

                if (history.length < 2) {
                    return `${greeting}! I'm so glad you're here. How are you feeling today? Take a moment to check in with yourself - what's your mood, your energy level, what's on your mind?`;
                }

                return `Thank you for sharing that with me. ${analysis.primary === 'happy' ? "It's wonderful to hear you're feeling good today." : "I'm here with you in this."} What's one thing from today that stands out to you - something that went well, or something you'd like to process?`;
            },

            // Analytics Mode
            analyticsMode: (analysis) => {
                const memories = Deborah.getMemories();
                const patterns = memories.patterns || [];
                const emotionalHistory = memories.emotionalHistory || [];

                if (emotionalHistory.length < 3) {
                    return "I'm still learning about your patterns. As we continue our conversations, I'll be able to share insights about your emotional patterns, triggers, and progress. Keep checking in, and I'll help you see the bigger picture of your journey.";
                }

                const recentEmotions = emotionalHistory.slice(-7).map(e => e.primary);
                const mostCommon = recentEmotions.sort((a, b) =>
                    recentEmotions.filter(v => v === a).length - recentEmotions.filter(v => v === b).length
                ).pop();

                return `I've noticed some patterns in how you've been feeling. Over the past week, ${mostCommon} has been most present for you. This doesn't define you, but it might help you understand what you need. ${mostCommon === 'anxious' || mostCommon === 'stressed' ? "It seems like you might benefit from more grounding and self-care practices." : mostCommon === 'sad' ? "It might be helpful to explore what's contributing to these feelings and consider what support you need." : "This is valuable information about what's working for you."} What do you think about this pattern?`;
            },

            // Trauma-Safe Mode
            traumaSafeMode: (message, analysis) => {
                return `I'm here with you, and you're safe in this moment. Let's take things slowly. Can you feel your feet on the ground? Can you take three slow breaths with me? Your feelings are valid, and you don't have to share anything you're not ready to share. What would feel most supportive right now?`;
            },

            // Save memory with consent (user-specific)
            saveMemory: (key, value, userConsented = false) => {
                if (!userConsented) return false;
                const memories = Deborah.getMemories();
                if (!memories[key]) memories[key] = [];
                if (Array.isArray(memories[key])) {
                    if (!memories[key].includes(value)) {
                        memories[key].push(value);
                    }
                } else {
                    memories[key] = value;
                }
                storage.setUserData('memories', memories);
                return true;
            },

            // Update emotional history (user-specific)
            updateEmotionalHistory: (analysis) => {
                const memories = Deborah.getMemories();
                if (!memories.emotionalHistory) memories.emotionalHistory = [];
                memories.emotionalHistory.push({
                    emotion: analysis.primary,
                    intensity: analysis.intensity,
                    triggers: analysis.triggers,
                    timestamp: Date.now()
                });
                // Keep only last 30 entries
                if (memories.emotionalHistory.length > 30) {
                    memories.emotionalHistory = memories.emotionalHistory.slice(-30);
                }
                storage.setUserData('memories', memories);
            }
        };

        // Initialize Deborah greeting
        const getDeborahGreeting = () => {
            const timeOfDay = new Date().getHours();
            const greeting = timeOfDay < 12 ? "Good morning" : timeOfDay < 18 ? "Good afternoon" : "Good evening";
            return `${greeting}. I'm Deborah, and I'm here to support you on your journey of growth and emotional wellbeing. Like a butterfly emerging from its chrysalis, transformation takes time, patience, and care. How are you feeling today?`;
        };

        // AI Therapist Page Component - Enhanced with Advanced Deborah
        function AITherapistPage() {
            // ALL HOOKS MUST BE DECLARED AT THE TOP - BEFORE ANY CONDITIONAL LOGIC
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [authChecking, setAuthChecking] = useState(true);
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [activeTool, setActiveTool] = useState(null);
            const [currentMode, setCurrentMode] = useState('therapist');
            const [moodGlow, setMoodGlow] = useState('rgba(102, 126, 234, 0.3)');
            const messagesEndRef = useRef(null);
            const [chatLoaded, setChatLoaded] = useState(false);
            const [hasScrolled, setHasScrolled] = useState(false);

            // Helper function for scrolling
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            // Check Firebase authentication - MUST BE BEFORE CONDITIONAL RETURNS
            useEffect(() => {
                let unsubscribe = null;
                
                // Wait for Firebase to be ready
                const checkAuth = () => {
                    if (!window.firebaseAuth || !window.onAuthStateChanged) {
                        // If Firebase not ready yet, wait a bit and try again
                        if (!window.firebaseReady) {
                            setTimeout(checkAuth, 100);
                            return;
                        }
                        console.error('Firebase Auth not initialized');
                        setAuthChecking(false);
                        window.location.href = 'login.html';
                        return;
                    }

                    unsubscribe = window.onAuthStateChanged(window.firebaseAuth, user => {
                        console.log('AITherapistPage: Auth state changed', user ? 'User logged in' : 'No user');
                        setAuthChecking(false);
                        if (!user) {
                            // No user logged in  redirect to login page
                            window.location.href = 'login.html';
                        } else {
                            console.log('AITherapistPage: Setting authenticated to true');
                            setIsAuthenticated(true);
                        }
                    });
                };

                // Check immediately or wait for Firebase ready event
                if (window.firebaseReady) {
                    checkAuth();
                } else {
                    window.addEventListener('firebaseReady', checkAuth, { once: true });
                    // Fallback timeout
                    setTimeout(() => {
                        if (authChecking) checkAuth();
                    }, 2000);
                }

                return () => {
                    if (unsubscribe) unsubscribe();
                };
            }, []);

            // Load chat history from Firestore - MUST BE BEFORE CONDITIONAL RETURNS
            useEffect(() => {
                if (!isAuthenticated) {
                    setMessages([{ text: getDeborahGreeting(), sender: 'deborah', timestamp: Date.now() }]);
                    setChatLoaded(true);
                    return;
                }

                const loadChat = () => {
                    const user = window.firebaseAuth?.currentUser;
                    if (!user || !window.firestore) {
                        setMessages([{ text: getDeborahGreeting(), sender: 'deborah', timestamp: Date.now() }]);
                        setChatLoaded(true);
                        return;
                    }

                    try {
                        const { collection, query, where, orderBy, onSnapshot } = window.firestore;
                        const chatsRef = collection(window.firebaseDb, 'aiChats');
                        const q = query(chatsRef, where('userId', '==', user.uid), orderBy('date', 'asc'));

                        // Real-time listener
                        const unsubscribe = onSnapshot(q, (snapshot) => {
                            const chatMessages = [];
                            snapshot.forEach((doc) => {
                                const data = doc.data();
                                chatMessages.push({
                                    id: doc.id,
                                    text: data.text || data.message,
                                    sender: data.sender,
                                    timestamp: data.timestamp || (data.date?.toDate ? data.date.toDate().getTime() : new Date(data.date).getTime())
                                });
                            });
                            
                            // Add greeting if no messages
                            if (chatMessages.length === 0) {
                                chatMessages.push({ text: getDeborahGreeting(), sender: 'deborah', timestamp: Date.now() });
                            }
                            
                            setMessages(chatMessages);
                            setChatLoaded(true);
                            // Don't auto-scroll on initial load - only scroll when user sends messages
                        }, (error) => {
                            console.error('Error loading chat:', error);
                            // If error, try without orderBy as fallback
                            try {
                                const chatsRef = collection(window.firebaseDb, 'chatMessages');
                                const q2 = queryFn(chatsRef, where('user_id', '==', user.uid));
                                onSnapshot(q2, (snapshot) => {
                                    const chatMessages = [];
                                    snapshot.forEach((doc) => {
                                        const data = doc.data();
                                        chatMessages.push({
                                            id: doc.id,
                                            text: data.text || data.message,
                                            sender: data.sender,
                                            timestamp: data.timestamp || (data.date?.toDate ? data.date.toDate().getTime() : new Date(data.date).getTime())
                                        });
                                    });
                                    chatMessages.sort((a, b) => a.timestamp - b.timestamp);
                                    if (chatMessages.length === 0) {
                                        chatMessages.push({ text: getDeborahGreeting(), sender: 'deborah', timestamp: Date.now() });
                                    }
                                    setMessages(chatMessages);
                                    setChatLoaded(true);
                                });
                            } catch (fallbackError) {
                                console.error('Fallback query also failed:', fallbackError);
                                setMessages([{ text: getDeborahGreeting(), sender: 'deborah', timestamp: Date.now() }]);
                                setChatLoaded(true);
                            }
                        });

                        return () => unsubscribe();
                    } catch (error) {
                        console.error('Error setting up chat listener:', error);
                        setMessages([{ text: getDeborahGreeting(), sender: 'deborah', timestamp: Date.now() }]);
                        setChatLoaded(true);
                    }
                };

                if (window.firebaseReady) {
                    return loadChat();
                } else {
                    window.addEventListener('firebaseReady', loadChat, { once: true });
                }
            }, [isAuthenticated]);

            // Scroll effect - ONLY scroll when new messages are added, not on initial load
            useEffect(() => {
                // Only auto-scroll if user has already interacted (sent a message)
                // Don't scroll on initial page load
                if (chatLoaded && hasScrolled && messages.length > 0) {
                    scrollToBottom();
                }
            }, [messages, chatLoaded, hasScrolled]);

            // NOW WE CAN DO CONDITIONAL RETURNS - ALL HOOKS ARE ABOVE
            // Show loading state while checking auth
            if (authChecking) {
                return React.createElement('div', { 
                    className: 'min-h-screen flex items-center justify-center' 
                }, 
                    React.createElement('div', { className: 'text-center' },
                        React.createElement('div', { className: 'animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4' }),
                        React.createElement('p', { className: 'text-gray-600' }, 'Loading...')
                    )
                );
            }

            // Debug logging
            console.log('AITherapistPage render:', { isAuthenticated, authChecking });

            if (!isAuthenticated) {
                console.log('AITherapistPage: Not authenticated, returning null');
                return null; // Don't render until auth is confirmed
            }

            console.log('AITherapistPage: Authenticated, rendering content');

            const handleSend = async () => {
                if (!input.trim()) return;

                const user = window.firebaseAuth?.currentUser;
                if (!user || !window.firestore) {
                    alert('Please log in to chat with Deborah');
                    return;
                }

                const userMessage = {
                    text: input,
                    sender: 'user',
                    timestamp: Date.now()
                };

                // Save user message to Supabase
                try {
                    if (window.SupabaseClient) {
                        await window.SupabaseClient.createChatMessage({
                            text: input,
                            sender: 'user',
                            timestamp: Date.now()
                        });
                    } else {
                        // Fallback to compatibility layer
                        const { collection, addDoc, Timestamp } = window.firestore;
                        await addDoc(collection(window.firebaseDb, 'chatMessages'), {
                            user_id: user.uid,
                            text: input,
                            sender: 'user',
                            timestamp: Date.now()
                        });
                    }
                } catch (error) {
                    console.error('Error saving message:', error);
                }

                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setIsTyping(true);

                // Check for crisis keywords
                if (CrisisResources.detectCrisisKeywords(input)) {
                    // Trigger crisis resources panel
                    setTimeout(() => {
                        const crisisButton = document.querySelector('.crisis-button');
                        if (crisisButton) {
                            crisisButton.click();
                        }
                    }, 500);
                    // Switch to trauma-safe mode
                    setCurrentMode('trauma-safe');
                }

                // Analyze emotion and update glow
                const analysis = Deborah.analyzeEmotion(input, messages);
                const glowColors = {
                    sad: 'rgba(59, 130, 246, 0.3)',
                    anxious: 'rgba(239, 68, 68, 0.3)',
                    happy: 'rgba(34, 197, 94, 0.3)',
                    stressed: 'rgba(245, 158, 11, 0.3)',
                    angry: 'rgba(220, 38, 38, 0.3)',
                    default: 'rgba(102, 126, 234, 0.3)'
                };
                setMoodGlow(glowColors[analysis.primary] || glowColors.default);

                // Update emotional history
                Deborah.updateEmotionalHistory(analysis);

                // Auto-switch to trauma-safe mode if high intensity negative emotion
                if ((analysis.primary === 'sad' || analysis.primary === 'anxious' || analysis.primary === 'angry') && analysis.intensity > 0.85) {
                    setCurrentMode('trauma-safe');
                }

                // Generate response with delay for natural conversation flow
                setTimeout(async () => {
                    const response = Deborah.generateResponse(input, messages, currentMode);
                    const deborahMessage = {
                        text: response,
                        sender: 'deborah',
                        timestamp: Date.now()
                    };
                    
                    // Save Deborah's response to Supabase
                    try {
                        if (window.SupabaseClient) {
                            await window.SupabaseClient.createChatMessage({
                                text: response,
                                sender: 'deborah',
                                timestamp: Date.now()
                            });
                        } else {
                            // Fallback to compatibility layer
                            const { collection, addDoc, Timestamp } = window.firestore;
                            await addDoc(collection(window.firebaseDb, 'chatMessages'), {
                                user_id: user.uid,
                                text: response,
                                sender: 'deborah',
                                timestamp: Date.now()
                            });
                        }
                    } catch (error) {
                        console.error('Error saving Deborah response:', error);
                    }
                    
                    setMessages(prev => [...prev, deborahMessage]);
                    setIsTyping(false);
                    // Scroll to bottom after Deborah's response
                    setTimeout(() => scrollToBottom(), 100);
                }, 1800 + Math.random() * 500); // Variable delay for natural feel
            };

            const sidebarTools = [
                { id: 'emotion-scanner', name: 'Emotion Scanner', icon: 'heart' },
                { id: 'thought-reframer', name: 'Thought Reframer', icon: 'lightbulb' },
                { id: 'coping-strategies', name: 'Coping Strategies', icon: 'shield-alt' },
                { id: 'daily-reflection', name: 'Daily Reflection', icon: 'sun' },
                { id: 'grounding', name: 'Quick Grounding', icon: 'anchor' },
                { id: 'emotions-summary', name: 'Emotions Summary', icon: 'chart-line' }
            ];

            const modes = [
                { id: 'therapist', name: 'Therapist Mode', icon: 'comments', description: 'Deep emotional support and guidance' },
                { id: 'journaling', name: 'Journaling Guide', icon: 'book', description: 'Reflective writing support' },
                { id: 'checkin', name: 'Daily Check-In', icon: 'sun', description: 'Quick emotional check-in' },
                { id: 'analytics', name: 'Analytics', icon: 'chart-line', description: 'Pattern insights and trends' },
                { id: 'trauma-safe', name: 'Trauma-Safe Mode', icon: 'shield-alt', description: 'Gentle, grounding support' }
            ];

            return React.createElement('div', {
                className: 'min-h-screen p-8',
                style: {
                    background: `radial-gradient(circle at center, ${moodGlow}, transparent 70%)`,
                    transition: 'background 1s ease'
                }
            },
                React.createElement('div', { className: 'max-w-7xl mx-auto' },
                    React.createElement('div', { className: 'grid grid-cols-1 lg:grid-cols-4 gap-6' },
                        // Sidebar Tools
                        React.createElement('div', { className: 'lg:col-span-1 space-y-4' },
                            React.createElement('div', { className: 'glass-card p-6' },
                                React.createElement('h3', { className: 'text-xl font-bold mb-4' }, 'Tools & Insights'),
                                React.createElement('div', { className: 'space-y-2' },
                                    sidebarTools.map(tool =>
                            React.createElement('button', {
                                            key: tool.id,
                                            onClick: () => setActiveTool(activeTool === tool.id ? null : tool.id),
                                            className: `w-full text-left p-3 rounded-lg transition-all ${activeTool === tool.id ? 'bg-purple-100 border-2 border-purple-500' : 'hover:bg-gray-50'}`,
                                        },
                                            React.createElement('i', { className: `fas fa-${tool.icon} mr-2` }),
                                            tool.name
                                    )
                                )
                            )
                        ),

                            React.createElement('div', { className: 'glass-card p-6' },
                                React.createElement('h3', { className: 'text-lg font-bold mb-3' }, 'Recent Emotions'),
                                React.createElement('div', { className: 'space-y-2 text-sm' },
                                    (auth.getCurrentUser() ? storage.getUserData('moods', []) : []).slice(0, 5).map((entry, i) =>
                                        React.createElement('div', { key: i, className: 'flex items-center justify-between' },
                                            React.createElement('span', null, new Date(entry.date).toLocaleDateString()),
                                            React.createElement('span', { className: 'text-2xl' }, ['', '', '', '', ''][entry.mood])
                                        )
                                    )
                                )
                            )
                        ),

                        // Chat Panel
                        React.createElement('div', { className: 'lg:col-span-3' },
                            React.createElement('div', { className: 'glass-card p-6 h-[calc(100vh-200px)] flex flex-col' },
                                React.createElement('div', { className: 'flex items-center justify-between mb-6' },
                                    React.createElement('div', { className: 'flex items-center gap-3' },
                                        React.createElement('div', { className: 'w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white text-xl' }, ''),
                                        React.createElement('div', null,
                                            React.createElement('h2', { className: 'text-2xl font-bold' }, 'Deborah'),
                                            React.createElement('p', { className: 'text-sm text-gray-600' }, 'Your AI Wellness Companion')
                                        )
                                    ),
                                    React.createElement('div', { className: 'flex gap-2' },
                                        modes.map(mode =>
                        React.createElement('button', {
                                                key: mode.id,
                                                onClick: () => setCurrentMode(mode.id),
                                                className: `px-3 py-1 rounded-lg text-xs font-semibold transition-all ${currentMode === mode.id ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`,
                                                title: mode.description
                                            },
                                                React.createElement('i', { className: `fas fa-${mode.icon} mr-1` }),
                                                mode.name
                                            )
                                        )
                                    )
                                ),

                                React.createElement('div', { className: 'flex-1 overflow-y-auto mb-4 space-y-4' },
                                    messages.map((msg, idx) =>
                                React.createElement('div', {
                                            key: idx,
                                            className: `flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`
                                        },
                                            React.createElement('div', {
                                                className: `chat-message ${msg.sender === 'user' ? 'user-message' : 'bot-message'}`
                                            }, msg.text)
                                        )
                                    ),
                                    isTyping && React.createElement('div', { className: 'flex justify-start' },
                                        React.createElement('div', { className: 'chat-message bot-message' },
                                            React.createElement('div', { className: 'flex gap-1' },
                                                [0, 1, 2].map(i =>
                                                    React.createElement('div', {
                                                        key: i,
                                                        className: 'w-2 h-2 bg-gray-400 rounded-full animate-bounce',
                                                        style: { animationDelay: `${i * 0.2}s` }
                                                    })
                                )
                            )
                        )
                ),
                                    React.createElement('div', { ref: messagesEndRef })
                                ),

                                React.createElement('div', { className: 'flex gap-2' },
                            React.createElement('input', {
                                type: 'text',
                                        value: input,
                                        onChange: (e) => setInput(e.target.value),
                                        onKeyPress: (e) => e.key === 'Enter' && handleSend(),
                                        placeholder: 'Type your message...',
                                        className: 'flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500'
                                    }),
                                    React.createElement('button', {
                                        onClick: handleSend,
                                        className: 'btn-primary px-6'
                                    }, 'Send')
                                )
                            )
                        )
                    )
                )
            );
        }

        // Continue with more components... (This is getting very long, so I'll continue in the next part)
        
        // For now, let me create a comprehensive structure that includes all major components
        // I'll need to continue building this systematically

        // Main App Component
        function App() {
            const [currentPage, setCurrentPage] = useState('home');
            const [articleId, setArticleId] = useState(null);
            const [articleData, setArticleData] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
            const [settingsOpen, setSettingsOpen] = useState(false);
            const [safeSpaceOpen, setSafeSpaceOpen] = useState(false);
            const [safeSpaceTheme, setSafeSpaceTheme] = useState('starlit');
            const [currentUser, setCurrentUser] = useState(null);
            const [firebaseReady, setFirebaseReady] = useState(false);
            const [authLoading, setAuthLoading] = useState(true);
            const [showCheckInModal, setShowCheckInModal] = useState(false);
            const [checkInType, setCheckInType] = useState(null);

            // Listen to Firebase auth state changes
            useEffect(() => {
                const setupAuthListener = () => {
                    if (window.firebaseAuth && window.onAuthStateChanged) {
                        setFirebaseReady(true);
                        
                        // Listen to auth state changes
                        const unsubscribe = window.onAuthStateChanged(window.firebaseAuth, (firebaseUser) => {
                            setAuthLoading(false); // Auth check complete
                            if (firebaseUser) {
                                // User is logged in - sync to localStorage and state
                                const userData = {
                                    id: firebaseUser.uid,
                                    email: firebaseUser.email,
                                    name: firebaseUser.displayName || firebaseUser.email?.split('@')[0] || 'User',
                                    role: firebaseUser.email === 'admin@example.com' ? 'admin' : 'user' // You can customize this
                                };
                                storage.set('bloomly_current_user', userData);
                                setCurrentUser(userData);
                                
                                // Check if we should show daily check-in modal
                                setTimeout(() => {
                                    if (DailyCheckIn.shouldShowCheckIn()) {
                                        const timeOfDay = DailyCheckIn.getTimeOfDay();
                                        setCheckInType(timeOfDay);
                                        setShowCheckInModal(true);
                                    }
                                }, 1000); // Small delay to ensure UI is ready
                            } else {
                                // User is logged out
                                storage.set('bloomly_current_user', null);
                                setCurrentUser(null);
                                setShowCheckInModal(false);
                                setCheckInType(null);
                            }
                        });
                        
                        return unsubscribe;
                    }
                    return null;
                };

                // Check if Firebase is already ready
                if (window.firebaseReady && window.firebaseAuth) {
                    const unsubscribe = setupAuthListener();
                    return () => {
                        if (unsubscribe) unsubscribe();
                    };
                } else {
                    // Wait for Firebase to be ready
                    const handleFirebaseReady = () => {
                        const unsubscribe = setupAuthListener();
                        if (unsubscribe) {
                            window.removeEventListener('firebaseReady', handleFirebaseReady);
                        }
                    };
                    
                    window.addEventListener('firebaseReady', handleFirebaseReady);
                    
                    // Also try immediately in case Firebase is already ready
                    const unsubscribe = setupAuthListener();
                    
                    return () => {
                        window.removeEventListener('firebaseReady', handleFirebaseReady);
                        if (unsubscribe) unsubscribe();
                    };
                }
            }, []);

            // Check authentication on mount and page changes
            useEffect(() => {
                if (!firebaseReady || authLoading) return; // Wait for Firebase to be ready and auth check to complete

                // Check if page requires authentication
                if (protectedPages.includes(currentPage) && !currentUser) {
                    window.location.href = 'login.html';
                    return;
                }

                // Check if page requires admin
                if (currentPage === 'articles' && currentUser?.role !== 'admin' && !['home', 'about', 'privacy', 'terms'].includes(currentPage)) {
                    // Allow viewing articles, but publishing requires admin (handled in component)
                }
            }, [currentPage, currentUser, firebaseReady, authLoading]);

            // Apply contrast adjustments on mount and when page changes
            useEffect(() => {
                const settings = storage.get('bloomly_settings', defaultSettings);
                if (settings.theme === 'dark') {
                    applyThemeContrast();
                }
            }, [currentPage]);

            return React.createElement(React.Fragment, null,
                React.createElement(ParticleSystem),
                React.createElement(AppHeader, {
                    onToggleSidebar: () => setSidebarOpen(!sidebarOpen),
                    sidebarOpen: sidebarOpen
                }),

                React.createElement(MobileBottomNav, {
                    currentPage: currentPage,
                    onNavigate: (page) => {
                        setCurrentPage(page);
                        setSidebarOpen(false);
                    },
                    currentUser: currentUser
                }),

                React.createElement(Sidebar, {
                    isOpen: sidebarOpen,
                    currentPage: currentPage,
                    onNavigate: (page) => {
                        setCurrentPage(page);
                        setSidebarOpen(false);
                    },
                    onToggle: () => setSidebarOpen(!sidebarOpen),
                    onSettingsOpen: () => {
                        setSettingsOpen(true);
                        setSidebarOpen(false);
                    },
                    onSafeSpaceOpen: () => {
                        setSafeSpaceOpen(true);
                        setSidebarOpen(false);
                    },
                    currentUser: currentUser
                }),
                
                React.createElement('div', {
                    className: 'main-content'
                },
                    React.createElement(PageRouter, {
                        currentPage: currentPage,
                        onNavigate: (page, id, data) => {
                            if (page === 'article-detail' && id) {
                                setArticleId(id);
                                setArticleData(data || null);
                                setCurrentPage('article-detail');
                            } else {
                                setArticleId(null);
                                setArticleData(null);
                                setCurrentPage(page);
                            }
                        },
                        articleId: articleId,
                        articleData: articleData
                    })
                ),
                
                React.createElement(Settings, {
                    isOpen: settingsOpen,
                    onClose: () => setSettingsOpen(false)
                }),
                
                React.createElement(CrisisResourcesComponent),
                
                React.createElement(DailyCheckInModal, {
                    isOpen: showCheckInModal,
                    onClose: () => {
                        setShowCheckInModal(false);
                        setCheckInType(null);
                    },
                    type: checkInType
                }),
                
                React.createElement(SafeSpaceRoom, {
                    isOpen: safeSpaceOpen,
                    theme: safeSpaceTheme,
                    onClose: () => setSafeSpaceOpen(false),
                    onThemeChange: setSafeSpaceTheme
                }),

                React.createElement(Footer, {
                    onNavigate: setCurrentPage
                })
            );
        }

        // Footer Component
        function Footer({ onNavigate }) {
            return React.createElement('footer', {
                className: 'bg-gradient-to-r from-gray-800 to-gray-900 text-white py-12 mt-16'
            },
                React.createElement('div', { className: 'max-w-7xl mx-auto px-8' },
                    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-8 mb-8' },
                        React.createElement('div', null,
                            React.createElement('h3', { className: 'butterfly-logo text-2xl font-bold mb-4 text-white' }, 'Bloomly'),
                            React.createElement('p', { className: 'text-gray-300' }, 'Grow emotionally, one moment at a time. Your journey to mental wellness starts here.')
                        ),
                        React.createElement('div', null,
                            React.createElement('h4', { className: 'font-semibold mb-4' }, 'Quick Links'),
                            React.createElement('ul', { className: 'space-y-2' },
                                ['Home', 'Talk to Deborah', 'Journal', 'Mood Tracker'].map(link =>
                                    React.createElement('li', { key: link },
                                        React.createElement('button', {
                                            onClick: () => onNavigate(link.toLowerCase().replace(' ', '-').replace('talk-to-deborah', 'deborah').replace('mood-tracker', 'mood')),
                                            className: 'text-gray-300 hover:text-white transition-colors'
                                        }, link)
                                    )
                                )
                            )
                        ),
                        React.createElement('div', null,
                            React.createElement('h4', { className: 'font-semibold mb-4' }, 'Resources'),
                            React.createElement('ul', { className: 'space-y-2' },
                                ['Breathing Exercises', 'Guided Exercises', 'Safe Space', 'Soundscapes'].map(link =>
                                    React.createElement('li', { key: link },
                                        React.createElement('button', {
                                            onClick: () => onNavigate(link.toLowerCase().replace(' ', '-')),
                                            className: 'text-gray-300 hover:text-white transition-colors'
                                        }, link)
                                    )
                                )
                            )
                        ),
                        React.createElement('div', null,
                            React.createElement('h4', { className: 'font-semibold mb-4' }, 'Legal'),
                            React.createElement('ul', { className: 'space-y-2' },
                                React.createElement('li', null,
                                React.createElement('button', {
                                        onClick: () => onNavigate('about'),
                                        className: 'text-gray-300 hover:text-white transition-colors'
                                    }, 'About')
                                ),
                                React.createElement('li', null,
                                React.createElement('button', {
                                        onClick: () => onNavigate('privacy'),
                                        className: 'text-gray-300 hover:text-white transition-colors'
                                    }, 'Privacy Policy')
                                ),
                                React.createElement('li', null,
                                    React.createElement('button', {
                                        onClick: () => onNavigate('terms'),
                                        className: 'text-gray-300 hover:text-white transition-colors'
                                    }, 'Terms of Service')
                                )
                            )
                        )
                    ),
                    React.createElement('div', { className: 'border-t border-gray-700 pt-8 text-center text-gray-400' },
                        React.createElement('p', null, ' 2024 Bloomly. All rights reserved. Built with care for your mental wellness.')
                    )
                )
            );
        }

        // About Page
        function AboutPage({ onNavigate }) {
            return React.createElement('div', { className: 'min-h-screen p-8' },
                React.createElement('div', { className: 'max-w-4xl mx-auto' },
                    React.createElement('div', { className: 'glass-card p-8 mb-8' },
                        React.createElement('h1', { className: 'text-4xl font-bold mb-6' }, 'About Bloomly'),
                        React.createElement('div', { className: 'prose max-w-none' },
                            React.createElement('p', { className: 'text-lg mb-4' },
                                'Bloomly is a comprehensive mental wellness platform designed to support your emotional journey. Like a butterfly emerging from its chrysalis, we believe in the power of transformation, growth, and self-discovery.'
                            ),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'Our Mission'),
                            React.createElement('p', { className: 'mb-4' },
                                'Our mission is to provide accessible, compassionate, and effective tools for mental wellness. We combine cutting-edge AI technology with evidence-based therapeutic approaches to create a supportive environment for emotional growth.'
                            ),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'Meet Deborah'),
                            React.createElement('p', { className: 'mb-4' },
                                'Deborah is your AI wellness companion, designed with emotional intelligence and deep understanding. She adapts to your needs, learns from your journey, and provides personalized support whenever you need it.'
                            ),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'Our Features'),
                            React.createElement('ul', { className: 'list-disc pl-6 space-y-2 mb-4' },
                                ['AI-powered emotional support with Deborah', 'Personal journaling with mood tracking', 'Guided breathing and mindfulness exercises', 'Safe space for reflection and expression', 'Ambient soundscapes for relaxation', 'Progress tracking and insights'].map(feature =>
                                    React.createElement('li', { key: feature }, feature)
                                )
                            ),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'Your Privacy Matters'),
                            React.createElement('p', { className: 'mb-4' },
                                'We are committed to protecting your privacy. All your data is stored locally on your device, and you have full control over your information. Your journey is yours alone, and we respect that.'
                            )
                        )
                    )
                )
            );
        }

        // Privacy Page
        function PrivacyPage({ onNavigate }) {
            return React.createElement('div', { className: 'min-h-screen p-8' },
                React.createElement('div', { className: 'max-w-4xl mx-auto' },
                    React.createElement('div', { className: 'glass-card p-8 mb-8' },
                        React.createElement('h1', { className: 'text-4xl font-bold mb-6' }, 'Privacy Policy'),
                        React.createElement('div', { className: 'prose max-w-none' },
                            React.createElement('p', { className: 'text-sm text-gray-600 mb-6' }, 'Last updated: ' + new Date().toLocaleDateString()),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'Data Storage'),
                            React.createElement('p', { className: 'mb-4' },
                                'Bloomly stores all your data locally on your device using browser localStorage. This means your journal entries, mood tracking data, conversation history, and preferences remain on your device and are not transmitted to any external servers.'
                            ),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'What We Store'),
                            React.createElement('p', { className: 'mb-4' },
                                'We store the following information locally on your device:'
                            ),
                            React.createElement('ul', { className: 'list-disc pl-6 space-y-2 mb-4' },
                                ['Journal entries and notes', 'Mood tracking history', 'Conversation history with Deborah', 'Completed exercises and progress', 'Theme and preference settings', 'Article likes and comments'].map(item =>
                                    React.createElement('li', { key: item }, item)
                                )
                            ),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'Data Security'),
                            React.createElement('p', { className: 'mb-4' },
                                'Since all data is stored locally, it is protected by your browser\'s security measures. We do not collect, transmit, or share any personal information with third parties.'
                            ),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'Your Rights'),
                            React.createElement('p', { className: 'mb-4' },
                                'You have complete control over your data. You can delete any entries, clear your conversation history, or reset all data at any time through the Settings page.'
                            ),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'Contact'),
                            React.createElement('p', { className: 'mb-4' },
                                'If you have any questions about this Privacy Policy, please contact us through the platform.'
                            )
                        )
                    )
                )
            );
        }

        // Terms Page
        function TermsPage({ onNavigate }) {
            return React.createElement('div', { className: 'min-h-screen p-8' },
                React.createElement('div', { className: 'max-w-4xl mx-auto' },
                    React.createElement('div', { className: 'glass-card p-8 mb-8' },
                        React.createElement('h1', { className: 'text-4xl font-bold mb-6' }, 'Terms of Service'),
                        React.createElement('div', { className: 'prose max-w-none' },
                            React.createElement('p', { className: 'text-sm text-gray-600 mb-6' }, 'Last updated: ' + new Date().toLocaleDateString()),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'Acceptance of Terms'),
                            React.createElement('p', { className: 'mb-4' },
                                'By using Bloomly, you agree to these Terms of Service. If you do not agree, please do not use the platform.'
                            ),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'Use of Service'),
                            React.createElement('p', { className: 'mb-4' },
                                'Bloomly is provided for personal mental wellness support. The platform is designed to complement, not replace, professional mental health care. If you are experiencing a mental health emergency, please contact emergency services immediately.'
                            ),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'AI Assistant Disclaimer'),
                            React.createElement('p', { className: 'mb-4' },
                                'Deborah, our AI wellness companion, provides supportive guidance but is not a replacement for professional therapy or medical advice. Always consult with qualified healthcare professionals for serious mental health concerns.'
                            ),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'User Responsibilities'),
                            React.createElement('p', { className: 'mb-4' },
                                'You are responsible for maintaining the confidentiality of your data and for all activities that occur using your device. Please keep your device secure.'
                            ),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'Limitation of Liability'),
                            React.createElement('p', { className: 'mb-4' },
                                'Bloomly is provided "as is" without warranties of any kind. We are not liable for any damages arising from your use of the platform.'
                            ),
                            React.createElement('h2', { className: 'text-2xl font-bold mt-8 mb-4' }, 'Changes to Terms'),
                            React.createElement('p', { className: 'mb-4' },
                                'We reserve the right to modify these terms at any time. Continued use of the platform constitutes acceptance of any changes.'
                            )
                        )
                    )
                )
            );
        }

        // Header Component
        function AppHeader({ onToggleSidebar, sidebarOpen }) {
            return React.createElement('header', { className: 'app-header' },
                React.createElement('button', {
                    onClick: onToggleSidebar,
                    className: 'hamburger-menu',
                    'aria-label': 'Toggle menu'
                },
                    React.createElement('span', null),
                    React.createElement('span', null),
                    React.createElement('span', null)
                ),
                React.createElement('h1', { className: 'header-logo' }, 'Bloomly')
            );
        }

        // Sidebar Component with Authentication
        function Sidebar({ isOpen, currentPage, onNavigate, onToggle, onSettingsOpen, onSafeSpaceOpen, currentUser }) {
            const navItems = [
                { key: 'home', label: 'Home', icon: 'home', public: true },
                { key: 'deborah', label: 'Talk to Deborah', icon: 'comments', public: false },
                { key: 'journal', label: 'Journal', icon: 'book', public: false },
                { key: 'mood', label: 'Mood Tracking', icon: 'smile', public: false },
                { key: 'habits', label: 'Habits', icon: 'check-circle', public: false },
                { key: 'sleep', label: 'Sleep Tracker', icon: 'moon', public: false },
                { key: 'goals', label: 'Goals', icon: 'bullseye', public: false },
                { key: 'breathing', label: 'Breathing', icon: 'wind', public: true },
                { key: 'exercises', label: 'Guided Exercises', icon: 'spa', public: true },
                { key: 'safe-space', label: 'Safe Space', icon: 'moon', public: true },
                { key: 'sounds', label: 'Soundscapes', icon: 'music', public: true },
                { key: 'progress', label: 'Progress', icon: 'chart-line', public: false },
                { key: 'articles', label: 'Articles', icon: 'newspaper', public: true },
                { key: 'settings', label: 'Settings', icon: 'cog', public: true }
            ];

            // Filter nav items based on authentication
            const visibleItems = navItems.filter(item => item.public || currentUser);

            return React.createElement(React.Fragment, null,
                React.createElement('div', {
                    className: `sidebar-overlay ${isOpen ? 'active' : ''}`,
                    onClick: onToggle
                }),
                React.createElement('div', {
                    className: `sidebar ${isOpen ? 'open' : ''}`
                },
                    React.createElement('nav', { className: 'flex-1 p-4' },
                        visibleItems.map(item =>
                            React.createElement('button', {
                                key: item.key,
                                onClick: () => {
                                    if (!item.public && !currentUser) {
                                        window.location.href = 'login.html';
                                        return;
                                    }
                                    if (item.key === 'settings') onSettingsOpen();
                                    else if (item.key === 'safe-space') onSafeSpaceOpen();
                                    else onNavigate(item.key);
                                    onToggle(); // Close sidebar after navigation
                                },
                                className: `sidebar-item w-full text-left text-white ${currentPage === item.key ? 'active' : ''}`
                            },
                                React.createElement('i', { className: `fas fa-${item.icon} mr-3` }),
                                React.createElement('span', null, item.label)
                            )
                        )
                    ),

                    React.createElement('div', { className: 'p-4 border-t border-white border-opacity-20' },
                    currentUser ? 
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('div', { className: 'text-white text-sm opacity-80 mb-2' },
                                React.createElement('p', { className: 'font-semibold' }, currentUser.name || currentUser.email),
                                currentUser.role === 'admin' && React.createElement('span', { className: 'text-xs bg-yellow-500 px-2 py-1 rounded' }, 'Admin')
                            ),
                            React.createElement('button', {
                                onClick: () => auth.logout(),
                                className: 'sidebar-item w-full text-left text-white text-sm'
                            },
                                React.createElement('i', { className: 'fas fa-sign-out-alt mr-3' }),
                                'Logout'
                            )
                        ) :
                        React.createElement('button', {
                            onClick: () => window.location.href = 'login.html',
                            className: 'sidebar-item w-full text-left text-white'
                        },
                            React.createElement('i', { className: 'fas fa-sign-in-alt mr-3' }),
                            'Login'
                        )
                    )
                )
            );
        }

        // ========== UNIVERSAL SEARCH BAR COMPONENT ==========
        function UniversalSearchBar({ placeholder = "Search...", onSearch, value, onChange }) {
            return React.createElement('div', { className: 'universal-search-bar' },
                React.createElement('input', {
                    type: 'text',
                    placeholder: placeholder,
                    value: value || '',
                    onChange: (e) => onChange && onChange(e.target.value),
                    onKeyPress: (e) => {
                        if (e.key === 'Enter' && onSearch) {
                            onSearch(e.target.value);
                        }
                    }
                }),
                React.createElement('i', { className: 'fas fa-search search-icon' })
            );
        }

        // ========== MOBILE BOTTOM NAVIGATION ==========
        function MobileBottomNav({ currentPage, onNavigate, currentUser }) {
            if (window.innerWidth > 768) return null;

            const navItems = [
                { key: 'home', icon: 'home', label: 'Home' },
                { key: 'journal', icon: 'book', label: 'Journal', requiresAuth: true },
                { key: 'mood', icon: 'smile', label: 'Mood', requiresAuth: true },
                { key: 'deborah', icon: 'comments', label: 'Deborah', requiresAuth: true },
                { key: 'articles', icon: 'newspaper', label: 'Articles' }
            ];

            return React.createElement('div', { className: 'mobile-bottom-nav' },
                navItems.map(item => {
                    if (item.requiresAuth && !currentUser) return null;
                    return React.createElement('button', {
                        key: item.key,
                        onClick: () => onNavigate(item.key),
                        className: `mobile-nav-item ${currentPage === item.key ? 'active' : ''}`
                    },
                        React.createElement('i', { className: `fas fa-${item.icon}` }),
                        React.createElement('span', null, item.label)
                    );
                })
            );
        }

        // ========== ARTICLE DETAIL PAGE ==========
        function ArticleDetailPage({ articleId, articleData, onNavigate }) {
            const [article, setArticle] = useState(articleData || null);
            const [comment, setComment] = useState('');
            const [replyTo, setReplyTo] = useState(null);
            const [loading, setLoading] = useState(!articleData);

            useEffect(() => {
                // If article data is provided, use it immediately (no loading needed)
                if (articleData) {
                    setArticle(articleData);
                    setLoading(false);
                    // Increment view count in background
                    if (articleData.id && window.firestore) {
                        const { doc, updateDoc, getDoc } = window.firestore;
                        const articleRef = doc(window.firebaseDb, 'articles', articleData.id);
                        getDoc(articleRef).then(articleSnap => {
                            if (articleSnap.exists()) {
                                const currentViews = articleSnap.data().views || 0;
                                updateDoc(articleRef, { views: currentViews + 1 });
                            }
                        }).catch(err => console.error('Error updating views:', err));
                    }
                    return;
                }

                // Fallback: fetch from Firestore if data not provided
                if (!articleId || !window.firestore) {
                    setLoading(false);
                    return;
                }

                const loadArticle = async () => {
                    try {
                        const { doc, getDoc } = window.firestore;
                        const articleRef = doc(window.firebaseDb, 'articles', articleId);
                        const articleSnap = await getDoc(articleRef);
                        
                        if (articleSnap.exists()) {
                            const data = articleSnap.data();
                            const loadedArticle = {
                                id: articleSnap.id,
                                title: data.title,
                                content: data.content,
                                author: data.author || 'Admin',
                                date: data.date?.toDate ? data.date.toDate().toISOString() : data.date,
                                likes: data.likes || 0,
                                views: data.views || 0,
                                comments: data.comments || []
                            };
                            setArticle(loadedArticle);

                            // Increment view count
                            const { updateDoc } = window.firestore;
                            const currentViews = data.views || 0;
                            await updateDoc(articleRef, { views: currentViews + 1 });
                        } else {
                            setArticle(null);
                        }
                    } catch (error) {
                        console.error('Error loading article:', error);
                        setArticle(null);
                    } finally {
                        setLoading(false);
                    }
                };

                if (window.firebaseReady) {
                    loadArticle();
                } else {
                    window.addEventListener('firebaseReady', loadArticle, { once: true });
                }
            }, [articleId, articleData]);

            const likeArticle = async () => {
                if (!article || !window.firestore) return;
                
                try {
                    const { doc, updateDoc, getDoc } = window.firestore;
                    const articleRef = doc(window.firebaseDb, 'articles', article.id);
                    const articleSnap = await getDoc(articleRef);
                    if (articleSnap.exists()) {
                        const currentLikes = articleSnap.data().likes || 0;
                        await updateDoc(articleRef, { likes: currentLikes + 1 });
                        setArticle({ ...article, likes: currentLikes + 1 });
                    }
                } catch (error) {
                    console.error('Error liking article:', error);
                }
            };

            const addComment = async (parentId = null) => {
                if (!comment.trim() || !article) return;
                
                const user = window.firebaseAuth?.currentUser;
                if (!user || !window.firestore) {
                    alert('Please log in to comment');
                    return;
                }

                try {
                    const { doc, updateDoc, getDoc, Timestamp } = window.firestore;
                    const articleRef = doc(window.firebaseDb, 'articles', article.id);
                    const articleSnap = await getDoc(articleRef);
                    
                    if (articleSnap.exists()) {
                        const currentComments = articleSnap.data().comments || [];
                        const newComment = {
                            id: Date.now(),
                            text: comment,
                            author: user.email || 'You',
                            date: Timestamp.now(),
                            parentId
                        };
                        await updateDoc(articleRef, {
                            comments: [...currentComments, newComment]
                        });
                        setArticle({ ...article, comments: [...currentComments, newComment] });
                        setComment('');
                        setReplyTo(null);
                    }
                } catch (error) {
                    console.error('Error adding comment:', error);
                    alert('Failed to add comment: ' + error.message);
                }
            };

            if (loading) {
                return React.createElement('div', { className: 'min-h-screen flex items-center justify-center' },
                    React.createElement('div', { className: 'text-center' },
                        React.createElement('div', { className: 'animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4' }),
                        React.createElement('p', { className: 'text-gray-600' }, 'Loading article...')
                    )
                );
            }

            if (!article) {
                return React.createElement('div', { className: 'min-h-screen flex items-center justify-center' },
                    React.createElement('div', { className: 'text-center' },
                        React.createElement('p', { className: 'text-gray-600 mb-4' }, 'Article not found'),
                        React.createElement('button', {
                            onClick: () => onNavigate('articles'),
                            className: 'btn-primary'
                        }, 'Back to Articles')
                    )
                );
            }

            return React.createElement('div', { className: 'min-h-screen p-4 md:p-8 bg-gradient-to-br from-gray-50 to-white' },
                React.createElement('div', { className: 'max-w-4xl mx-auto' },
                    React.createElement('button', {
                        onClick: () => onNavigate('articles'),
                        className: 'mb-6 text-purple-600 hover:text-purple-800 flex items-center gap-2 font-semibold'
                    },
                        React.createElement('i', { className: 'fas fa-arrow-left' }),
                        'Back to Articles'
                    ),
                    React.createElement('article', { 
                        className: 'glass-card p-6 md:p-10',
                        style: {
                            fontSize: '18px',
                            lineHeight: '1.8',
                            color: '#2d3748'
                        }
                    },
                        React.createElement('h1', { 
                            className: 'text-3xl md:text-4xl font-bold mb-6',
                            style: { lineHeight: '1.3' }
                        }, article.title),
                        React.createElement('div', { className: 'flex items-center gap-4 mb-8 text-gray-600 pb-6 border-b' },
                            React.createElement('span', null, React.createElement('i', { className: 'fas fa-user mr-2' }), article.author),
                            React.createElement('span', null, React.createElement('i', { className: 'fas fa-calendar mr-2' }), new Date(article.date).toLocaleDateString()),
                            React.createElement('button', {
                                onClick: likeArticle,
                                className: 'flex items-center gap-2 hover:text-purple-600 transition-colors'
                            },
                                React.createElement('i', { className: 'fas fa-heart' }),
                                article.likes || 0
                            ),
                            React.createElement('span', null, React.createElement('i', { className: 'fas fa-eye mr-1' }), article.views || 0, ' views')
                        ),
                        React.createElement('div', { 
                            className: 'prose max-w-none mb-10',
                            style: { 
                                whiteSpace: 'pre-wrap',
                                fontSize: '18px',
                                lineHeight: '1.8'
                            }
                        }, article.content),
                        React.createElement('div', { className: 'border-t pt-8' },
                            React.createElement('h3', { className: 'text-2xl font-bold mb-6' }, 'Comments'),
                            React.createElement('div', { className: 'mb-6' },
                                React.createElement('textarea', {
                                    value: comment,
                                    onChange: (e) => setComment(e.target.value),
                                    placeholder: 'Add a comment...',
                                    className: 'w-full p-4 border border-gray-300 rounded-lg mb-3',
                                    rows: 4
                                }),
                                React.createElement('button', {
                                    onClick: () => addComment(replyTo),
                                    className: 'btn-primary'
                                }, 'Post Comment')
                            ),
                            React.createElement('div', { className: 'space-y-4' },
                                (article.comments || []).filter(c => !c.parentId).map(comment =>
                                    React.createElement('div', { key: comment.id, className: 'p-4 bg-gray-50 rounded-lg' },
                                        React.createElement('div', { className: 'flex justify-between mb-2' },
                                            React.createElement('span', { className: 'font-semibold' }, comment.author),
                                            React.createElement('span', { className: 'text-sm text-gray-600' },
                                                new Date(comment.date?.toDate ? comment.date.toDate() : comment.date).toLocaleDateString()
                                            )
                                        ),
                                        React.createElement('p', { className: 'mb-2' }, comment.text),
                                        React.createElement('button', {
                                            onClick: () => setReplyTo(replyTo === comment.id ? null : comment.id),
                                            className: 'text-sm text-purple-600 hover:text-purple-800'
                                        }, 'Reply'),
                                        (article.comments || []).filter(c => c.parentId === comment.id).map(reply =>
                                            React.createElement('div', { key: reply.id, className: 'ml-6 mt-3 p-3 bg-white rounded border-l-4 border-purple-300' },
                                                React.createElement('span', { className: 'font-semibold text-sm' }, reply.author),
                                                React.createElement('p', { className: 'text-sm mt-1' }, reply.text)
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            );
        }

        function PageRouter({ currentPage, onNavigate, articleId, articleData }) {
            const pages = {
                home: () => React.createElement(HomePage, { onNavigate }),
                deborah: () => React.createElement(AITherapistPage),
                journal: () => React.createElement(JournalPage, { onNavigate }),
                mood: () => React.createElement(MoodTrackingPage),
                breathing: () => React.createElement(BreathingPage),
                exercises: () => React.createElement(GuidedExercisesPage),
                'safe-space': () => React.createElement('div', null, 'Safe Space'),
                sounds: () => React.createElement(SoundscapesPage),
                progress: () => React.createElement(ProgressPage),
                articles: () => React.createElement(ArticlesPage, { onNavigate }),
                'article-detail': () => React.createElement(ArticleDetailPage, { articleId, articleData, onNavigate }),
                habits: () => React.createElement(HabitTrackingPage),
                sleep: () => React.createElement(SleepTrackingPage),
                goals: () => React.createElement(GoalSettingPage),
                about: () => React.createElement(AboutPage, { onNavigate }),
                privacy: () => React.createElement(PrivacyPage, { onNavigate }),
                terms: () => React.createElement(TermsPage, { onNavigate })
            };

            const Page = pages[currentPage] || pages.home;
            return React.createElement(Page);
        }

        // Enhanced Homepage with quick-access panels
        function HomePage({ onNavigate }) {
            const currentUser = auth.getCurrentUser();
            const moodHistory = currentUser ? storage.getUserData('moods', []) : [];
            const journalEntries = currentUser ? storage.getUserData('journal', []) : [];
            const [dailyMessage, setDailyMessage] = useState('');
            const [checkInPrompt, setCheckInPrompt] = useState('');
            const [showCheckIn, setShowCheckIn] = useState(false);
            const [checkInResponse, setCheckInResponse] = useState('');
            const [earnedBadges, setEarnedBadges] = useState([]);

            useEffect(() => {
                // Get or set today's daily message (one per day)
                const getTodaysMessage = () => {
                    const today = new Date().toISOString().split('T')[0];
                    const stored = storage.getUserData('daily_message', null);
                    if (stored && stored.date === today) {
                        return stored.message;
                    }
                    const messages = [
                        "Like a butterfly, you have the power to transform. Today is a new beginning.",
                        "Your journey matters. Every small step forward is progress worth celebrating.",
                        "Remember: growth happens in the quiet moments between challenges and triumphs.",
                        "You are stronger than you know. Trust in your ability to bloom, even in difficult times.",
                        "Today, be gentle with yourself. You're doing the best you can, and that's enough."
                    ];
                    const message = messages[Math.floor(Math.random() * messages.length)];
                    storage.setUserData('daily_message', { date: today, message });
                    return message;
                };
                
                setDailyMessage(getTodaysMessage());
                
                // Load daily check-in prompt
                if (currentUser && !DailyCheckIn.hasCheckedInToday()) {
                    const prompt = DailyCheckIn.getTodaysPrompt();
                    if (prompt && typeof prompt === 'string' && prompt.trim().length > 0) {
                        setCheckInPrompt(prompt);
                        setShowCheckIn(true);
                    }
                }
                
                // Load earned badges
                if (currentUser) {
                    setEarnedBadges(AchievementSystem.getEarnedBadges(currentUser.id));
                }
            }, [currentUser]);

            const recentMood = moodHistory[0];
            const recentEntry = journalEntries[0];

            return React.createElement('div', { className: 'min-h-screen' },
                React.createElement('div', { className: 'bg-gradient-to-r from-purple-500 via-pink-500 to-blue-500 text-white py-20' },
                    React.createElement('div', { className: 'max-w-7xl mx-auto px-8 text-center' },
                        React.createElement('h1', { className: 'butterfly-logo text-6xl md:text-7xl font-bold mb-4' }, 'Bloomly'),
                        React.createElement('p', { className: 'text-2xl md:text-3xl mb-4 opacity-95' }, 'Nurture Your Mind, Blossom Your Life'),
                        React.createElement('p', { className: 'text-lg md:text-xl mb-8 opacity-90 italic' }, 'Grow emotionally, one moment at a time.'),
                        React.createElement('div', { className: 'flex flex-wrap gap-4 justify-center' },
                            currentUser ? 
                                React.createElement(React.Fragment, null,
                    React.createElement('button', {
                                        onClick: () => onNavigate('journal'),
                                        className: 'btn-primary text-lg px-8 py-4 bg-white text-purple-600 hover:bg-gray-100'
                                    }, React.createElement('i', { className: 'fas fa-book mr-2' }), 'Start Journaling'),
                                    React.createElement('button', {
                                        onClick: () => onNavigate('deborah'),
                                        className: 'btn-secondary text-lg px-8 py-4 bg-white bg-opacity-20 backdrop-blur-sm text-white border-2 border-white hover:bg-opacity-30'
                                    }, React.createElement('i', { className: 'fas fa-comments mr-2' }), 'Talk to Deborah')
                                ) :
                                React.createElement(React.Fragment, null,
                                    React.createElement('button', {
                                        onClick: () => window.location.href = 'signup.html',
                                        className: 'btn-primary text-lg px-8 py-4 bg-white text-purple-600 hover:bg-gray-100'
                                    }, React.createElement('i', { className: 'fas fa-user-plus mr-2' }), 'Get Started'),
                                    React.createElement('button', {
                                        onClick: () => window.location.href = 'login.html',
                                        className: 'btn-secondary text-lg px-8 py-4 bg-white bg-opacity-20 backdrop-blur-sm text-white border-2 border-white hover:bg-opacity-30'
                                    }, React.createElement('i', { className: 'fas fa-sign-in-alt mr-2' }), 'Login')
                                )
                        )
                    )
                ),

                React.createElement('div', { className: 'max-w-7xl mx-auto px-8 py-12' },
                    // Daily Check-In Prompt
                    showCheckIn && checkInPrompt && typeof checkInPrompt === 'string' && checkInPrompt.trim().length > 0 && currentUser && React.createElement('div', { className: 'glass-card p-6 mb-8 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200' },
                        React.createElement('div', { className: 'flex items-start justify-between gap-4' },
                            React.createElement('div', { className: 'flex items-start gap-4 flex-1' },
                                React.createElement('div', { className: 'text-4xl' }, ''),
                                React.createElement('div', { className: 'flex-1' },
                                    React.createElement('h3', { className: 'text-lg font-bold mb-2 text-blue-700' }, 'Daily Check-In'),
                                    React.createElement('p', { className: 'text-gray-700 mb-4 font-semibold' }, checkInPrompt.trim()),
                                    React.createElement('textarea', {
                                        value: checkInResponse,
                                        onChange: (e) => setCheckInResponse(e.target.value),
                                        placeholder: 'Share your thoughts...',
                                        className: 'w-full p-3 border border-blue-200 rounded-lg mb-3',
                                        rows: 3
                                    }),
                                    React.createElement('div', { className: 'flex gap-3' },
                                        React.createElement('button', {
                                            onClick: () => {
                                                if (checkInResponse.trim()) {
                                                    DailyCheckIn.markCheckedIn();
                                                    setShowCheckIn(false);
                                                    Celebration.show('Check-in saved! ');
                                                }
                                            },
                                            className: 'btn-primary px-4 py-2 text-sm'
                                        }, 'Save Check-In'),
                                        React.createElement('button', {
                                            onClick: () => {
                                                DailyCheckIn.markCheckedIn();
                                                setShowCheckIn(false);
                                            },
                                            className: 'btn-secondary px-4 py-2 text-sm'
                                        }, 'Skip for Today')
                                    )
                                )
                            ),
                            React.createElement('button', {
                                onClick: () => {
                                    DailyCheckIn.markCheckedIn();
                                    setShowCheckIn(false);
                                },
                                className: 'text-gray-400 hover:text-gray-600'
                            }, React.createElement('i', { className: 'fas fa-times' }))
                        )
                    ),

                    // Achievement Badges Display
                    earnedBadges.length > 0 && currentUser && React.createElement('div', { className: 'glass-card p-6 mb-8' },
                        React.createElement('h3', { className: 'text-xl font-bold mb-4' }, 'Your Achievements'),
                        React.createElement('div', { className: 'flex flex-wrap gap-4' },
                            earnedBadges.map(badge =>
                                React.createElement('div', {
                                    key: badge.id,
                                    className: 'achievement-badge',
                                    title: badge.description
                                }, badge.icon)
                            )
                        )
                    ),

                    dailyMessage && React.createElement('div', { className: 'glass-card p-6 mb-8 bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200' },
                        React.createElement('div', { className: 'flex items-start gap-4' },
                            React.createElement('div', { className: 'text-4xl' }, ''),
                            React.createElement('div', null,
                                React.createElement('h3', { className: 'text-lg font-bold mb-2 text-purple-700' }, "Deborah's Daily Message"),
                                React.createElement('p', { className: 'text-gray-700 italic' }, dailyMessage)
                            )
                        )
                    ),

                    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8' },
                        React.createElement('div', {
                            onClick: () => onNavigate('mood'),
                            className: 'glass-card p-6 cursor-pointer hover:scale-105 transition-transform'
                        },
                            React.createElement('div', { className: 'flex items-center gap-4 mb-4' },
                                React.createElement('div', { className: 'w-16 h-16 rounded-full bg-gradient-to-br from-blue-400 to-purple-400 flex items-center justify-center text-white text-2xl' },
                                    React.createElement('i', { className: 'fas fa-smile' })
                                ),
                                React.createElement('h3', { className: 'text-xl font-bold' }, 'Mood Tracker')
                            ),
                            recentMood && React.createElement('div', { className: 'text-4xl text-center' }, ['', '', '', '', ''][recentMood.mood])
                        ),

                        React.createElement('div', {
                            onClick: () => onNavigate('journal'),
                            className: 'glass-card p-6 cursor-pointer hover:scale-105 transition-transform'
                        },
                            React.createElement('div', { className: 'flex items-center gap-4 mb-4' },
                                React.createElement('div', { className: 'w-16 h-16 rounded-full bg-gradient-to-br from-green-400 to-teal-400 flex items-center justify-center text-white text-2xl' },
                                    React.createElement('i', { className: 'fas fa-book' })
                                ),
                                React.createElement('h3', { className: 'text-xl font-bold' }, 'Journal')
                            ),
                            recentEntry && React.createElement('p', { className: 'text-sm text-gray-600 truncate' }, recentEntry.title)
                        ),

                        React.createElement('div', {
                            onClick: () => onNavigate('deborah'),
                            className: 'glass-card p-6 cursor-pointer hover:scale-105 transition-transform'
                        },
                            React.createElement('div', { className: 'flex items-center gap-4 mb-4' },
                                React.createElement('div', { className: 'w-16 h-16 rounded-full bg-gradient-to-br from-pink-400 to-red-400 flex items-center justify-center text-white text-2xl' },
                                    React.createElement('i', { className: 'fas fa-comments' })
                                ),
                                React.createElement('h3', { className: 'text-xl font-bold' }, 'Talk to Deborah')
                            ),
                            React.createElement('p', { className: 'text-sm text-gray-600' }, 'Your AI wellness companion')
                        ),

                        React.createElement('div', {
                            onClick: () => onNavigate('breathing'),
                            className: 'glass-card p-6 cursor-pointer hover:scale-105 transition-transform'
                        },
                            React.createElement('div', { className: 'flex items-center gap-4 mb-4' },
                                React.createElement('div', { className: 'w-16 h-16 rounded-full bg-gradient-to-br from-cyan-400 to-blue-400 flex items-center justify-center text-white text-2xl' },
                                    React.createElement('i', { className: 'fas fa-wind' })
                                ),
                                React.createElement('h3', { className: 'text-xl font-bold' }, 'Breathing Exercises')
                            ),
                            React.createElement('p', { className: 'text-sm text-gray-600' }, 'Calm your mind')
                        ),

                        React.createElement('div', {
                            onClick: () => onNavigate('sounds'),
                            className: 'glass-card p-6 cursor-pointer hover:scale-105 transition-transform'
                        },
                            React.createElement('div', { className: 'flex items-center gap-4 mb-4' },
                                React.createElement('div', { className: 'w-16 h-16 rounded-full bg-gradient-to-br from-indigo-400 to-purple-400 flex items-center justify-center text-white text-2xl' },
                                    React.createElement('i', { className: 'fas fa-music' })
                                ),
                                React.createElement('h3', { className: 'text-xl font-bold' }, 'Soundscapes')
                            ),
                            React.createElement('p', { className: 'text-sm text-gray-600' }, 'Ambient sounds for focus')
                        ),

                        React.createElement('div', {
                            onClick: () => onNavigate('progress'),
                            className: 'glass-card p-6 cursor-pointer hover:scale-105 transition-transform'
                        },
                            React.createElement('div', { className: 'flex items-center gap-4 mb-4' },
                                React.createElement('div', { className: 'w-16 h-16 rounded-full bg-gradient-to-br from-yellow-400 to-orange-400 flex items-center justify-center text-white text-2xl' },
                                    React.createElement('i', { className: 'fas fa-chart-line' })
                                ),
                                React.createElement('h3', { className: 'text-xl font-bold' }, 'Your Progress')
                            ),
                            React.createElement('p', { className: 'text-sm text-gray-600' }, 'Track your journey')
                        ),

                        currentUser && React.createElement('div', {
                            onClick: () => onNavigate('habits'),
                            className: 'glass-card p-6 cursor-pointer hover:scale-105 transition-transform'
                        },
                            React.createElement('div', { className: 'flex items-center gap-4 mb-4' },
                                React.createElement('div', { className: 'w-16 h-16 rounded-full bg-gradient-to-br from-green-400 to-emerald-400 flex items-center justify-center text-white text-2xl' },
                                    React.createElement('i', { className: 'fas fa-check-circle' })
                                ),
                                React.createElement('h3', { className: 'text-xl font-bold' }, 'Habits')
                            ),
                            React.createElement('p', { className: 'text-sm text-gray-600' }, 'Build healthy routines')
                        ),

                        currentUser && React.createElement('div', {
                            onClick: () => onNavigate('sleep'),
                            className: 'glass-card p-6 cursor-pointer hover:scale-105 transition-transform'
                        },
                            React.createElement('div', { className: 'flex items-center gap-4 mb-4' },
                                React.createElement('div', { className: 'w-16 h-16 rounded-full bg-gradient-to-br from-indigo-400 to-purple-400 flex items-center justify-center text-white text-2xl' },
                                    React.createElement('i', { className: 'fas fa-moon' })
                                ),
                                React.createElement('h3', { className: 'text-xl font-bold' }, 'Sleep Tracker')
                            ),
                            React.createElement('p', { className: 'text-sm text-gray-600' }, 'Monitor your rest')
                        ),

                        currentUser && React.createElement('div', {
                            onClick: () => onNavigate('goals'),
                            className: 'glass-card p-6 cursor-pointer hover:scale-105 transition-transform'
                        },
                            React.createElement('div', { className: 'flex items-center gap-4 mb-4' },
                                React.createElement('div', { className: 'w-16 h-16 rounded-full bg-gradient-to-br from-red-400 to-pink-400 flex items-center justify-center text-white text-2xl' },
                                    React.createElement('i', { className: 'fas fa-bullseye' })
                                ),
                                React.createElement('h3', { className: 'text-xl font-bold' }, 'Goals')
                            ),
                            React.createElement('p', { className: 'text-sm text-gray-600' }, 'Set and achieve milestones')
                        )
                    ),

                    React.createElement('div', { className: 'glass-card p-6' },
                        React.createElement('h2', { className: 'text-2xl font-bold mb-4' }, 'Featured Articles'),
                        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4' },
                            [1, 2, 3].map(i =>
                                React.createElement('div', {
                                    key: i,
                                    onClick: () => onNavigate('articles'),
                                    className: 'p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100'
                                },
                                    React.createElement('h4', { className: 'font-bold mb-2' }, `Wellness Article ${i}`),
                                    React.createElement('p', { className: 'text-sm text-gray-600' }, 'Discover insights and tips for your mental wellbeing journey.')
                                )
                            )
                        )
                    )
                )
            );
        }

        // Enhanced Journal Page with mood tagging, Deborah prompts, timeline
        function JournalPage({ onNavigate }) {
            // ALL HOOKS MUST BE DECLARED AT THE TOP - BEFORE ANY CONDITIONAL LOGIC
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [authChecking, setAuthChecking] = useState(true);
            const [entries, setEntries] = useState([]);
            const [newEntry, setNewEntry] = useState({ title: '', content: '', mood: null, tags: [], isPrivate: false, isFavorite: false });
            const [showEditor, setShowEditor] = useState(false);
            const [selectedEntry, setSelectedEntry] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [deborahPrompt, setDeborahPrompt] = useState('');
            const [loading, setLoading] = useState(true);

            // Check Firebase authentication - MUST BE BEFORE CONDITIONAL RETURNS
            useEffect(() => {
                let unsubscribe = null;
                
                // Wait for Firebase to be ready
                const checkAuth = () => {
                    if (!window.firebaseAuth || !window.onAuthStateChanged) {
                        // If Firebase not ready yet, wait a bit and try again
                        if (!window.firebaseReady) {
                            setTimeout(checkAuth, 100);
                            return;
                        }
                        console.error('Firebase Auth not initialized');
                        setAuthChecking(false);
                        window.location.href = 'login.html';
                        return;
                    }

                    unsubscribe = window.onAuthStateChanged(window.firebaseAuth, user => {
                        setAuthChecking(false);
                        if (!user) {
                            // No user logged in  redirect to login page
                            window.location.href = 'login.html';
                        } else {
                            setIsAuthenticated(true);
                        }
                    });
                };

                // Check immediately or wait for Firebase ready event
                if (window.firebaseReady) {
                    checkAuth();
                } else {
                    window.addEventListener('firebaseReady', checkAuth, { once: true });
                    // Fallback timeout
                    setTimeout(() => {
                        if (authChecking) checkAuth();
                    }, 2000);
                }

                return () => {
                    if (unsubscribe) unsubscribe();
                };
            }, []);

            // Load journals from Firestore - MUST BE BEFORE CONDITIONAL RETURNS
            useEffect(() => {
                if (!isAuthenticated) return;

                const loadJournals = async () => {
                    const user = window.firebaseAuth?.currentUser;
                    if (!user || !window.firestore) {
                        setLoading(false);
                        return null;
                    }

                    // Load cached entries immediately for instant display
                    const cachedEntries = storage.getUserData('journal_entries_cache', []);
                    if (cachedEntries.length > 0) {
                        setEntries(cachedEntries.slice(0, 50)); // Show first 50 from cache
                        setLoading(false);
                    }

                    try {
                        const { collection, query, where, orderBy, limit, getDocs, onSnapshot } = window.firestore;
                        const journalsRef = collection(window.firebaseDb, 'journals');
                        
                        // Set up timeout fallback
                        const timeoutId = setTimeout(() => {
                            console.warn('Journal loading timeout - using cache or empty state');
                            if (cachedEntries.length === 0) {
                                setLoading(false);
                            }
                        }, 5000);

                        // Try to load with orderBy and limit for faster initial load
                        try {
                            const q = query(journalsRef, where('userId', '==', user.uid), orderBy('date', 'desc'), limit(50));
                            
                            // Initial load with getDocs for faster response
                            const snapshot = await getDocs(q);
                            const journalEntries = [];
                            snapshot.forEach((doc) => {
                                const data = doc.data();
                                journalEntries.push({
                                    id: doc.id,
                                    ...data,
                                    date: data.date?.toDate ? data.date.toDate().toISOString() : data.date,
                                    timestamp: data.date?.toDate ? data.date.toDate().getTime() : new Date(data.date).getTime()
                                });
                            });
                            
                            // Sort by timestamp (client-side fallback)
                            journalEntries.sort((a, b) => b.timestamp - a.timestamp);
                            
                            clearTimeout(timeoutId);
                            setEntries(journalEntries);
                            setLoading(false);
                            
                            // Cache entries for next time
                            storage.setUserData('journal_entries_cache', journalEntries);
                            
                            // Set up real-time listener for updates (without limit to catch all changes)
                            const qAll = query(journalsRef, where('userId', '==', user.uid), orderBy('date', 'desc'));
                            const unsubscribe = onSnapshot(qAll, (snapshot) => {
                                const allEntries = [];
                                snapshot.forEach((doc) => {
                                    const data = doc.data();
                                    allEntries.push({
                                        id: doc.id,
                                        ...data,
                                        date: data.date?.toDate ? data.date.toDate().toISOString() : data.date,
                                        timestamp: data.date?.toDate ? data.date.toDate().getTime() : new Date(data.date).getTime()
                                    });
                                });
                                allEntries.sort((a, b) => b.timestamp - a.timestamp);
                                setEntries(allEntries.slice(0, 50)); // Keep showing first 50
                                storage.setUserData('journal_entries_cache', allEntries);
                            }, (error) => {
                                console.error('Error in real-time listener:', error);
                            });
                            
                            return () => {
                                clearTimeout(timeoutId);
                                unsubscribe();
                            };
                        } catch (error) {
                            clearTimeout(timeoutId);
                            console.error('Error loading journals with orderBy:', error);
                            
                            // Fallback: try without orderBy
                            if (error.code === 'failed-precondition') {
                                const q2 = query(journalsRef, where('userId', '==', user.uid), limit(50));
                                const snapshot2 = await getDocs(q2);
                                const journalEntries = [];
                                snapshot2.forEach((doc) => {
                                    const data = doc.data();
                                    journalEntries.push({
                                        id: doc.id,
                                        ...data,
                                        date: data.date?.toDate ? data.date.toDate().toISOString() : data.date,
                                        timestamp: data.date?.toDate ? data.date.toDate().getTime() : new Date(data.date).getTime()
                                    });
                                });
                                journalEntries.sort((a, b) => b.timestamp - a.timestamp);
                                setEntries(journalEntries);
                                setLoading(false);
                                storage.setUserData('journal_entries_cache', journalEntries);
                                
                                // Set up real-time listener without orderBy
                                const q2All = query(journalsRef, where('userId', '==', user.uid));
                                const unsubscribe = onSnapshot(q2All, (snapshot) => {
                                    const allEntries = [];
                                    snapshot.forEach((doc) => {
                                        const data = doc.data();
                                        allEntries.push({
                                            id: doc.id,
                                            ...data,
                                            date: data.date?.toDate ? data.date.toDate().toISOString() : data.date,
                                            timestamp: data.date?.toDate ? data.date.toDate().getTime() : new Date(data.date).getTime()
                                        });
                                    });
                                    allEntries.sort((a, b) => b.timestamp - a.timestamp);
                                    setEntries(allEntries.slice(0, 50));
                                    storage.setUserData('journal_entries_cache', allEntries);
                                });
                                
                                return () => unsubscribe();
                            } else {
                                setLoading(false);
                                return null;
                            }
                        }
                    } catch (error) {
                        console.error('Error setting up journals listener:', error);
                        setLoading(false);
                        return null;
                    }
                };

                // Wait for Firebase to be ready
                let cleanup = null;
                const initLoad = () => {
                    loadJournals().then(cleanupFn => {
                        if (cleanupFn) cleanup = cleanupFn;
                    });
                };
                
                if (window.firebaseReady) {
                    initLoad();
                } else {
                    window.addEventListener('firebaseReady', initLoad, { once: true });
                }
                
                return () => {
                    if (cleanup) cleanup();
                };
            }, [isAuthenticated]);

            useEffect(() => {
                const prompts = [
                    "What's one thing you're grateful for today?",
                    "Describe a moment that brought you joy this week.",
                    "What challenge did you overcome recently?",
                    "How are you feeling right now, and why?",
                    "What would you tell your past self?"
                ];
                setDeborahPrompt(prompts[Math.floor(Math.random() * prompts.length)]);
            }, []);

            const moods = ['', '', '', '', ''];
            const moodLabels = ['Very Sad', 'Sad', 'Neutral', 'Happy', 'Very Happy'];

            const saveEntry = async () => {
                if (!newEntry.title.trim() || !newEntry.content.trim()) return;
                
                const user = window.firebaseAuth?.currentUser;
                if (!user || !window.firestore) {
                    alert('Please log in to save journals');
                    return;
                }

                try {
                    const { collection, addDoc, Timestamp } = window.firestore;
                    await addDoc(collection(window.firebaseDb, 'journals'), {
                        userId: user.uid,
                        title: newEntry.title,
                        content: newEntry.content,
                        mood: newEntry.mood,
                        tags: newEntry.tags || [],
                        isPrivate: newEntry.isPrivate || false,
                        isFavorite: newEntry.isFavorite || false,
                        date: Timestamp.now()
                    });
                    
                    setNewEntry({ title: '', content: '', mood: null, tags: [], isPrivate: false, isFavorite: false });
                    setShowEditor(false);
                } catch (error) {
                    console.error('Error saving journal:', error);
                    alert('Failed to save journal: ' + error.message);
                }
            };

            if (loading) {
                return React.createElement('div', { className: 'min-h-screen p-8' },
                    React.createElement('div', { className: 'max-w-6xl mx-auto' },
                        React.createElement('div', { className: 'skeleton skeleton-title mb-8' }),
                        React.createElement('div', { className: 'grid grid-cols-1 lg:grid-cols-3 gap-6' },
                            ...Array(6).fill(0).map((_, i) =>
                                React.createElement('div', { key: i, className: 'skeleton skeleton-card' })
                            )
                        )
                    )
                );
            }

            // Filter entries based on search
            const filteredEntries = entries.filter(entry => 
                !searchQuery || 
                entry.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                entry.content.toLowerCase().includes(searchQuery.toLowerCase())
            );

            // Show entry view if one is selected
            if (selectedEntry) {
                const entry = entries.find(e => e.id === selectedEntry);
                if (entry) {
                    return React.createElement('div', { className: 'min-h-screen p-8', style: { background: 'linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%)' } },
                        React.createElement('div', { className: 'max-w-4xl mx-auto' },
                            React.createElement('button', {
                                onClick: () => setSelectedEntry(null),
                                className: 'mb-6 text-purple-600 hover:text-purple-800 flex items-center gap-2'
                            },
                                React.createElement('i', { className: 'fas fa-arrow-left' }),
                                'Back to Journal'
                            ),
                            React.createElement('div', { className: 'bloomly-card' },
                                React.createElement('div', { className: 'flex items-center justify-between mb-6' },
                                    React.createElement('div', { className: 'flex items-center gap-4' },
                                        entry.mood !== null && React.createElement('span', { className: 'text-5xl' }, moods[entry.mood]),
                            React.createElement('div', null,
                                            React.createElement('h1', { className: 'bloomly-h1 mb-2' }, entry.title),
                                            React.createElement('p', { className: 'bloomly-caption' },
                                                new Date(entry.date).toLocaleString()
                                            )
                                        )
                                    ),
                                    React.createElement('div', { className: 'flex gap-2' },
                                        entry.isFavorite && React.createElement('i', { className: 'fas fa-star text-yellow-400 text-xl' }),
                                        entry.isPrivate && React.createElement('i', { className: 'fas fa-lock text-gray-400 text-xl' })
                                    )
                                ),
                                React.createElement('div', { 
                                    className: 'prose max-w-none mb-6',
                                    style: { 
                                        whiteSpace: 'pre-wrap',
                                        lineHeight: '1.8',
                                        fontSize: '1.1rem',
                                        color: '#2d3748'
                                    }
                                }, entry.content),
                                React.createElement('div', { className: 'flex gap-3 pt-4 border-t' },
                            React.createElement('button', {
                                        onClick: () => {
                                            setNewEntry(entry);
                                            setShowEditor(true);
                                            setSelectedEntry(null);
                                        },
                                        className: 'bloomly-btn bloomly-btn-secondary'
                                    },
                                        React.createElement('i', { className: 'fas fa-edit' }),
                                        'Edit'
                                    ),
                                    React.createElement('button', {
                                        onClick: async () => {
                                            if (confirm('Are you sure you want to delete this entry?')) {
                                                try {
                                                    const { doc, deleteDoc } = window.firestore;
                                                    await deleteDoc(doc(window.firebaseDb, 'journals', entry.id));
                                                    setSelectedEntry(null);
                                                } catch (error) {
                                                    console.error('Error deleting entry:', error);
                                                    alert('Failed to delete entry');
                                                }
                                            }
                                        },
                                        className: 'bloomly-btn bloomly-btn-secondary',
                                        style: { color: '#ef4444', borderColor: '#ef4444' }
                                    },
                                        React.createElement('i', { className: 'fas fa-trash' }),
                                        'Delete'
                                    )
                                )
                            )
                        )
                    );
                }
            }

            return React.createElement('div', { className: 'min-h-screen p-8', style: { background: 'linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%)' } },
                React.createElement('div', { className: 'max-w-7xl mx-auto' },
                    React.createElement('div', { className: 'mb-8' },
                        React.createElement('div', { className: 'flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6' },
                            React.createElement('h1', { className: 'bloomly-h1' }, 'My Journal'),
                            React.createElement('button', {
                                onClick: () => setShowEditor(true),
                                className: 'bloomly-btn bloomly-btn-primary'
                            }, 
                                React.createElement('i', { className: 'fas fa-plus' }),
                                'New Entry'
                            )
                        ),
                        React.createElement(UniversalSearchBar, {
                            placeholder: 'Search your journal entries...',
                            value: searchQuery,
                            onChange: setSearchQuery
                        })
                    ),

                    showEditor && React.createElement('div', { className: 'bloomly-card mb-8' },
                        React.createElement('h2', { className: 'bloomly-h2 mb-6' }, 'Create New Entry'),
                        React.createElement('div', { className: 'mb-4' },
                            React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Title'),
                                React.createElement('input', {
                                    type: 'text',
                                value: newEntry.title,
                                onChange: (e) => setNewEntry({ ...newEntry, title: e.target.value }),
                                    className: 'w-full p-3 border border-gray-300 rounded-lg',
                                placeholder: 'Entry title...'
                            })
                        ),
                        React.createElement('div', { className: 'mb-4' },
                            React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Mood'),
                            React.createElement('div', { className: 'flex gap-3' },
                                moods.map((emoji, idx) =>
                                    React.createElement('button', {
                                        key: idx,
                                        onClick: () => setNewEntry({ ...newEntry, mood: idx }),
                                        className: `text-4xl p-2 rounded-lg ${newEntry.mood === idx ? 'bg-purple-100 border-2 border-purple-500' : 'hover:bg-gray-100'}`,
                                        title: moodLabels[idx]
                                    }, emoji)
                                )
                            )
                        ),
                        deborahPrompt && React.createElement('div', { className: 'mb-4 p-4 bg-purple-50 rounded-lg border border-purple-200' },
                            React.createElement('p', { className: 'text-sm text-purple-700 mb-1' }, React.createElement('i', { className: 'fas fa-sparkles mr-2' }), 'Deborah suggests:'),
                            React.createElement('p', { className: 'font-semibold' }, deborahPrompt)
                        ),
                        React.createElement('div', { className: 'mb-4' },
                            React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Your Thoughts'),
                            React.createElement('textarea', {
                                value: newEntry.content,
                                onChange: (e) => setNewEntry({ ...newEntry, content: e.target.value }),
                                className: 'w-full p-4 border border-gray-300 rounded-lg h-64',
                                placeholder: 'Write your thoughts here...',
                                style: { background: 'linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%)' }
                            })
                        ),
                        React.createElement('div', { className: 'flex gap-4 items-center mb-4' },
                            React.createElement('label', { className: 'flex items-center gap-2' },
                                React.createElement('input', {
                                    type: 'checkbox',
                                    checked: newEntry.isPrivate,
                                    onChange: (e) => setNewEntry({ ...newEntry, isPrivate: e.target.checked })
                                }),
                                React.createElement('span', null, 'Private Entry')
                            ),
                            React.createElement('label', { className: 'flex items-center gap-2' },
                                React.createElement('input', {
                                    type: 'checkbox',
                                    checked: newEntry.isFavorite,
                                    onChange: (e) => setNewEntry({ ...newEntry, isFavorite: e.target.checked })
                                }),
                                React.createElement('span', null, 'Favorite')
                            )
                        ),
                        React.createElement('div', { className: 'flex gap-3' },
                            React.createElement('button', { onClick: saveEntry, className: 'btn-primary' }, 'Save Entry'),
                            React.createElement('button', {
                                onClick: () => {
                                    setShowEditor(false);
                                    setNewEntry({ title: '', content: '', mood: null, tags: [], isPrivate: false, isFavorite: false });
                                },
                                className: 'btn-secondary'
                            }, 'Cancel')
                        )
                    ),
                    filteredEntries.length === 0 && !loading && React.createElement('div', { className: 'text-center py-12' },
                        React.createElement('div', { className: 'text-6xl mb-4' }, ''),
                        React.createElement('p', { className: 'text-gray-600 text-lg' }, 
                            searchQuery ? 'No entries found matching your search.' : 'No journal entries yet. Start writing your first entry!'
                        )
                    ),
                    filteredEntries.length > 0 && React.createElement('div', { className: 'grid grid-cols-1 lg:grid-cols-3 gap-6' },
                        React.createElement('div', { className: 'lg:col-span-2 space-y-4' },
                            filteredEntries.map(entry =>
                                React.createElement('div', {
                                    key: entry.id,
                                    onClick: () => setSelectedEntry(entry.id),
                                    className: `bloomly-card cursor-pointer ${entry.isFavorite ? 'border-2 border-yellow-400' : ''}`
                                },
                                    React.createElement('div', { className: 'flex justify-between items-start mb-3' },
                                        React.createElement('div', { className: 'flex items-center gap-3' },
                                            entry.mood !== null && React.createElement('span', { className: 'text-3xl' }, moods[entry.mood]),
                                            React.createElement('h3', { className: 'text-xl font-bold' }, entry.title)
                                        ),
                                        React.createElement('div', { className: 'flex gap-2' },
                                            entry.isFavorite && React.createElement('i', { className: 'fas fa-star text-yellow-400' }),
                                            entry.isPrivate && React.createElement('i', { className: 'fas fa-lock text-gray-400' })
                                        )
                                    ),
                                    React.createElement('p', { 
                                        className: 'text-gray-600 mb-3 line-clamp-3',
                                        style: { 
                                            display: '-webkit-box',
                                            WebkitLineClamp: 3,
                                            WebkitBoxOrient: 'vertical',
                                            overflow: 'hidden'
                                        }
                                    }, entry.content),
                                    React.createElement('div', { className: 'flex items-center justify-between' },
                                        React.createElement('p', { className: 'text-sm text-gray-500' },
                                            new Date(entry.date).toLocaleDateString('en-US', { 
                                                month: 'short', 
                                                day: 'numeric', 
                                                year: 'numeric' 
                                            })
                                        ),
                        React.createElement('button', {
                                            onClick: (e) => {
                                                e.stopPropagation();
                                                setSelectedEntry(entry.id);
                                            },
                                            className: 'text-purple-600 hover:text-purple-800 text-sm font-semibold'
                                        }, 'Read More ')
                                    )
                                )
                            )
                        ),
                        React.createElement('div', { className: 'lg:col-span-1' },
                            React.createElement('div', { className: 'glass-card p-6 sticky top-4' },
                                React.createElement('h3', { className: 'text-lg font-bold mb-4' }, 'Timeline'),
                                React.createElement('div', { className: 'space-y-3' },
                                    entries.slice(0, 10).map(entry =>
                            React.createElement('div', {
                                            key: entry.id,
                                            className: 'p-3 rounded-lg hover:bg-gray-50 cursor-pointer border-l-4 border-purple-500'
                                        },
                                            React.createElement('p', { className: 'font-semibold text-sm' }, entry.title),
                                            React.createElement('p', { className: 'text-xs text-gray-500' },
                                                new Date(entry.date).toLocaleDateString()
                                        )
                                    )
                                )
                            )
                        )
                        )
                    )
                )
            );
        }

        function MoodTrackingPage() {
            // ALL HOOKS MUST BE DECLARED AT THE TOP - BEFORE ANY CONDITIONAL LOGIC
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [authChecking, setAuthChecking] = useState(true);
            const [selectedMood, setSelectedMood] = useState(null);
            const [moodHistory, setMoodHistory] = useState([]);
            const [notes, setNotes] = useState('');
            const [loading, setLoading] = useState(true);
            const chartRef = useRef(null);
            const chartInstanceRef = useRef(null);

            // Check Firebase authentication - MUST BE BEFORE CONDITIONAL RETURNS
            useEffect(() => {
                let unsubscribe = null;
                
                // Wait for Firebase to be ready
                const checkAuth = () => {
                    if (!window.firebaseAuth || !window.onAuthStateChanged) {
                        // If Firebase not ready yet, wait a bit and try again
                        if (!window.firebaseReady) {
                            setTimeout(checkAuth, 100);
                            return;
                        }
                        console.error('Firebase Auth not initialized');
                        setAuthChecking(false);
                        window.location.href = 'login.html';
                        return;
                    }

                    unsubscribe = window.onAuthStateChanged(window.firebaseAuth, user => {
                        setAuthChecking(false);
                        if (!user) {
                            // No user logged in  redirect to login page
                            window.location.href = 'login.html';
                        } else {
                            setIsAuthenticated(true);
                        }
                    });
                };

                // Check immediately or wait for Firebase ready event
                if (window.firebaseReady) {
                    checkAuth();
                } else {
                    window.addEventListener('firebaseReady', checkAuth, { once: true });
                    // Fallback timeout
                    setTimeout(() => {
                        if (authChecking) checkAuth();
                    }, 2000);
                }

                return () => {
                    if (unsubscribe) unsubscribe();
                };
            }, []);

            // Load moods from Firestore - MUST BE BEFORE CONDITIONAL RETURNS
            useEffect(() => {
                if (!isAuthenticated) {
                    setLoading(false);
                    return;
                }

                const loadMoods = () => {
                    const user = window.firebaseAuth?.currentUser;
                    if (!user || !window.firestore) {
                        setLoading(false);
                        return;
                    }

                    try {
                        const { collection, query, where, orderBy, onSnapshot } = window.firestore;
                        const moodsRef = collection(window.firebaseDb, 'moods');
                        const q = query(moodsRef, where('userId', '==', user.uid), orderBy('date', 'desc'));

                        // Real-time listener
                        const unsubscribe = onSnapshot(q, (snapshot) => {
                            const moodEntries = [];
                            snapshot.forEach((doc) => {
                                const data = doc.data();
                                moodEntries.push({
                                    id: doc.id,
                                    mood: data.mood,
                                    notes: data.note || '',
                                    date: data.date?.toDate ? data.date.toDate().toISOString() : data.date,
                                    timestamp: data.date?.toDate ? data.date.toDate().getTime() : new Date(data.date).getTime()
                                });
                            });
                            setMoodHistory(moodEntries);
                            setLoading(false);
                        }, (error) => {
                            console.error('Error loading moods:', error);
                            // If error is due to missing index, try without orderBy
                            if (error.code === 'failed-precondition') {
                                const moodsRef = collection(window.firebaseDb, 'moods');
                                const q2 = query(moodsRef, where('userId', '==', user.uid));
                                onSnapshot(q2, (snapshot) => {
                                    const moodEntries = [];
                                    snapshot.forEach((doc) => {
                                        const data = doc.data();
                                        moodEntries.push({
                                            id: doc.id,
                                            mood: data.mood,
                                            notes: data.note || '',
                                            date: data.date?.toDate ? data.date.toDate().toISOString() : data.date,
                                            timestamp: data.date?.toDate ? data.date.toDate().getTime() : new Date(data.date).getTime()
                                        });
                                    });
                                    moodEntries.sort((a, b) => b.timestamp - a.timestamp);
                                    setMoodHistory(moodEntries);
                                    setLoading(false);
                                });
                            } else {
                                setLoading(false);
                            }
                        });

                        return () => unsubscribe();
                    } catch (error) {
                        console.error('Error setting up moods listener:', error);
                        setLoading(false);
                    }
                };

                if (window.firebaseReady) {
                    return loadMoods();
                } else {
                    window.addEventListener('firebaseReady', loadMoods, { once: true });
                }
            }, [isAuthenticated]);

            // Create Chart.js chart for mood trends - MUST BE BEFORE CONDITIONAL RETURNS
            useEffect(() => {
                if (!isAuthenticated || moodHistory.length === 0 || !chartRef.current) return;

                const moods = [
                    { emoji: '', label: 'Very Sad', color: 'bg-blue-200', value: 1 },
                    { emoji: '', label: 'Sad', color: 'bg-blue-100', value: 2 },
                    { emoji: '', label: 'Neutral', color: 'bg-gray-100', value: 3 },
                    { emoji: '', label: 'Happy', color: 'bg-green-100', value: 4 },
                    { emoji: '', label: 'Very Happy', color: 'bg-green-200', value: 5 }
                ];
                if (moodHistory.length === 0 || !chartRef.current) return;

                const ctx = chartRef.current.getContext('2d');
                
                // Prepare data for last 7 days
                const last7Days = moodHistory.slice(0, 7).reverse();
                const labels = last7Days.map(e => new Date(e.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                const data = last7Days.map(e => moods[e.mood].value);

                if (chartInstanceRef.current) {
                    chartInstanceRef.current.destroy();
                }

                chartInstanceRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Mood Trend',
                            data: data,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: 'rgb(102, 126, 234)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const moodLabels = ['Very Sad', 'Sad', 'Neutral', 'Happy', 'Very Happy'];
                                        return moodLabels[Math.round(value) - 1] || 'Unknown';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 1,
                                max: 5,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        const moodLabels = ['', '', '', '', ''];
                                        return moodLabels[value - 1] || '';
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                    }
                };
            }, [moodHistory, isAuthenticated]);

            // NOW WE CAN DO CONDITIONAL RETURNS - ALL HOOKS ARE ABOVE
            // Show loading state while checking auth
            if (authChecking) {
                return React.createElement('div', { 
                    className: 'min-h-screen flex items-center justify-center' 
                }, 
                    React.createElement('div', { className: 'text-center' },
                        React.createElement('div', { className: 'animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4' }),
                        React.createElement('p', { className: 'text-gray-600' }, 'Loading...')
                    )
                );
            }

            if (!isAuthenticated) {
                return null; // Don't render until auth is confirmed
            }

            // Helper functions and constants (after hooks, before render)
            const moods = [
                { emoji: '', label: 'Very Sad', color: 'bg-blue-200', value: 1 },
                { emoji: '', label: 'Sad', color: 'bg-blue-100', value: 2 },
                { emoji: '', label: 'Neutral', color: 'bg-gray-100', value: 3 },
                { emoji: '', label: 'Happy', color: 'bg-green-100', value: 4 },
                { emoji: '', label: 'Very Happy', color: 'bg-green-200', value: 5 }
            ];

            const saveMood = async () => {
                if (selectedMood === null) return;
                
                const user = window.firebaseAuth?.currentUser;
                if (!user || !window.firestore) {
                    alert('Please log in to save moods');
                    return;
                }

                try {
                    const { collection, addDoc, Timestamp } = window.firestore;
                    await addDoc(collection(window.firebaseDb, 'moods'), {
                        userId: user.uid,
                        mood: selectedMood,
                        note: notes || '',
                        date: Timestamp.now()
                    });
                    
                    setSelectedMood(null);
                    setNotes('');
                } catch (error) {
                    console.error('Error saving mood:', error);
                    alert('Failed to save mood: ' + error.message);
                }
            };

            const weeklyAverage = moodHistory.slice(0, 7).reduce((sum, e) => {
                const moodEntry = moods.find(m => m.value === e.mood || moods[e.mood]?.value === e.mood);
                return sum + (moodEntry ? moodEntry.value : e.mood);
            }, 0) / Math.min(7, moodHistory.length) || 0;

            return React.createElement('div', { className: 'min-h-screen p-8' },
                React.createElement('div', { className: 'max-w-6xl mx-auto' },
                    React.createElement('h1', { className: 'text-4xl font-bold mb-8 text-center' }, 'Mood Tracking'),
                    React.createElement('div', { className: 'glass-card p-8 mb-8' },
                        React.createElement('h2', { className: 'text-2xl font-bold mb-6 text-center' }, 'How are you feeling today?'),
                        React.createElement('div', { className: 'grid grid-cols-5 gap-4 mb-6' },
                            moods.map((mood, idx) =>
                                React.createElement('button', {
                                    key: idx,
                                    onClick: () => {
                                        setSelectedMood(idx);
                                        // Check for achievement
                                        if (moodHistory.length === 0) {
                                            AchievementSystem.checkAchievement('mood_tracker_7', window.firebaseAuth?.currentUser?.uid);
                                        }
                                    },
                                    className: `mood-option p-6 rounded-2xl text-5xl transition-all ${selectedMood === idx ? 'selected ' + mood.color : 'bg-gray-50 hover:bg-gray-100'}`,
                                    title: mood.label
                                },
                                    React.createElement('span', {
                                        className: `mood-emoji ${selectedMood === idx ? 'selected' : ''}`
                                    }, mood.emoji)
                                )
                            )
                        ),
                        React.createElement('div', { className: 'mb-6' },
                            React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Notes (optional)'),
                            React.createElement('textarea', {
                                value: notes,
                                onChange: (e) => setNotes(e.target.value),
                                className: 'w-full p-4 border border-gray-300 rounded-lg h-32',
                                placeholder: 'What made you feel this way?'
                            })
                        ),
                        React.createElement('button', {
                            onClick: saveMood,
                            disabled: selectedMood === null,
                            className: `w-full py-4 rounded-lg font-semibold text-white ${selectedMood === null ? 'bg-gray-400' : 'btn-primary'}`
                        }, 'Save Mood')
                    ),
                    moodHistory.length > 0 && React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6 mb-6' },
                        React.createElement('div', { className: 'glass-card p-6' },
                            React.createElement('h3', { className: 'text-xl font-bold mb-4' }, 'Recent Moods'),
                            React.createElement('div', { className: 'space-y-3' },
                                moodHistory.slice(0, 7).map((entry, idx) =>
                                    React.createElement('div', {
                                        key: idx,
                                        className: 'flex items-center justify-between p-3 bg-gray-50 rounded-lg'
                                    },
                                        React.createElement('div', { className: 'flex items-center gap-3' },
                                            React.createElement('span', { className: 'text-2xl' }, moods[entry.mood].emoji),
                                            React.createElement('span', { className: 'font-semibold' }, moods[entry.mood].label)
                                        ),
                                        React.createElement('div', { className: 'text-right' },
                                            React.createElement('p', { className: 'text-sm text-gray-600' },
                                                new Date(entry.date).toLocaleDateString()
                                            )
                                        )
                                    )
                                )
                            )
                        ),
                        React.createElement('div', { className: 'glass-card p-6' },
                            React.createElement('h3', { className: 'text-xl font-bold mb-4' }, 'Weekly Summary'),
                            React.createElement('div', { className: 'space-y-4' },
                                React.createElement('div', null,
                                    React.createElement('p', { className: 'text-sm text-gray-600 mb-2' }, 'Average Mood'),
                                    React.createElement('div', { className: 'flex items-center gap-2' },
                                        React.createElement('div', { className: 'flex-1 h-4 bg-gray-200 rounded-full overflow-hidden' },
                                            React.createElement('div', {
                                                className: 'h-full bg-gradient-to-r from-blue-500 to-green-500',
                                                style: { width: `${(weeklyAverage / 5) * 100}%` }
                                            })
                                        ),
                                        React.createElement('span', { className: 'font-bold' }, weeklyAverage.toFixed(1))
                                    )
                                ),
                                React.createElement('div', null,
                                    React.createElement('p', { className: 'text-sm text-gray-600 mb-2' }, 'Total Entries'),
                                    React.createElement('p', { className: 'text-2xl font-bold' }, moodHistory.length)
                                )
                            )
                        ),
                        moodHistory.length > 0 && React.createElement('div', { className: 'glass-card p-6 col-span-1 md:col-span-2' },
                            React.createElement('h3', { className: 'text-xl font-bold mb-4' }, 'Mood Trends (Last 7 Days)'),
                            React.createElement('div', { className: 'h-64' },
                                React.createElement('canvas', { ref: chartRef })
                            )
                        )
                    )
                )
            );
        }

        function BreathingPage() {
            const [isActive, setIsActive] = useState(false);
            const [technique, setTechnique] = useState('box');
            const [cycle, setCycle] = useState(0);
            const [phase, setPhase] = useState('inhale');

            const techniques = {
                box: { name: 'Box Breathing', pattern: [4, 4, 4, 4], phases: ['Inhale', 'Hold', 'Exhale', 'Hold'] },
                calm: { name: 'Calm Breathing', pattern: [4, 0, 6, 0], phases: ['Inhale', '', 'Exhale', ''] },
                sleep: { name: 'Sleep Wind-Down', pattern: [4, 7, 8, 0], phases: ['Inhale', 'Hold', 'Exhale', ''] }
            };

            useEffect(() => {
                if (!isActive) return;
                const current = techniques[technique];
                let phaseIndex = 0;
                let count = current.pattern[phaseIndex];
                
                const interval = setInterval(() => {
                    if (count > 0) {
                        count--;
                    } else {
                        phaseIndex = (phaseIndex + 1) % current.phases.length;
                        if (phaseIndex === 0) setCycle(c => c + 1);
                        count = current.pattern[phaseIndex];
                    }
                    setPhase(current.phases[phaseIndex] || 'Rest');
                }, 1000);

                return () => clearInterval(interval);
            }, [isActive, technique]);

            return React.createElement('div', { className: 'min-h-screen p-8' },
                React.createElement('div', { className: 'max-w-4xl mx-auto' },
                    React.createElement('h1', { className: 'text-4xl font-bold mb-8 text-center' }, 'Breathing Exercises'),
                    React.createElement('div', { className: 'glass-card p-8 mb-8' },
                        React.createElement('div', { className: 'mb-6' },
                            React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Select Technique'),
                            React.createElement('select', {
                                value: technique,
                                onChange: (e) => {
                                    setTechnique(e.target.value);
                                    setIsActive(false);
                                    setCycle(0);
                                },
                                className: 'w-full p-3 border border-gray-300 rounded-lg',
                                disabled: isActive
                            },
                                Object.entries(techniques).map(([key, tech]) =>
                                    React.createElement('option', { key: key, value: key }, tech.name)
                                )
                            )
                        ),
                        React.createElement('div', { className: 'flex justify-center items-center mb-8' },
                            React.createElement('div', {
                                className: `breathing-circle w-64 h-64 rounded-full flex items-center justify-center text-white text-2xl font-semibold ${isActive ? '' : 'opacity-50'}`,
                                style: {
                                    background: isActive 
                                        ? 'linear-gradient(135deg, #667eea, #764ba2)'
                                        : 'linear-gradient(135deg, #cbd5e1, #94a3b8)'
                                }
                            },
                                React.createElement('div', { className: 'text-center' },
                                    React.createElement('p', { className: 'text-4xl mb-2' }, phase),
                                    React.createElement('p', { className: 'text-lg' }, isActive ? 'Breathe' : 'Ready')
                                )
                            )
                        ),
                        React.createElement('div', { className: 'text-center mb-6' },
                            React.createElement('p', { className: 'text-lg font-semibold' }, `Cycles: ${cycle}`)
                        ),
                        React.createElement('div', { className: 'flex justify-center gap-4' },
                            !isActive ? 
                            React.createElement('button', {
                                    onClick: () => setIsActive(true),
                                    className: 'btn-primary px-8 py-4 text-lg'
                                }, React.createElement('i', { className: 'fas fa-play mr-2' }), 'Start') :
                                React.createElement('button', {
                                    onClick: () => {
                                        setIsActive(false);
                                        setCycle(0);
                                        setPhase('inhale');
                                    },
                                    className: 'btn-secondary px-8 py-4 text-lg'
                                }, React.createElement('i', { className: 'fas fa-stop mr-2' }), 'Stop')
                        )
                    ),
                    React.createElement('div', { className: 'glass-card p-6' },
                        React.createElement('h3', { className: 'text-xl font-bold mb-4' }, 'Benefits'),
                        React.createElement('div', { className: 'grid grid-cols-2 md:grid-cols-3 gap-4' },
                            ['Reduces stress', 'Lowers blood pressure', 'Improves focus', 'Better sleep', 'Increases mindfulness', 'Boosts energy'].map((benefit, idx) =>
                                React.createElement('div', {
                                    key: idx,
                                    className: 'p-4 bg-purple-50 rounded-lg text-center'
                                },
                                    React.createElement('i', { className: 'fas fa-check text-green-600 mb-2' }),
                                    React.createElement('p', { className: 'text-sm font-semibold' }, benefit)
                                )
                            )
                        )
                    )
                )
            );
        }

        function GuidedExercisesPage() {
            const [selectedExercise, setSelectedExercise] = useState(null);
            const [currentStep, setCurrentStep] = useState(0);
            const [timer, setTimer] = useState(0);
            const [isActive, setIsActive] = useState(false);

            const exercises = {
                grounding: {
                    id: 'grounding',
                    name: '5-4-3-2-1 Grounding',
                    icon: 'anchor',
                    description: 'Ground yourself using your five senses',
                    duration: '5 minutes',
                    benefits: 'Helps reduce anxiety, panic, and overwhelming feelings by bringing your attention to the present moment.',
                    steps: [
                        { title: 'Find a comfortable position', instruction: 'Sit or stand comfortably. Take a deep breath in, and slowly exhale.', duration: 30 },
                        { title: '5 Things You Can See', instruction: 'Look around and name 5 things you can see. Notice details like colors, shapes, and textures.', duration: 60 },
                        { title: '4 Things You Can Touch', instruction: 'Name 4 things you can feel. Notice the texture, temperature, and weight of objects around you.', duration: 60 },
                        { title: '3 Things You Can Hear', instruction: 'Listen carefully and identify 3 sounds you can hear. They can be near or far away.', duration: 60 },
                        { title: '2 Things You Can Smell', instruction: 'Take a deep breath and identify 2 things you can smell. If you can\'t smell anything, name 2 smells you like.', duration: 60 },
                        { title: '1 Thing You Can Taste', instruction: 'Notice 1 thing you can taste. It might be the taste in your mouth, or take a sip of water.', duration: 60 },
                        { title: 'Take a moment', instruction: 'Take three deep breaths. Notice how you feel now compared to when you started.', duration: 30 }
                    ]
                },
                progressive: {
                    id: 'progressive',
                    name: 'Progressive Muscle Relaxation',
                    icon: 'spa',
                    description: 'Release tension through muscle relaxation',
                    duration: '10-15 minutes',
                    benefits: 'Reduces physical tension, promotes relaxation, and helps with stress and sleep issues.',
                    steps: [
                        { title: 'Get comfortable', instruction: 'Find a quiet place. Sit or lie down comfortably. Close your eyes and take 3 deep breaths.', duration: 60 },
                        { title: 'Tense your feet', instruction: 'Tense the muscles in your feet by curling your toes. Hold for 5 seconds, then release. Notice the difference.', duration: 15 },
                        { title: 'Tense your legs', instruction: 'Tense your calf and thigh muscles. Hold for 5 seconds, then release completely.', duration: 15 },
                        { title: 'Tense your abdomen', instruction: 'Tighten your stomach muscles. Hold for 5 seconds, then release and breathe deeply.', duration: 15 },
                        { title: 'Tense your hands', instruction: 'Make fists with your hands and tense your arms. Hold for 5 seconds, then release.', duration: 15 },
                        { title: 'Tense your shoulders', instruction: 'Raise your shoulders up toward your ears. Hold for 5 seconds, then let them drop.', duration: 15 },
                        { title: 'Tense your face', instruction: 'Scrunch up your face muscles - forehead, eyes, mouth. Hold for 5 seconds, then relax.', duration: 15 },
                        { title: 'Full body scan', instruction: 'Scan your body from head to toe. Notice any remaining tension and release it. Breathe deeply.', duration: 60 },
                        { title: 'Rest', instruction: 'Stay in this relaxed state for a few moments. When ready, slowly open your eyes.', duration: 30 }
                    ]
                },
                visualization: {
                    id: 'visualization',
                    name: 'Guided Visualization',
                    icon: 'eye',
                    description: 'Calm your mind with peaceful imagery',
                    duration: '10 minutes',
                    benefits: 'Reduces stress, improves mood, and promotes mental clarity through peaceful mental imagery.',
                    steps: [
                        { title: 'Prepare', instruction: 'Find a comfortable position. Close your eyes and take 3 slow, deep breaths.', duration: 60 },
                        { title: 'Imagine a peaceful place', instruction: 'Picture yourself in a beautiful, safe place. It could be a beach, forest, garden, or anywhere that feels peaceful to you.', duration: 90 },
                        { title: 'Notice the details', instruction: 'Look around your peaceful place. What do you see? Notice the colors, shapes, and light around you.', duration: 90 },
                        { title: 'Listen to the sounds', instruction: 'What sounds do you hear? Maybe waves, birds, wind, or silence. Let the sounds soothe you.', duration: 90 },
                        { title: 'Feel the environment', instruction: 'What do you feel? The warmth of the sun, a gentle breeze, soft grass beneath you. Feel completely safe and at peace.', duration: 90 },
                        { title: 'Breathe in the peace', instruction: 'With each breath, imagine breathing in peace and calm. With each exhale, release any tension or worry.', duration: 120 },
                        { title: 'Stay in this place', instruction: 'Spend a few more moments in your peaceful place. Absorb the calm and tranquility.', duration: 120 },
                        { title: 'Return gently', instruction: 'Slowly bring your awareness back. Wiggle your fingers and toes. When ready, open your eyes gently.', duration: 60 }
                    ]
                },
                sleep: {
                    id: 'sleep',
                    name: 'Sleep Meditation',
                    icon: 'moon',
                    description: 'Drift into restful sleep',
                    duration: '15-20 minutes',
                    benefits: 'Promotes deep relaxation, reduces racing thoughts, and helps you fall asleep naturally.',
                    steps: [
                        { title: 'Prepare for sleep', instruction: 'Lie down in bed in a comfortable position. Turn off bright lights. Close your eyes.', duration: 60 },
                        { title: 'Body relaxation', instruction: 'Starting from your toes, consciously relax each part of your body. Feel the tension melting away.', duration: 120 },
                        { title: 'Deep breathing', instruction: 'Breathe in slowly for 4 counts, hold for 4, exhale for 6. Repeat 5 times.', duration: 180 },
                        { title: 'Countdown', instruction: 'Count backwards from 10 to 1. With each number, feel yourself sinking deeper into relaxation.', duration: 60 },
                        { title: 'Peaceful thoughts', instruction: 'Think of one thing you\'re grateful for today. Let positive, gentle thoughts flow through your mind.', duration: 120 },
                        { title: 'Let go', instruction: 'Release any thoughts or worries. Imagine them floating away like clouds. Your mind is calm and quiet.', duration: 180 },
                        { title: 'Drift away', instruction: 'Allow yourself to drift into sleep naturally. There\'s nothing you need to do. Just rest.', duration: 300 }
                    ]
                }
            };

            useEffect(() => {
                let interval = null;
                if (isActive && timer > 0) {
                    interval = setInterval(() => {
                        setTimer(timer - 1);
                    }, 1000);
                } else if (timer === 0 && isActive && selectedExercise) {
                    const exercise = exercises[selectedExercise];
                    if (currentStep < exercise.steps.length - 1) {
                        setCurrentStep(currentStep + 1);
                        setTimer(exercise.steps[currentStep + 1].duration);
                    } else {
                        setIsActive(false);
                    }
                }
                return () => clearInterval(interval);
            }, [isActive, timer, currentStep, selectedExercise]);

            const startExercise = (exerciseId) => {
                setSelectedExercise(exerciseId);
                setCurrentStep(0);
                setTimer(exercises[exerciseId].steps[0].duration);
                setIsActive(true);
            };

            const resetExercise = () => {
                setIsActive(false);
                setCurrentStep(0);
                setTimer(0);
            };

            if (selectedExercise && exercises[selectedExercise]) {
                const exercise = exercises[selectedExercise];
                const step = exercise.steps[currentStep];
                const progress = ((currentStep + 1) / exercise.steps.length) * 100;

                return React.createElement('div', { className: 'min-h-screen p-8' },
                    React.createElement('div', { className: 'max-w-4xl mx-auto' },
                        React.createElement('button', {
                            onClick: () => {
                                resetExercise();
                                setSelectedExercise(null);
                            },
                            className: 'mb-6 text-purple-600 hover:text-purple-800 flex items-center gap-2'
                        },
                            React.createElement('i', { className: 'fas fa-arrow-left' }),
                            'Back to Exercises'
                        ),
                        React.createElement('div', { className: 'glass-card p-8' },
                            React.createElement('div', { className: 'mb-6' },
                                React.createElement('h1', { className: 'text-3xl font-bold mb-2' }, exercise.name),
                                React.createElement('p', { className: 'text-gray-600 mb-4' }, exercise.benefits),
                                React.createElement('div', { className: 'w-full bg-gray-200 rounded-full h-3 mb-4' },
                                    React.createElement('div', {
                                        className: 'bg-purple-600 h-3 rounded-full transition-all duration-300',
                                        style: { width: `${progress}%` }
                                    })
                                ),
                                React.createElement('div', { className: 'flex justify-between text-sm text-gray-600' },
                                    React.createElement('span', null, `Step ${currentStep + 1} of ${exercise.steps.length}`),
                                    React.createElement('span', null, `${Math.round(progress)}% complete`)
                                )
                            ),
                            React.createElement('div', { className: 'text-center mb-8' },
                                React.createElement('h2', { className: 'text-2xl font-bold mb-4' }, step.title),
                                React.createElement('p', { className: 'text-lg text-gray-700 mb-6 leading-relaxed' }, step.instruction),
                                isActive && React.createElement('div', { className: 'mb-6' },
                                    React.createElement('div', { className: 'text-4xl font-bold text-purple-600 mb-2' },
                                        Math.floor(timer / 60) + ':' + String(timer % 60).padStart(2, '0')
                                    ),
                                    React.createElement('p', { className: 'text-sm text-gray-600' }, 'Time remaining for this step')
                                )
                            ),
                            React.createElement('div', { className: 'flex gap-4 justify-center' },
                                !isActive ? React.createElement('button', {
                                    onClick: () => {
                                        if (currentStep === 0) {
                                            startExercise(selectedExercise);
                                        } else {
                                            setIsActive(true);
                                            setTimer(exercise.steps[currentStep].duration);
                                        }
                                    },
                                    className: 'btn-primary px-8 py-3 text-lg'
                                },
                                    React.createElement('i', { className: 'fas fa-play mr-2' }),
                                    currentStep === 0 ? 'Start Exercise' : 'Resume'
                                ) : React.createElement('button', {
                                    onClick: () => setIsActive(false),
                                    className: 'btn-secondary px-8 py-3 text-lg'
                                },
                                    React.createElement('i', { className: 'fas fa-pause mr-2' }),
                                    'Pause'
                                ),
                                React.createElement('button', {
                                    onClick: resetExercise,
                                    className: 'btn-secondary px-8 py-3 text-lg'
                                },
                                    React.createElement('i', { className: 'fas fa-redo mr-2' }),
                                    'Reset'
                                )
                            ),
                            currentStep < exercise.steps.length - 1 && !isActive && React.createElement('button', {
                                onClick: () => {
                                    setCurrentStep(currentStep + 1);
                                    setTimer(exercise.steps[currentStep + 1].duration);
                                },
                                className: 'btn-secondary w-full mt-4'
                            }, 'Skip to Next Step')
                        )
                    )
                );
            }

            return React.createElement('div', { className: 'min-h-screen p-8' },
                React.createElement('div', { className: 'max-w-6xl mx-auto' },
                    React.createElement('h1', { className: 'text-4xl font-bold mb-8 text-center' }, 'Guided Exercises'),
                    React.createElement('p', { className: 'text-center text-gray-600 mb-8 max-w-2xl mx-auto' }, 
                        'Choose an exercise to help you relax, reduce stress, and improve your wellbeing. Each exercise includes step-by-step guidance.'
                    ),
                    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
                        Object.values(exercises).map(exercise =>
                            React.createElement('div', {
                                key: exercise.id,
                                className: 'glass-card p-6 cursor-pointer hover:scale-105 transition-transform'
                            },
                                React.createElement('div', { className: 'flex items-center gap-4 mb-4' },
                                    React.createElement('div', { className: 'w-16 h-16 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white text-2xl' },
                                        React.createElement('i', { className: `fas fa-${exercise.icon}` })
                                    ),
                                    React.createElement('div', null,
                                        React.createElement('h3', { className: 'text-xl font-bold' }, exercise.name),
                                        React.createElement('p', { className: 'text-sm text-gray-500' }, exercise.duration)
                                    )
                                ),
                                React.createElement('p', { className: 'text-gray-600 mb-4' }, exercise.description),
                                React.createElement('p', { className: 'text-sm text-purple-600 mb-4' }, exercise.benefits),
                                React.createElement('button', {
                                    onClick: () => setSelectedExercise(exercise.id),
                                    className: 'btn-primary w-full'
                                }, 'Start Exercise')
                            )
                        )
                    )
                )
            );
        }

        function SoundscapesPage() {
            const [playing, setPlaying] = useState(null);
            const [volume, setVolume] = useState(50);
            const [loop, setLoop] = useState(true);
            const audioRef = useRef(null);

            // Soundscape audio URLs
            // Note: These are placeholder URLs. For production, replace with:
            // 1. Your own hosted audio files (Firebase Storage, CDN, etc.)
            // 2. Free audio from Pixabay, Freesound, or other royalty-free sources
            // 3. Or use Web Audio API to generate sounds programmatically
            const soundscapes = [
                { 
                    id: 'ocean', 
                    name: 'Ocean Waves', 
                    icon: 'water', 
                    color: 'from-blue-400 to-blue-600',
                    // Replace with actual ocean wave audio URL
                    // Example: 'https://your-cdn.com/audio/ocean-waves.mp3'
                    // Or use Firebase Storage: 'https://firebasestorage.googleapis.com/v0/b/bloomly-67dbc.appspot.com/o/sounds%2Focean.mp3?alt=media'
                    url: 'https://www2.cs.uic.edu/~i101/SoundFiles/StarWars60.wav', // Temporary placeholder - replace with ocean sound
                    fallbackUrl: null
                },
                { 
                    id: 'rain', 
                    name: 'Gentle Rain', 
                    icon: 'cloud-rain', 
                    color: 'from-gray-400 to-gray-600',
                    url: 'https://www2.cs.uic.edu/~i101/SoundFiles/StarWars60.wav', // Temporary placeholder - replace with rain sound
                    fallbackUrl: null
                },
                { 
                    id: 'forest', 
                    name: 'Forest Sounds', 
                    icon: 'tree', 
                    color: 'from-green-400 to-green-600',
                    url: 'https://www2.cs.uic.edu/~i101/SoundFiles/StarWars60.wav', // Temporary placeholder - replace with forest sound
                    fallbackUrl: null
                },
                { 
                    id: 'fireplace', 
                    name: 'Fireplace', 
                    icon: 'fire', 
                    color: 'from-orange-400 to-red-600',
                    url: 'https://www2.cs.uic.edu/~i101/SoundFiles/StarWars60.wav', // Temporary placeholder - replace with fireplace sound
                    fallbackUrl: null
                },
                { 
                    id: 'space', 
                    name: 'Deep Space', 
                    icon: 'star', 
                    color: 'from-purple-400 to-indigo-600',
                    url: 'https://www2.cs.uic.edu/~i101/SoundFiles/StarWars60.wav', // Temporary placeholder - replace with space ambient sound
                    fallbackUrl: null
                },
                { 
                    id: 'piano', 
                    name: 'Soft Piano', 
                    icon: 'music', 
                    color: 'from-pink-400 to-purple-600',
                    url: 'https://www2.cs.uic.edu/~i101/SoundFiles/StarWars60.wav', // Temporary placeholder - replace with piano sound
                    fallbackUrl: null
                }
            ];

            // Handle audio playback with fallback
            useEffect(() => {
                if (playing && audioRef.current) {
                    const sound = soundscapes.find(s => s.id === playing);
                    if (sound && sound.url) {
                        const tryPlayAudio = (url) => {
                            if (!audioRef.current.src || audioRef.current.src !== url) {
                                audioRef.current.src = url;
                            }
                            audioRef.current.volume = volume / 100;
                            audioRef.current.loop = loop;
                            audioRef.current.play().catch(err => {
                                console.error('Error playing audio:', err);
                                // Try fallback URL if available
                                if (sound.fallbackUrl && audioRef.current.src !== sound.fallbackUrl) {
                                    console.log('Trying fallback URL...');
                                    tryPlayAudio(sound.fallbackUrl);
                                } else {
                                    alert('Unable to play audio. Please check your browser settings or try a different soundscape.');
                                }
                            });
                        };
                        tryPlayAudio(sound.url);
                    }
                } else if (audioRef.current) {
                    audioRef.current.pause();
                }
            }, [playing, volume, loop]);

            // Update volume when it changes
            useEffect(() => {
                if (audioRef.current) {
                    audioRef.current.volume = volume / 100;
                }
            }, [volume]);

            return React.createElement('div', { className: 'min-h-screen p-8' },
                React.createElement('div', { className: 'max-w-6xl mx-auto' },
                    React.createElement('h1', { className: 'text-4xl font-bold mb-8 text-center' }, 'Ambient Soundscapes'),
                    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8' },
                        soundscapes.map(sound =>
                            React.createElement('div', {
                                key: sound.id,
                                className: `glass-card p-6 cursor-pointer ${playing === sound.id ? 'ring-2 ring-purple-500' : ''}`
                            },
                                React.createElement('div', { className: `w-20 h-20 rounded-full bg-gradient-to-br ${sound.color} flex items-center justify-center text-white text-3xl mb-4 mx-auto` },
                                    React.createElement('i', { className: `fas fa-${sound.icon}` })
                                ),
                                React.createElement('h3', { className: 'text-xl font-bold text-center mb-2' }, sound.name),
                                playing === sound.id && React.createElement('div', { className: 'sound-visualizer mt-4' },
                                    [0, 1, 2, 3, 4].map(i =>
                                        React.createElement('div', {
                                            key: i,
                                            className: 'sound-bar',
                                            style: { animationDelay: `${i * 0.1}s` }
                                        })
                                    )
                                ),
                                React.createElement('button', {
                                    onClick: () => setPlaying(playing === sound.id ? null : sound.id),
                                    className: `w-full mt-4 ${playing === sound.id ? 'btn-secondary' : 'btn-primary'}`
                                },
                                    React.createElement('i', { className: `fas fa-${playing === sound.id ? 'pause' : 'play'} mr-2` }),
                                    playing === sound.id ? 'Pause' : 'Play'
                                )
                            )
                        )
                    ),
                    React.createElement('audio', { 
                        ref: audioRef, 
                        style: { display: 'none' } 
                    }),
                    playing && React.createElement('div', { className: 'glass-card p-6' },
                        React.createElement('div', { className: 'flex items-center gap-4 mb-4' },
                            React.createElement('label', { className: 'flex items-center gap-2' },
                                React.createElement('input', {
                                    type: 'checkbox',
                                    checked: loop,
                                    onChange: (e) => setLoop(e.target.checked)
                                }),
                                React.createElement('span', null, 'Loop')
                            ),
                            React.createElement('div', { className: 'flex-1' },
                                React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, `Volume: ${volume}%`),
                                React.createElement('input', {
                                    type: 'range',
                                    min: '0',
                                    max: '100',
                                    value: volume,
                                    onChange: (e) => setVolume(e.target.value),
                                    className: 'w-full'
                                })
                            )
                        )
                    )
                )
            );
        }

        function ProgressPage() {
            // ALL HOOKS MUST BE DECLARED AT THE TOP - BEFORE ANY CONDITIONAL LOGIC
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [authChecking, setAuthChecking] = useState(true);
            const [moodHistory, setMoodHistory] = useState([]);
            const [journalEntries, setJournalEntries] = useState([]);
            const [rewards, setRewards] = useState(storage.getUserData('rewards', []));
            const moodChartRef = useRef(null);
            const moodChartInstanceRef = useRef(null);
            const journalChartRef = useRef(null);
            const journalChartInstanceRef = useRef(null);

            // Check Firebase authentication - MUST BE BEFORE CONDITIONAL RETURNS
            useEffect(() => {
                let unsubscribe = null;
                
                // Wait for Firebase to be ready
                const checkAuth = () => {
                    if (!window.firebaseAuth || !window.onAuthStateChanged) {
                        // If Firebase not ready yet, wait a bit and try again
                        if (!window.firebaseReady) {
                            setTimeout(checkAuth, 100);
                            return;
                        }
                        console.error('Firebase Auth not initialized');
                        setAuthChecking(false);
                        window.location.href = 'login.html';
                        return;
                    }

                    unsubscribe = window.onAuthStateChanged(window.firebaseAuth, user => {
                        setAuthChecking(false);
                        if (!user) {
                            // No user logged in  redirect to login page
                            window.location.href = 'login.html';
                        } else {
                            setIsAuthenticated(true);
                        }
                    });
                };

                // Check immediately or wait for Firebase ready event
                if (window.firebaseReady) {
                    checkAuth();
                } else {
                    window.addEventListener('firebaseReady', checkAuth, { once: true });
                    // Fallback timeout
                    setTimeout(() => {
                        if (authChecking) checkAuth();
                    }, 2000);
                }

                return () => {
                    if (unsubscribe) unsubscribe();
                };
            }, []);

            // Load moods and journals from Firestore - MUST BE BEFORE CONDITIONAL RETURNS
            useEffect(() => {
                if (!isAuthenticated) return;

                const loadData = () => {
                    const user = window.firebaseAuth?.currentUser;
                    if (!user || !window.firestore) return;

                    try {
                        const { collection, query, where, orderBy, onSnapshot } = window.firestore;

                        // Load moods
                        const moodsRef = collection(window.firebaseDb, 'moods');
                        const moodsQuery = query(moodsRef, where('userId', '==', user.uid), orderBy('date', 'desc'));
                        const unsubscribeMoods = onSnapshot(moodsQuery, (snapshot) => {
                            const moodEntries = [];
                            snapshot.forEach((doc) => {
                                const data = doc.data();
                                moodEntries.push({
                                    id: doc.id,
                                    mood: data.mood,
                                    notes: data.note || '',
                                    date: data.date?.toDate ? data.date.toDate().toISOString() : data.date,
                                    timestamp: data.date?.toDate ? data.date.toDate().getTime() : new Date(data.date).getTime()
                                });
                            });
                            setMoodHistory(moodEntries);
                        }, (error) => {
                            console.error('Error loading moods:', error);
                            // Try without orderBy if index missing
                            if (error.code === 'failed-precondition') {
                                const moodsRef = collection(window.firebaseDb, 'moods');
                                const moodsQuery = query(moodsRef, where('userId', '==', user.uid));
                                onSnapshot(moodsQuery, (snapshot) => {
                                    const moodEntries = [];
                                    snapshot.forEach((doc) => {
                                        const data = doc.data();
                                        moodEntries.push({
                                            id: doc.id,
                                            mood: data.mood,
                                            notes: data.note || '',
                                            date: data.date?.toDate ? data.date.toDate().toISOString() : data.date,
                                            timestamp: data.date?.toDate ? data.date.toDate().getTime() : new Date(data.date).getTime()
                                        });
                                    });
                                    moodEntries.sort((a, b) => b.timestamp - a.timestamp);
                                    setMoodHistory(moodEntries);
                                });
                            }
                        });

                        // Load journals
                        const journalsRef = collection(window.firebaseDb, 'journals');
                        const journalsQuery = query(journalsRef, where('userId', '==', user.uid), orderBy('date', 'desc'));
                        const unsubscribeJournals = onSnapshot(journalsQuery, (snapshot) => {
                            const journalEntriesList = [];
                            snapshot.forEach((doc) => {
                                const data = doc.data();
                                journalEntriesList.push({
                                    id: doc.id,
                                    ...data,
                                    date: data.date?.toDate ? data.date.toDate().toISOString() : data.date,
                                    timestamp: data.date?.toDate ? data.date.toDate().getTime() : new Date(data.date).getTime()
                                });
                            });
                            setJournalEntries(journalEntriesList);
                        }, (error) => {
                            console.error('Error loading journals:', error);
                            // Try without orderBy if index missing
                            if (error.code === 'failed-precondition') {
                                const journalsRef = collection(window.firebaseDb, 'journals');
                                const journalsQuery = query(journalsRef, where('userId', '==', user.uid));
                                onSnapshot(journalsQuery, (snapshot) => {
                                    const journalEntriesList = [];
                                    snapshot.forEach((doc) => {
                                        const data = doc.data();
                                        journalEntriesList.push({
                                            id: doc.id,
                                            ...data,
                                            date: data.date?.toDate ? data.date.toDate().toISOString() : data.date,
                                            timestamp: data.date?.toDate ? data.date.toDate().getTime() : new Date(data.date).getTime()
                                        });
                                    });
                                    journalEntriesList.sort((a, b) => b.timestamp - a.timestamp);
                                    setJournalEntries(journalEntriesList);
                                });
                            }
                        });

                        return () => {
                            unsubscribeMoods();
                            unsubscribeJournals();
                        };
                    } catch (error) {
                        console.error('Error setting up data listeners:', error);
                    }
                };

                if (window.firebaseReady) {
                    return loadData();
                } else {
                    window.addEventListener('firebaseReady', loadData, { once: true });
                }
            }, [isAuthenticated]);

            // Create mood trend chart - MUST BE BEFORE CONDITIONAL RETURNS
            useEffect(() => {
                if (moodHistory.length === 0 || !moodChartRef.current) return;

                const ctx = moodChartRef.current.getContext('2d');
                const last14Days = moodHistory.slice(0, 14).reverse();
                const labels = last14Days.map(e => new Date(e.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                const data = last14Days.map(e => [1, 2, 3, 4, 5][e.mood]);

                if (moodChartInstanceRef.current) {
                    moodChartInstanceRef.current.destroy();
                }

                moodChartInstanceRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Mood Trend',
                            data: data,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { min: 1, max: 5, ticks: { stepSize: 1 } }
                        }
                    }
                });

                return () => {
                    if (moodChartInstanceRef.current) {
                        moodChartInstanceRef.current.destroy();
                    }
                };
            }, [moodHistory]);

            // Create journal entries chart
            useEffect(() => {
                if (journalEntries.length === 0 || !journalChartRef.current) return;

                const ctx = journalChartRef.current.getContext('2d');
                const last30Days = [];
                const today = new Date();
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    const count = journalEntries.filter(e => e.date.startsWith(dateStr)).length;
                    last30Days.push({ date: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }), count });
                }

                if (journalChartInstanceRef.current) {
                    journalChartInstanceRef.current.destroy();
                }

                journalChartInstanceRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: last30Days.map(d => d.date),
                        datasets: [{
                            label: 'Journal Entries',
                            data: last30Days.map(d => d.count),
                            backgroundColor: 'rgba(118, 75, 162, 0.6)',
                            borderColor: 'rgb(118, 75, 162)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });

                return () => {
                    if (journalChartInstanceRef.current) {
                        journalChartInstanceRef.current.destroy();
                    }
                };
            }, [journalEntries]);

            // Helper functions (needed by useEffect below) - defined after hooks but before useEffect that uses them
            const calculateStreak = () => {
                if (moodHistory.length === 0) return 0;
                let streak = 1;
                const sorted = [...moodHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
                for (let i = 1; i < sorted.length; i++) {
                    const daysDiff = Math.floor((new Date(sorted[i-1].date) - new Date(sorted[i].date)) / (1000 * 60 * 60 * 24));
                    if (daysDiff === 1) streak++;
                    else break;
                }
                return streak;
            };

            const weeklyAverage = moodHistory.slice(0, 7).reduce((sum, e) => sum + [1, 2, 3, 4, 5][e.mood], 0) / Math.min(7, moodHistory.length) || 0;

            // Rewards calculation useEffect - uses helper functions above
            useEffect(() => {
                const newRewards = [];
                if (calculateStreak() >= 7 && !rewards.find(r => r.id === 'streak-7')) {
                    newRewards.push({ id: 'streak-7', name: '7 Day Streak!', icon: '', date: new Date().toISOString() });
                }
                if (journalEntries.length >= 10 && !rewards.find(r => r.id === 'journal-10')) {
                    newRewards.push({ id: 'journal-10', name: '10 Journal Entries', icon: '', date: new Date().toISOString() });
                }
                if (weeklyAverage >= 4 && !rewards.find(r => r.id === 'mood-4')) {
                    newRewards.push({ id: 'mood-4', name: 'Positive Week!', icon: '', date: new Date().toISOString() });
                }
                if (newRewards.length > 0) {
                    setRewards([...rewards, ...newRewards]);
                    storage.setUserData('rewards', [...rewards, ...newRewards]);
                }
            }, [moodHistory.length, journalEntries.length, rewards]);

            // NOW WE CAN DO CONDITIONAL RETURNS - ALL HOOKS ARE ABOVE
            // Show loading state while checking auth
            if (authChecking) {
                return React.createElement('div', { 
                    className: 'min-h-screen flex items-center justify-center' 
                }, 
                    React.createElement('div', { className: 'text-center' },
                        React.createElement('div', { className: 'animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4' }),
                        React.createElement('p', { className: 'text-gray-600' }, 'Loading...')
                    )
                );
            }

            if (!isAuthenticated) {
                return null; // Don't render until auth is confirmed
            }

            // Main render (helper functions already defined above)
            return React.createElement('div', { className: 'min-h-screen p-8' },
                React.createElement('div', { className: 'max-w-6xl mx-auto' },
                    React.createElement('h1', { className: 'text-4xl font-bold mb-8 text-center' }, 'Your Progress'),
                    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-6 mb-8' },
                        React.createElement('div', { className: 'glass-card p-6 text-center' },
                            React.createElement('div', { className: 'text-4xl mb-2' }, ''),
                            React.createElement('p', { className: 'text-2xl font-bold' }, calculateStreak()),
                            React.createElement('p', { className: 'text-gray-600' }, 'Day Streak')
                        ),
                        React.createElement('div', { className: 'glass-card p-6 text-center' },
                            React.createElement('div', { className: 'text-4xl mb-2' }, ''),
                            React.createElement('p', { className: 'text-2xl font-bold' }, weeklyAverage.toFixed(1)),
                            React.createElement('p', { className: 'text-gray-600' }, 'Weekly Mood Avg')
                        ),
                        React.createElement('div', { className: 'glass-card p-6 text-center' },
                            React.createElement('div', { className: 'text-4xl mb-2' }, ''),
                            React.createElement('p', { className: 'text-2xl font-bold' }, journalEntries.length),
                            React.createElement('p', { className: 'text-gray-600' }, 'Journal Entries')
                        )
                    ),
                    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6 mb-8' },
                        moodHistory.length > 0 && React.createElement('div', { className: 'glass-card p-6' },
                            React.createElement('h3', { className: 'text-xl font-bold mb-4' }, 'Mood Trends (Last 14 Days)'),
                            React.createElement('div', { className: 'h-64' },
                                React.createElement('canvas', { ref: moodChartRef })
                            )
                        ),
                        journalEntries.length > 0 && React.createElement('div', { className: 'glass-card p-6' },
                            React.createElement('h3', { className: 'text-xl font-bold mb-4' }, 'Journal Activity (Last 30 Days)'),
                            React.createElement('div', { className: 'h-64' },
                                React.createElement('canvas', { ref: journalChartRef })
                            )
                        )
                    ),
                    React.createElement('div', { className: 'glass-card p-6' },
                        React.createElement('h2', { className: 'text-2xl font-bold mb-4' }, 'Your Achievements & Badges'),
                        (() => {
                            const user = window.firebaseAuth?.currentUser;
                            const earnedBadges = user ? AchievementSystem.getEarnedBadges(user.uid) : [];
                            return earnedBadges.length === 0 ? 
                                React.createElement('p', { className: 'text-gray-600 text-center py-8' }, 'Keep going! Your first achievement is just around the corner.') :
                                React.createElement('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4' },
                                    earnedBadges.map(badge =>
                                        React.createElement('div', {
                                            key: badge.id,
                                            className: 'p-6 bg-gradient-to-br from-purple-100 to-pink-100 rounded-lg text-center border-2 border-purple-300',
                                            title: badge.description
                                        },
                                            React.createElement('div', { className: 'text-4xl mb-2' }, badge.icon),
                                            React.createElement('p', { className: 'font-bold' }, badge.name),
                                            React.createElement('p', { className: 'text-xs text-gray-600 mt-1' }, badge.description)
                                        )
                                    )
                                );
                        })()
                    )
                )
            );
        }

        function ArticlesPage({ onNavigate }) {
            // ALL HOOKS MUST BE DECLARED AT THE TOP - BEFORE ANY CONDITIONAL LOGIC
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            const [authChecking, setAuthChecking] = useState(true);
            const [articles, setArticles] = useState([]);
            const [showPublishForm, setShowPublishForm] = useState(false);
            const [newArticle, setNewArticle] = useState({ title: '', content: '', excerpt: '' });
            const [loading, setLoading] = useState(true);

            // Check Firebase authentication - MUST BE BEFORE CONDITIONAL RETURNS
            useEffect(() => {
                let unsubscribe = null;
                
                const checkAuth = () => {
                    if (!window.firebaseAuth || !window.onAuthStateChanged) {
                        if (!window.firebaseReady) {
                            setTimeout(checkAuth, 100);
                            return;
                        }
                        console.error('Firebase Auth not initialized');
                        setAuthChecking(false);
                        window.location.href = 'login.html';
                        return;
                    }

                    unsubscribe = window.onAuthStateChanged(window.firebaseAuth, user => {
                        setAuthChecking(false);
                        if (!user) {
                            window.location.href = 'login.html';
                        } else {
                            setIsAuthenticated(true);
                            // Check if user is admin (you can store this in Firestore user document)
                            // For now, using local auth check as fallback
                            setIsAdmin(auth.isAdmin());
                        }
                    });
                };

                if (window.firebaseReady) {
                    checkAuth();
                } else {
                    window.addEventListener('firebaseReady', checkAuth, { once: true });
                    setTimeout(() => {
                        if (authChecking) checkAuth();
                    }, 2000);
                }

                return () => {
                    if (unsubscribe) unsubscribe();
                };
            }, []);

            // Load articles from Firestore - MUST BE BEFORE CONDITIONAL RETURNS
            useEffect(() => {
                if (!isAuthenticated) {
                    setLoading(false);
                    return;
                }

                let timeoutId = null;
                let unsubscribe = null;

                const loadArticles = () => {
                    if (!window.firestore) {
                        setLoading(false);
                        return;
                    }

                    // Set timeout fallback (5 seconds max wait)
                    timeoutId = setTimeout(() => {
                        console.warn('Articles loading timeout - setting loading to false');
                        setLoading(false);
                    }, 5000);

                    try {
                        const { collection, query, orderBy, onSnapshot } = window.firestore;
                        const articlesRef = collection(window.firebaseDb, 'articles');
                        const q = query(articlesRef, orderBy('date', 'desc'));

                        // Real-time listener
                        unsubscribe = onSnapshot(q, (snapshot) => {
                            if (timeoutId) {
                                clearTimeout(timeoutId);
                                timeoutId = null;
                            }
                            
                            const articleList = [];
                            snapshot.forEach((doc) => {
                                const data = doc.data();
                                articleList.push({
                                    id: doc.id,
                                    title: data.title,
                                    excerpt: data.excerpt || data.content?.substring(0, 150) + '...',
                                    content: data.content,
                                    author: data.author || 'Admin',
                                    date: data.date?.toDate ? data.date.toDate().toISOString() : data.date,
                                    likes: data.likes || 0,
                                    views: data.views || 0,
                                    comments: data.comments || []
                                });
                            });
                            setArticles(articleList);
                            setLoading(false);
                        }, (error) => {
                            console.error('Error loading articles:', error);
                            if (timeoutId) {
                                clearTimeout(timeoutId);
                                timeoutId = null;
                            }
                            setLoading(false);
                            
                            // Try without orderBy if index missing
                            if (error.code === 'failed-precondition') {
                                try {
                                    const articlesRef = collection(window.firebaseDb, 'articles');
                                    const q2 = query(articlesRef);
                                    onSnapshot(q2, (snapshot) => {
                                        const articleList = [];
                                        snapshot.forEach((doc) => {
                                            const data = doc.data();
                                            articleList.push({
                                                id: doc.id,
                                                title: data.title,
                                                excerpt: data.excerpt || data.content?.substring(0, 150) + '...',
                                                content: data.content,
                                                author: data.author || 'Admin',
                                                date: data.date?.toDate ? data.date.toDate().toISOString() : data.date,
                                                likes: data.likes || 0,
                                                views: data.views || 0,
                                                comments: data.comments || []
                                            });
                                        });
                                        // Sort by date manually
                                        articleList.sort((a, b) => {
                                            const dateA = new Date(a.date).getTime();
                                            const dateB = new Date(b.date).getTime();
                                            return dateB - dateA;
                                        });
                                        setArticles(articleList);
                                        setLoading(false);
                                    });
                                } catch (fallbackError) {
                                    console.error('Fallback query also failed:', fallbackError);
                                    setLoading(false);
                                }
                            }
                        });

                        return () => {
                            if (unsubscribe) unsubscribe();
                            if (timeoutId) clearTimeout(timeoutId);
                        };
                    } catch (error) {
                        console.error('Error setting up articles listener:', error);
                        if (timeoutId) {
                            clearTimeout(timeoutId);
                            timeoutId = null;
                        }
                        setLoading(false);
                    }
                };

                // Wait for Firebase to be ready
                if (window.firebaseReady) {
                    return loadArticles();
                } else {
                    window.addEventListener('firebaseReady', loadArticles, { once: true });
                    // Fallback timeout
                    setTimeout(() => {
                        if (loading) {
                            setLoading(false);
                        }
                    }, 6000);
                }

                return () => {
                    if (timeoutId) clearTimeout(timeoutId);
                    if (unsubscribe) unsubscribe();
                };
            }, [isAuthenticated]);

            // Seed sample articles if collection is empty (runs once for any authenticated user)
            useEffect(() => {
                const seedSampleArticles = async () => {
                    if (!isAuthenticated || !window.firestore || articles.length > 0) return;
                    
                    // Check if articles already exist
                    try {
                        const { collection, getDocs } = window.firestore;
                        const articlesRef = collection(window.firebaseDb, 'articles');
                        const snapshot = await getDocs(articlesRef);
                        if (!snapshot.empty) {
                            // Articles already exist, don't seed
                            return;
                        }
                    } catch (error) {
                        console.error('Error checking articles:', error);
                        return;
                    }
                    
                    const sampleArticles = [
                        {
                            title: 'Understanding Your Emotions: A Beginner\'s Guide',
                            excerpt: 'Learn the basics of emotional awareness and how to identify what you\'re feeling.',
                            content: 'Emotions are complex responses to our experiences. They can be pleasant, like joy and excitement, or challenging, like sadness and anxiety. Understanding your emotions is the first step toward emotional wellness.\n\nEmotional awareness involves recognizing what you\'re feeling, understanding why you might be feeling that way, and knowing how to respond appropriately. This skill takes practice, but it\'s essential for mental wellbeing.\n\nStart by checking in with yourself throughout the day. Ask yourself: "What am I feeling right now?" and "What might have triggered this emotion?" Journaling can be a helpful tool for developing this awareness.',
                            author: 'Bloomly Team',
                            date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000),
                            likes: 12,
                            views: 45,
                            comments: []
                        },
                        {
                            title: '5 Breathing Techniques for Instant Calm',
                            excerpt: 'Simple breathing exercises you can do anywhere to reduce stress and anxiety.',
                            content: 'Breathing exercises are one of the most accessible tools for managing stress and anxiety. Here are five techniques you can try:\n\n1. **Box Breathing**: Inhale for 4 counts, hold for 4, exhale for 4, hold for 4. Repeat.\n2. **4-7-8 Breathing**: Inhale for 4, hold for 7, exhale for 8.\n3. **Diaphragmatic Breathing**: Breathe deeply into your belly, expanding your diaphragm.\n4. **Alternate Nostril Breathing**: Close one nostril, breathe in, switch, breathe out.\n5. **Progressive Muscle Relaxation**: Combine breathing with tensing and releasing muscle groups.\n\nPractice these regularly to build your stress-management toolkit.',
                            author: 'Bloomly Team',
                            date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000),
                            likes: 28,
                            views: 89,
                            comments: []
                        },
                        {
                            title: 'The Power of Journaling for Mental Health',
                            excerpt: 'Discover how writing can help you process emotions and gain clarity.',
                            content: 'Journaling is a powerful tool for mental health. It provides a safe space to express your thoughts and feelings without judgment.\n\nBenefits of journaling include:\n- **Emotional Processing**: Writing helps you understand and process complex emotions\n- **Stress Reduction**: Getting thoughts out of your head can reduce anxiety\n- **Problem Solving**: Writing about challenges can help you see solutions\n- **Self-Awareness**: Regular journaling increases understanding of yourself\n- **Memory and Reflection**: Track your growth over time\n\nYou don\'t need to be a writer to journal. Just write whatever comes to mind. There\'s no right or wrong way to do it. Start with just 5-10 minutes a day.',
                            author: 'Bloomly Team',
                            date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000),
                            likes: 19,
                            views: 67,
                            comments: []
                        },
                        {
                            title: 'Building Resilience: Bouncing Back from Difficult Times',
                            excerpt: 'Learn strategies to develop emotional resilience and navigate life\'s challenges.',
                            content: 'Resilience is the ability to adapt and bounce back from adversity. It\'s not about avoiding difficulties, but about developing the skills to navigate them effectively.\n\nKey strategies for building resilience:\n\n1. **Maintain Connections**: Strong relationships provide support during tough times\n2. **Practice Self-Care**: Regular exercise, sleep, and nutrition support mental health\n3. **Set Realistic Goals**: Break large challenges into manageable steps\n4. **Accept Change**: Flexibility helps you adapt to new circumstances\n5. **Learn from Experience**: Reflect on past challenges and what helped you overcome them\n6. **Maintain Perspective**: Remember that difficult times are temporary\n7. **Take Action**: Focus on what you can control\n\nBuilding resilience is a process, not a destination. Be patient with yourself as you develop these skills.',
                            author: 'Bloomly Team',
                            date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000),
                            likes: 15,
                            views: 52,
                            comments: []
                        }
                    ];

                    try {
                        const { collection, addDoc, Timestamp } = window.firestore;
                        for (const article of sampleArticles) {
                            await addDoc(collection(window.firebaseDb, 'articles'), {
                                ...article,
                                date: Timestamp.fromDate(article.date)
                            });
                        }
                        console.log('Sample articles seeded successfully');
                    } catch (error) {
                        console.error('Error seeding sample articles:', error);
                    }
                };

                if (window.firebaseReady && isAuthenticated) {
                    seedSampleArticles();
                } else if (isAuthenticated) {
                    window.addEventListener('firebaseReady', seedSampleArticles, { once: true });
                }
            }, [isAuthenticated, articles.length]);

            const likeArticle = async (id) => {
                if (!window.firestore) return;
                
                try {
                    const { doc, updateDoc, getDoc } = window.firestore;
                    const articleRef = doc(window.firebaseDb, 'articles', id);
                    const articleSnap = await getDoc(articleRef);
                    if (articleSnap.exists()) {
                        const currentLikes = articleSnap.data().likes || 0;
                        await updateDoc(articleRef, { likes: currentLikes + 1 });
                    }
                } catch (error) {
                    console.error('Error liking article:', error);
                }
            };

            const publishArticle = async () => {
                if (!isAdmin) {
                    alert('Admin access required to publish articles');
                    return;
                }
                if (!newArticle.title || !newArticle.content) {
                    alert('Please fill in title and content');
                    return;
                }
                
                const user = window.firebaseAuth?.currentUser;
                if (!user || !window.firestore) {
                    alert('Please log in to publish articles');
                    return;
                }

                try {
                    const { collection, addDoc, Timestamp } = window.firestore;
                    await addDoc(collection(window.firebaseDb, 'articles'), {
                        title: newArticle.title,
                        content: newArticle.content,
                        excerpt: newArticle.excerpt || newArticle.content.substring(0, 150) + '...',
                        author: user.email || 'Admin',
                        date: Timestamp.now(),
                        likes: 0,
                        views: 0,
                        comments: []
                    });
                    
                    setNewArticle({ title: '', content: '', excerpt: '' });
                    setShowPublishForm(false);
                } catch (error) {
                    console.error('Error publishing article:', error);
                    alert('Failed to publish article: ' + error.message);
                }
            };

            const deleteArticle = async (id) => {
                if (!isAdmin) {
                    alert('Admin access required to delete articles');
                    return;
                }
                if (!confirm('Are you sure you want to delete this article?')) {
                    return;
                }
                
                if (!window.firestore) return;

                try {
                    const { doc, deleteDoc } = window.firestore;
                    await deleteDoc(doc(window.firebaseDb, 'articles', id));
                } catch (error) {
                    console.error('Error deleting article:', error);
                    alert('Failed to delete article: ' + error.message);
                }
            };



            const [articleSearchQuery, setArticleSearchQuery] = useState('');
            // NOW WE CAN DO CONDITIONAL RETURNS - ALL HOOKS ARE ABOVE
            // Show loading state while checking auth
            if (authChecking) {
                return React.createElement('div', { 
                    className: 'min-h-screen flex items-center justify-center' 
                }, 
                    React.createElement('div', { className: 'text-center' },
                        React.createElement('div', { className: 'animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4' }),
                        React.createElement('p', { className: 'text-gray-600' }, 'Loading...')
                    )
                );
            }

            if (!isAuthenticated) {
                return null; // Don't render until auth is confirmed
            }

            // Show loading state for data
            if (loading) {
                return React.createElement('div', { className: 'min-h-screen p-8 flex items-center justify-center' },
                    React.createElement('div', { className: 'text-center' },
                        React.createElement('div', { className: 'animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mx-auto mb-4' }),
                        React.createElement('p', { className: 'text-gray-600' }, 'Loading articles...')
                    )
                );
            }

            // Helper functions (after hooks, before render)
            const filteredArticles = articles.filter(article =>
                !articleSearchQuery ||
                article.title.toLowerCase().includes(articleSearchQuery.toLowerCase()) ||
                article.excerpt.toLowerCase().includes(articleSearchQuery.toLowerCase()) ||
                article.content.toLowerCase().includes(articleSearchQuery.toLowerCase())
            );

            return React.createElement('div', { className: 'min-h-screen p-8', style: { background: 'linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%)' } },
                React.createElement('div', { className: 'max-w-6xl mx-auto' },
                    React.createElement('div', { className: 'mb-8' },
                        React.createElement('div', { className: 'flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6' },
                            React.createElement('h1', { className: 'bloomly-h1' }, 'Wellness Articles'),
                            isAdmin && React.createElement('button', {
                                onClick: () => setShowPublishForm(!showPublishForm),
                                className: 'bloomly-btn bloomly-btn-primary'
                            }, 
                                React.createElement('i', { className: 'fas fa-plus' }),
                                showPublishForm ? 'Cancel' : 'Publish Article'
                            )
                        ),
                        React.createElement(UniversalSearchBar, {
                            placeholder: 'Search articles...',
                            value: articleSearchQuery,
                            onChange: setArticleSearchQuery
                        })
                    ),

                    showPublishForm && isAdmin && React.createElement('div', { className: 'glass-card p-6 mb-8' },
                        React.createElement('h2', { className: 'text-2xl font-bold mb-4' }, 'Publish New Article'),
                        React.createElement('div', { className: 'space-y-4' },
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Title'),
                                React.createElement('input', {
                                    type: 'text',
                                    value: newArticle.title,
                                    onChange: (e) => setNewArticle({ ...newArticle, title: e.target.value }),
                                    className: 'w-full p-3 border border-gray-300 rounded-lg',
                                    placeholder: 'Article title'
                                })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Excerpt (optional)'),
                                React.createElement('input', {
                                    type: 'text',
                                    value: newArticle.excerpt,
                                    onChange: (e) => setNewArticle({ ...newArticle, excerpt: e.target.value }),
                                    className: 'w-full p-3 border border-gray-300 rounded-lg',
                                    placeholder: 'Short description'
                                })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Content'),
                                React.createElement('textarea', {
                                    value: newArticle.content,
                                    onChange: (e) => setNewArticle({ ...newArticle, content: e.target.value }),
                                    className: 'w-full p-3 border border-gray-300 rounded-lg h-48',
                                    placeholder: 'Article content...'
                                })
                            ),
                            React.createElement('button', {
                                onClick: publishArticle,
                                className: 'btn-primary'
                            }, React.createElement('i', { className: 'fas fa-paper-plane mr-2' }), 'Publish')
                        )
                    ),

                    articles.length === 0 && !loading && React.createElement('div', { className: 'text-center py-12' },
                        React.createElement('p', { className: 'text-gray-600 text-lg' }, 'No articles yet. Check back soon!')
                    ),
                    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' },
                        articles.map(article =>
                React.createElement('div', {
                                key: article.id,
                                className: 'article-card glass-card p-6'
                            },
                                React.createElement('div', {
                                    onClick: () => {
                                        onNavigate('article-detail', article.id, article);
                                    },
                                    className: 'cursor-pointer'
                                },
                                    React.createElement('h3', { className: 'text-xl font-bold mb-2' }, article.title),
                                    React.createElement('p', { className: 'text-gray-600 mb-4' }, article.excerpt || article.content?.substring(0, 150) + '...'),
                                    React.createElement('div', { className: 'flex items-center gap-4 text-sm text-gray-500' },
                                        React.createElement('span', null, React.createElement('i', { className: 'fas fa-heart mr-1' }), article.likes || 0),
                                        React.createElement('span', null, React.createElement('i', { className: 'fas fa-comment mr-1' }), (article.comments || []).length),
                                        article.author && React.createElement('span', null, React.createElement('i', { className: 'fas fa-user mr-1' }), article.author)
                                    )
                                ),
                                isAdmin && React.createElement('button', {
                                    onClick: () => deleteArticle(article.id),
                                    className: 'mt-4 text-red-600 hover:text-red-800 text-sm'
                                }, React.createElement('i', { className: 'fas fa-trash mr-2' }), 'Delete')
                            )
                        )
                    )
                )
            );
        }

        // ========== HABIT TRACKING PAGE ==========
        function HabitTrackingPage() {
            const [habits, setHabits] = useState(HabitTracker.habits);
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);

            const toggleHabit = (habitId) => {
                const date = new Date(selectedDate);
                if (HabitTracker.isCompletedToday(habitId)) {
                    // Remove log (simplified - in real app, you'd need a remove function)
                    Celebration.show('Habit logged! Keep it up! ');
                } else {
                    if (HabitTracker.logHabit(habitId, date)) {
                        Celebration.show('Habit logged! Keep it up! ');
                        setHabits([...habits]); // Trigger re-render
                    }
                }
            };

            return React.createElement('div', { className: 'min-h-screen p-8' },
                React.createElement('div', { className: 'max-w-6xl mx-auto' },
                    React.createElement('h1', { className: 'text-4xl font-bold mb-8 text-center' }, 'Habit Tracker'),
                    React.createElement('div', { className: 'glass-card p-6 mb-6' },
                        React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Select Date'),
                        React.createElement('input', {
                            type: 'date',
                            value: selectedDate,
                            onChange: (e) => setSelectedDate(e.target.value),
                            className: 'w-full p-3 border border-gray-300 rounded-lg'
                        })
                    ),
                    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' },
                        habits.map(habit => {
                            const streak = HabitTracker.getStreak(habit.id);
                            const completed = HabitTracker.isCompletedToday(habit.id);
                            return React.createElement('div', {
                                key: habit.id,
                                className: `glass-card p-6 cursor-pointer ${completed ? 'ring-2 ring-green-500' : ''}`
                            },
                                React.createElement('div', { className: 'flex items-center justify-between mb-4' },
                                    React.createElement('div', { className: 'text-4xl' }, habit.icon),
                                    React.createElement('button', {
                                        onClick: () => toggleHabit(habit.id),
                                        className: `w-8 h-8 rounded-full border-2 flex items-center justify-center ${completed ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300'}`,
                                        title: completed ? 'Completed' : 'Mark as complete'
                                    }, completed ? React.createElement('i', { className: 'fas fa-check text-sm' }) : '')
                                ),
                                React.createElement('h3', { className: 'text-xl font-bold mb-2' }, habit.name),
                                React.createElement('div', { className: 'flex items-center gap-2 text-sm text-gray-600' },
                                    React.createElement('span', null, ''),
                                    React.createElement('span', { className: 'font-semibold' }, `${streak} day streak`)
                                )
                            );
                        })
                    )
                )
            );
        }

        // ========== SLEEP TRACKING PAGE ==========
        function SleepTrackingPage() {
            const [hours, setHours] = useState(8);
            const [quality, setQuality] = useState(3);
            const [sleepHistory, setSleepHistory] = useState([]);
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);

            useEffect(() => {
                setSleepHistory(SleepTracker.getSleepHistory(7));
            }, []);

            const saveSleep = () => {
                const date = new Date(selectedDate);
                if (SleepTracker.logSleep(hours, quality, date)) {
                    Celebration.show('Sleep logged! ');
                    setSleepHistory(SleepTracker.getSleepHistory(7));
                }
            };

            const avgSleep = SleepTracker.getAverageSleep(7);

            return React.createElement('div', { className: 'min-h-screen p-8' },
                React.createElement('div', { className: 'max-w-6xl mx-auto' },
                    React.createElement('h1', { className: 'text-4xl font-bold mb-8 text-center' }, 'Sleep Tracker'),
                    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6 mb-8' },
                        React.createElement('div', { className: 'glass-card p-6' },
                            React.createElement('h2', { className: 'text-2xl font-bold mb-6' }, 'Log Sleep'),
                            React.createElement('div', { className: 'mb-4' },
                                React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Date'),
                                React.createElement('input', {
                                    type: 'date',
                                    value: selectedDate,
                                    onChange: (e) => setSelectedDate(e.target.value),
                                    className: 'w-full p-3 border border-gray-300 rounded-lg'
                                })
                            ),
                            React.createElement('div', { className: 'mb-4' },
                                React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, `Hours: ${hours}`),
                                React.createElement('input', {
                                    type: 'range',
                                    min: '4',
                                    max: '12',
                                    value: hours,
                                    onChange: (e) => setHours(e.target.value),
                                    className: 'w-full'
                                })
                            ),
                            React.createElement('div', { className: 'mb-6' },
                                React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Quality'),
                                React.createElement('div', { className: 'flex gap-2' },
                                    [1, 2, 3, 4, 5].map(q =>
                                        React.createElement('button', {
                                            key: q,
                                            onClick: () => setQuality(q),
                                            className: `w-12 h-12 rounded-lg ${quality === q ? 'bg-purple-500 text-white' : 'bg-gray-100'}`,
                                            title: ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'][q - 1]
                                        }, q)
                                    )
                                )
                            ),
                            React.createElement('button', {
                                onClick: saveSleep,
                                className: 'btn-primary w-full'
                            }, 'Save Sleep Log')
                        ),
                        React.createElement('div', { className: 'glass-card p-6' },
                            React.createElement('h2', { className: 'text-2xl font-bold mb-4' }, 'Statistics'),
                            React.createElement('div', { className: 'space-y-4' },
                                React.createElement('div', null,
                                    React.createElement('p', { className: 'text-sm text-gray-600 mb-1' }, '7-Day Average'),
                                    React.createElement('p', { className: 'text-3xl font-bold text-purple-600' }, `${avgSleep} hours`)
                                ),
                                React.createElement('div', null,
                                    React.createElement('p', { className: 'text-sm text-gray-600 mb-2' }, 'Recent Sleep Logs'),
                                    React.createElement('div', { className: 'space-y-2' },
                                        sleepHistory.slice(-5).reverse().map((entry, idx) =>
                                            entry.hours ? React.createElement('div', {
                                                key: idx,
                                                className: 'flex justify-between items-center p-2 bg-gray-50 rounded'
                                            },
                                                React.createElement('span', null, new Date(entry.date).toLocaleDateString()),
                                                React.createElement('span', { className: 'font-semibold' }, `${entry.hours}h - Quality: ${entry.quality}/5`)
                                            ) : null
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            );
        }

        // ========== GOAL SETTING PAGE ==========
        function GoalSettingPage() {
            const [goals, setGoals] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [newGoal, setNewGoal] = useState({ title: '', description: '', targetDate: '', category: 'wellness' });

            useEffect(() => {
                setGoals(GoalSystem.getGoals(false));
            }, []);

            const createGoal = () => {
                if (!newGoal.title.trim() || !newGoal.targetDate) {
                    alert('Please fill in all required fields');
                    return;
                }
                const goal = GoalSystem.createGoal(
                    newGoal.title,
                    newGoal.description,
                    newGoal.targetDate,
                    newGoal.category
                );
                if (goal) {
                    setGoals(GoalSystem.getGoals(false));
                    setNewGoal({ title: '', description: '', targetDate: '', category: 'wellness' });
                    setShowForm(false);
                    Celebration.show('Goal created! ');
                }
            };

            const completeGoal = (goalId) => {
                if (GoalSystem.completeGoal(goalId)) {
                    setGoals(GoalSystem.getGoals(false));
                    Celebration.show('Goal achieved! ');
                }
            };

            return React.createElement('div', { className: 'min-h-screen p-8' },
                React.createElement('div', { className: 'max-w-6xl mx-auto' },
                    React.createElement('div', { className: 'flex justify-between items-center mb-8' },
                        React.createElement('h1', { className: 'text-4xl font-bold' }, 'Goals'),
                        React.createElement('button', {
                            onClick: () => setShowForm(!showForm),
                            className: 'btn-primary'
                        }, showForm ? 'Cancel' : React.createElement(React.Fragment, null,
                            React.createElement('i', { className: 'fas fa-plus mr-2' }),
                            'New Goal'
                        ))
                    ),
                    showForm && React.createElement('div', { className: 'glass-card p-6 mb-6' },
                        React.createElement('h2', { className: 'text-2xl font-bold mb-4' }, 'Create New Goal'),
                        React.createElement('div', { className: 'space-y-4' },
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Goal Title *'),
                                React.createElement('input', {
                                    type: 'text',
                                    value: newGoal.title,
                                    onChange: (e) => setNewGoal({ ...newGoal, title: e.target.value }),
                                    className: 'w-full p-3 border border-gray-300 rounded-lg',
                                    placeholder: 'e.g., Meditate daily for 30 days'
                                })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Description'),
                                React.createElement('textarea', {
                                    value: newGoal.description,
                                    onChange: (e) => setNewGoal({ ...newGoal, description: e.target.value }),
                                    className: 'w-full p-3 border border-gray-300 rounded-lg',
                                    rows: 3,
                                    placeholder: 'Why is this goal important to you?'
                                })
                            ),
                            React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
                                React.createElement('div', null,
                                    React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Target Date *'),
                                    React.createElement('input', {
                                        type: 'date',
                                        value: newGoal.targetDate,
                                        onChange: (e) => setNewGoal({ ...newGoal, targetDate: e.target.value }),
                                        className: 'w-full p-3 border border-gray-300 rounded-lg'
                                    })
                                ),
                                React.createElement('div', null,
                                    React.createElement('label', { className: 'block text-sm font-semibold mb-2' }, 'Category'),
                                    React.createElement('select', {
                                        value: newGoal.category,
                                        onChange: (e) => setNewGoal({ ...newGoal, category: e.target.value }),
                                        className: 'w-full p-3 border border-gray-300 rounded-lg'
                                    },
                                        React.createElement('option', { value: 'wellness' }, 'Wellness'),
                                        React.createElement('option', { value: 'mental-health' }, 'Mental Health'),
                                        React.createElement('option', { value: 'habits' }, 'Habits'),
                                        React.createElement('option', { value: 'personal' }, 'Personal')
                                    )
                                )
                            ),
                            React.createElement('button', {
                                onClick: createGoal,
                                className: 'btn-primary w-full'
                            }, 'Create Goal')
                        )
                    ),
                    goals.length === 0 && !showForm ? React.createElement('div', { className: 'text-center py-12' },
                        React.createElement('div', { className: 'text-6xl mb-4' }, ''),
                        React.createElement('p', { className: 'text-gray-600 text-lg' }, 'No goals yet. Create your first goal to get started!')
                    ) : React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
                        goals.map(goal =>
                            React.createElement('div', {
                                key: goal.id,
                                className: 'glass-card p-6'
                            },
                                React.createElement('div', { className: 'flex justify-between items-start mb-4' },
                                    React.createElement('div', { className: 'flex-1' },
                                        React.createElement('h3', { className: 'text-xl font-bold mb-2' }, goal.title),
                                        goal.description && React.createElement('p', { className: 'text-gray-600 mb-2' }, goal.description),
                                        React.createElement('div', { className: 'flex items-center gap-4 text-sm text-gray-500' },
                                            React.createElement('span', null, React.createElement('i', { className: 'fas fa-calendar mr-1' }), new Date(goal.targetDate).toLocaleDateString()),
                                            React.createElement('span', { className: 'px-2 py-1 bg-purple-100 text-purple-700 rounded' }, goal.category)
                                        )
                                    )
                                ),
                                React.createElement('div', { className: 'flex gap-3' },
                                    React.createElement('button', {
                                        onClick: () => completeGoal(goal.id),
                                        className: 'btn-primary flex-1'
                                    }, React.createElement('i', { className: 'fas fa-check mr-2' }), 'Mark Complete'),
                                    React.createElement('button', {
                                        className: 'btn-secondary px-4'
                                    }, React.createElement('i', { className: 'fas fa-edit' }))
                                )
                            )
                        )
                    )
                )
            );
        }

        // ========== DAILY CHECK-IN MODAL ==========
        function DailyCheckInModal({ isOpen, onClose, type }) {
            const [responses, setResponses] = useState({});
            const [saving, setSaving] = useState(false);
            const questions = type === 'morning' ? DailyCheckIn.getMorningQuestions() : DailyCheckIn.getNightQuestions();

            const handleSave = async () => {
                setSaving(true);
                const saved = await DailyCheckIn.saveCheckIn(type, responses);
                if (saved) {
                    Celebration.show(type === 'morning' ? 'Morning check-in saved! ' : 'Night check-in saved! ');
                    if (type === 'morning') {
                        DailyCheckIn.markMorningCheckedIn();
                    } else {
                        DailyCheckIn.markNightCheckedIn();
                    }
                    onClose();
                }
                setSaving(false);
            };

            const handleSkip = () => {
                if (type === 'morning') {
                    DailyCheckIn.markMorningCheckedIn();
                } else {
                    DailyCheckIn.markNightCheckedIn();
                }
                onClose();
            };

            if (!isOpen) return null;

            return React.createElement('div', {
                className: 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center p-4',
                onClick: (e) => {
                    if (e.target === e.currentTarget) handleSkip();
                }
            },
                React.createElement('div', {
                    className: 'glass-card max-w-2xl w-full max-h-[90vh] overflow-y-auto p-8',
                    onClick: (e) => e.stopPropagation()
                },
                    React.createElement('div', { className: 'flex justify-between items-center mb-6' },
                        React.createElement('div', null,
                            React.createElement('h2', { className: 'text-3xl font-bold mb-2' },
                                type === 'morning' ? ' Good Morning!' : ' Good Evening!'
                            ),
                            React.createElement('p', { className: 'text-gray-600' },
                                type === 'morning' 
                                    ? 'Let\'s start your day with a quick check-in'
                                    : 'Let\'s reflect on your day'
                            )
                        ),
                        React.createElement('button', {
                            onClick: handleSkip,
                            className: 'text-gray-400 hover:text-gray-600 text-2xl',
                            'aria-label': 'Close'
                        }, '')
                    ),
                    React.createElement('div', { className: 'space-y-6 mb-6' },
                        questions.map((question, idx) =>
                            React.createElement('div', { key: question.id },
                                React.createElement('label', {
                                    className: 'block text-lg font-semibold mb-2 text-gray-800'
                                }, question.label),
                                React.createElement('textarea', {
                                    value: responses[question.id] || '',
                                    onChange: (e) => setResponses({ ...responses, [question.id]: e.target.value }),
                                    placeholder: question.placeholder,
                                    className: 'w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500',
                                    rows: 3
                                })
                            )
                        )
                    ),
                    React.createElement('div', { className: 'flex gap-4' },
                        React.createElement('button', {
                            onClick: handleSave,
                            disabled: saving,
                            className: `btn-primary flex-1 ${saving ? 'opacity-50 cursor-not-allowed' : ''}`
                        },
                            saving ? React.createElement(React.Fragment, null,
                                React.createElement('i', { className: 'fas fa-spinner fa-spin mr-2' }),
                                'Saving...'
                            ) : React.createElement(React.Fragment, null,
                                React.createElement('i', { className: 'fas fa-check mr-2' }),
                                'Save Check-In'
                            )
                        ),
                        React.createElement('button', {
                            onClick: handleSkip,
                            className: 'btn-secondary px-6'
                        }, 'Skip for Today')
                    )
                )
            );
        }

        // ========== CRISIS RESOURCES COMPONENT ==========
        function CrisisResourcesComponent() {
            const [isOpen, setIsOpen] = useState(false);
            const [crisisDetected, setCrisisDetected] = useState(false);

            useEffect(() => {
                // Listen for crisis keywords in chat messages
                const checkForCrisis = () => {
                    const chatMessages = document.querySelectorAll('.chat-message');
                    chatMessages.forEach(msg => {
                        const text = msg.textContent || msg.innerText;
                        if (CrisisResources.detectCrisisKeywords(text)) {
                            setCrisisDetected(true);
                            setIsOpen(true);
                        }
                    });
                };

                // Check periodically and on new messages
                const interval = setInterval(checkForCrisis, 2000);
                const observer = new MutationObserver(checkForCrisis);
                observer.observe(document.body, { childList: true, subtree: true });

                return () => {
                    clearInterval(interval);
                    observer.disconnect();
                };
            }, []);

            return React.createElement(React.Fragment, null,
                React.createElement('button', {
                    onClick: () => setIsOpen(!isOpen),
                    className: 'crisis-button',
                    'aria-label': 'Crisis Resources',
                    title: 'Crisis Resources'
                }, React.createElement('i', { className: 'fas fa-life-ring' })),
                
                React.createElement('div', {
                    className: `crisis-panel ${isOpen ? '' : 'hidden'}`,
                    role: 'dialog',
                    'aria-label': 'Crisis Resources'
                },
                    React.createElement('div', { className: 'flex justify-between items-center mb-4' },
                        React.createElement('h3', { className: 'text-xl font-bold' }, 'Crisis Resources'),
                        React.createElement('button', {
                            onClick: () => setIsOpen(false),
                            className: 'text-white text-xl hover:opacity-80',
                            'aria-label': 'Close'
                        }, '')
                    ),
                    React.createElement('p', { className: 'mb-4 text-sm opacity-90' }, 
                        'If you\'re in immediate danger, please call 911. For mental health support:'
                    ),
                    React.createElement('div', { className: 'space-y-3' },
                        CrisisResources.resources.map((resource, idx) =>
                            React.createElement('div', {
                                key: idx,
                                className: 'bg-white bg-opacity-20 rounded-lg p-3'
                            },
                                React.createElement('div', { className: 'font-semibold mb-1' }, resource.name),
                                resource.phone && React.createElement('a', {
                                    href: `tel:${resource.phone}`,
                                    className: 'block text-white hover:underline mb-1'
                                }, ` ${resource.phone}`),
                                resource.text && React.createElement('div', { className: 'text-sm' }, resource.text),
                                React.createElement('div', { className: 'text-xs opacity-75 mt-1' }, resource.available)
                            )
                        )
                    ),
                    React.createElement('div', { className: 'mt-4 pt-4 border-t border-white border-opacity-30' },
                        React.createElement('p', { className: 'text-xs opacity-75' }, 
                            'Remember: You are not alone. Help is available 24/7.'
                        )
                    )
                )
            );
        }

        function SafeSpaceRoom({ isOpen, theme, onClose, onThemeChange }) {
            const [breathingActive, setBreathingActive] = useState(false);
            const [soundscape, setSoundscape] = useState(null);

            if (!isOpen) return null;

            return React.createElement('div', {
                className: `safe-space ${theme} fixed inset-0 z-[2000] flex flex-col items-center justify-center`
            },
                    React.createElement('button', {
                    onClick: onClose,
                    className: 'absolute top-4 right-4 text-white text-2xl z-10 w-10 h-10 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 flex items-center justify-center'
                }, ''),
                
                React.createElement('div', { className: 'absolute top-4 left-4 flex gap-2 flex-wrap' },
                    ['starlit', 'forest', 'ocean', 'lavender', 'clouds'].map(t =>
                        React.createElement('button', {
                            key: t,
                            onClick: () => onThemeChange(t),
                            className: `px-4 py-2 rounded-lg text-white ${theme === t ? 'bg-white bg-opacity-30' : 'bg-white bg-opacity-10 hover:bg-opacity-20'}`,
                        }, t.charAt(0).toUpperCase() + t.slice(1))
                    )
                ),

                React.createElement('div', { className: 'text-center text-white z-10' },
                    React.createElement('h1', { className: 'text-5xl font-bold mb-4' }, 'Safe Space Room'),
                    React.createElement('p', { className: 'text-xl mb-8 opacity-90' }, 'Your peaceful sanctuary'),
                    
                    React.createElement('div', { className: 'flex gap-4 justify-center mb-8 flex-wrap' },
                        React.createElement('button', {
                            onClick: () => setBreathingActive(!breathingActive),
                            className: 'px-6 py-3 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 backdrop-blur-sm'
                        },
                            React.createElement('i', { className: 'fas fa-wind mr-2' }),
                            breathingActive ? 'Stop Breathing' : 'Start Breathing Guide'
                        ),
                        React.createElement('button', {
                            onClick: () => setSoundscape(soundscape ? null : 'ocean'),
                            className: 'px-6 py-3 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 backdrop-blur-sm'
                        },
                            React.createElement('i', { className: 'fas fa-music mr-2' }),
                            soundscape ? 'Stop Sound' : 'Play Soundscape'
                        )
                    ),

                    breathingActive && React.createElement('div', { className: 'mt-8' },
                        React.createElement('div', {
                            className: 'breathing-circle w-48 h-48 mx-auto rounded-full bg-white bg-opacity-20 flex items-center justify-center backdrop-blur-sm'
                        },
                            React.createElement('p', { className: 'text-2xl font-semibold' }, 'Breathe')
                        )
                    )
                ),

                [0, 1, 2, 3, 4].map(i =>
                    React.createElement('div', {
                        key: i,
                        className: 'butterfly-particle absolute',
                        style: {
                            left: `${20 + i * 15}%`,
                            top: `${30 + (i % 2) * 40}%`,
                            animationDelay: `${i * 2}s`,
                            animationDuration: `${10 + i * 3}s`
                        }
                    })
                )
            );
        }

        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>
</html>