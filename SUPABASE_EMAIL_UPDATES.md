## Supabase email updates for new blog posts

This guide adds email notifications to existing newsletter subscribers when a new
blog post is published.

---

### 1) Database schema (SQL)

Run this in the Supabase SQL editor. The `subscribers` table already exists and
is referenced by the Edge Function.

```sql
-- Posts table
create table if not exists posts (
  id bigint generated by default as identity primary key,
  title text not null,
  slug text not null unique,
  summary text,
  url text not null,
  created_at timestamptz not null default now()
);

-- Email logs table
create table if not exists email_logs (
  id bigint generated by default as identity primary key,
  post_id bigint not null references posts(id) on delete cascade,
  email text not null,
  status text not null,
  timestamp timestamptz not null default now()
);

-- Optional helpful indexes
create index if not exists email_logs_post_id_idx on email_logs (post_id);
create index if not exists email_logs_email_idx on email_logs (email);
```

#### Recommended RLS (safe defaults)

The Edge Function uses the Supabase service role key, which bypasses RLS.
These policies keep public access minimal.

```sql
alter table posts enable row level security;
alter table email_logs enable row level security;

-- Optional: allow public read of posts
create policy "posts_read" on posts for select using (true);

-- No public insert/update policies are needed for posts/email_logs
```

---

### 2) Edge Function environment variables

Set these in your Supabase project (Functions -> Secrets):

```
SUPABASE_URL=https://YOUR_PROJECT.supabase.co
SUPABASE_SERVICE_ROLE_KEY=YOUR_SERVICE_ROLE_KEY
RESEND_API_KEY=YOUR_RESEND_API_KEY
RESEND_FROM_EMAIL=Your Name <noreply@yourdomain.com>
ADMIN_PUBLISH_KEY=YOUR_ADMIN_PUBLISH_KEY
```

Notes:
- `ADMIN_PUBLISH_KEY` protects the notify function. The admin form sends it in
  the `X-Admin-Key` header.
- You can change the email provider in the Edge Function if desired.

---

### 3) Deploy the Edge Function

From the repo root:

```
supabase functions deploy notify-subscribers
supabase functions deploy subscribe-newsletter
supabase functions deploy publish-post
```

`publish-post` is used by the admin panel to sync new posts into Supabase when
you save a blog post.

If you have not linked the project yet:

```
supabase login
supabase link --project-ref YOUR_PROJECT_REF
```

---

### 4) Test email delivery

1. Add at least one email in `subscribers`.
2. Open `/admin/index.html`, log in, and submit the "Email subscribers" form.
3. Check `email_logs` in Supabase to confirm status.

---

### 5) Optional: Database webhook (auto trigger)

If you want emails to send whenever a row is inserted into `posts`, configure a
Supabase Database Webhook:

- Table: `posts`
- Event: `INSERT`
- URL: `https://YOUR_PROJECT.supabase.co/functions/v1/notify-subscribers`
- Headers: `X-Admin-Key: YOUR_ADMIN_PUBLISH_KEY`

This triggers the Edge Function automatically on insert.

